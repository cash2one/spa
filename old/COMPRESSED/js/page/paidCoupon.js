!function(t,a){var n,o=$.param("actId"),i=$.param("techCode"),s=$.localStorage("paid-coupon-param"),p=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode,c=!1;"true"==$.param("backPublic")&&$("#title>div:nth-of-type(2)").Click(function(e){e.stopImmediatePropagation(),history.back()}),$.ajax({url:($.$.clubID?"../":"")+"redpacket/data",data:{actId:o,userCode:"",techCode:i,chanel:$.param("chanel"),phoneNum:""},success:function(t){function i(){clearTimeout(l),l=0,v=0,y=200}function d(){return h<0&&1==f.Text()||h>0&&999==f.Text()?void i():(v++,y=y>10?y-=5:y,f.Text(parseInt(f.Text())+h),m.Text((C*parseInt(f.Text())).toFixed(2)),void(l=setTimeout(d,y)))}function u(){c||(c=!0,g.Class("disabled"),g.Text("购买中..."),$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/paid_coupon",type:"post",data:{actId:o,businessType:"paid_coupon",businessChannel:$.param("chanel"),clubId:t.clubId,money:t.actValue*parseInt(f.Text()),count:parseInt(f.Text()),openId:$.$.payOpenId,techId:t.techs.id,tradeChannel:"wx",token:$.$.userToken,sessionType:$.$.sessionType},success:function(e){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appId,timeStamp:e.timeStamp+"",nonceStr:e.nonceStr,"package":e["package"],signType:e.signType,paySign:e.paySign},function(t){if(c=!1,g.ClassClear("disabled"),t.err_msg.indexOf("ok")>=0){$.tipShow("支付成功！"),g.Text("购买成功");var a=$.$.easemob;if(a.userId&&!a.conn.isOpened())var n=setInterval(function(){a.conn.isOpened()&&(clearInterval(n),r(e.bizId))},10);else r(e.bizId)}else g.Text("立即购买"),$.tipShow("未能成功支付！")})}200==e.statusCode?(e=JSON.parse(e.respData),n=e["package"].split("=")[1],"undefined"==typeof WeixinJSBridge?a.addEventListener?a.addEventListener("WeixinJSBridgeReady",t,!1):a.attachEvent&&(a.attachEvent("WeixinJSBridgeReady",t),a.attachEvent("onWeixinJSBridgeReady",t)):t()):"935801"==e.statusCode?($.localStorage("paid-coupon-param",!0),$.getOauthCode("","9358","paid-coupon","base")):(c=!1,g.ClassClear("disabled"),g.Text("立即购买"),$.tipShow(e.msg||"购买点钟券请求失败！"))},error:function(){c=!1,g.ClassClear("disabled"),g.Text("立即购买")}}))}function r(e){function a(){$.updateSessionList(p,"text",!1),$.addToMsgList(p,"text"),$.page("paidCouponDetail&userActId="+e)}var n=$.$.userHeader,i=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,s=$.$.easemob,p={from:s.userId,to:t.techs.emchatId,data:"您购买了"+t.techs.name+'的"'+t.actTitle+'"',ext:{name:t.techs.name,header:t.techs.avatarUrl,avatar:"",no:t.techs.serialNo,techId:t.techs.id,clubId:t.clubId,msgType:"paidCouponTip"}},c=setTimeout(function(){p.status=0,a()},5e3);s.conn.isOpened()&&s.conn.send({to:t.techs.emchatId,msg:t.actTitle+"&"+o,type:"chat",ext:{name:i,header:n,msgType:"paidCouponTip",time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(t.techs.emchatId,"business_process"),clearTimeout(c),p.status=1,a()}})}if(200==t.statusCode){t=t.respData,$("#content>div:nth-of-type(2)>span").Text(t.clubName),$("#content>div:nth-of-type(2)>div:nth-of-type(1)").CSS("background-image","url("+(t.imageUrl||$.$.defaultClubLogo)+")"),$("#content>div:nth-of-type(2)").Click(function(){$.$.clubID?$.page("home",-1,!0):location.href=location.href.split("spa2")[0]+"spa2/?club="+t.clubId}),$("#content>div:nth-of-type(3)>div:nth-of-type(1)>div:nth-of-type(1)").CSS("background-image","url("+(t.techs.avatarUrl||$.$.defaultHeader)+")"),$("#content>div:nth-of-type(3)>div:nth-of-type(1)>div:nth-of-type(2)").Html(t.techs.name+"<span>[<span>"+(t.techs.serialNo||"")+"</span>]</span>"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)").Text(t.actTitle),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(2)").Text(t.actValue+"元抵"+t.consumeMoney+"元"),$("#content>div:nth-of-type(3)>div:nth-of-type(3)>span").Text(t.couponPeriod),$("#content>div:nth-of-type(4)>div:nth-of-type(2)").Html(t.actContent),$("#content>div:nth-of-type(3)>div:nth-of-type(1)>div:nth-of-type(1)").Click(function(){location.hash.indexOf("/paidCoupon")>0&&/^chat&techId/.test(location.hash.split("/paidCoupon")[0].slice(-30))?history.back():$.page("chat&techId="+t.techs.id+("9358"==$.$.visitChannel?"&clubId="+t.clubId:""))});var l=0,h=0,f=$("#payCount>span:nth-of-type(2)"),y=200,v=0,m=$("#payCount>div>span"),C=t.actValue;m.Text(C.toFixed(2)),$("#payCount>span:nth-of-type(1),#payCount>span:nth-of-type(3)").Event("touchstart",function(e,t){e.preventDefault(),i(),h="plus"==t.dataset.type?1:-1,d()}).Event("touchmove",function(e,t){}).Event("touchend",function(e,t){e.preventDefault(),i()}).Event("touchcancel",function(){e.preventDefault(),i()});var g=$("#payBtn>div");"downline_can_use"==t.status&&g.Class("downline").Text("已下线"),$("#payBtn").Click(function(){if(!g.ClassHave("downline")){if(!$.$.ua.isWX)return void($.checkAccessMenu("paidCoupon")&&$.tipShow("请您打开微信登录'9358'公众号！"));if($.$.userToken){if(!$.$.userTel)return $.$.loginUrl=location.hash,$.bindPhone(!0),!0;u()}else $.tipShow("请您先登录！"),$.$.loginUrl="paidCoupon"+location.hash.split("paidCoupon")[1],$.page("login")}}),s&&p?($.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:p,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"confirm-order"},success:function(e){200==e.statusCode?($("#payBtn")[0].click(),$.localStorageClear("paid-coupon-param")):"935801"==e.statusCode?$.getOauthCode("","9358","paid-coupon","base"):$.tipShow(e.msg||"获取openId失败！")}}),$.pageSwitch()):$.pageSwitch()}else $.tipShow(t.msg||"获取点钟券数据失败！"),$.page("home",-1,!0)}})}(window,document);