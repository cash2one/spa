!function(){function e(){var e=!1,n=!1;$.ajax({url:"../api/v2/club/paid_service_item/view",isReplaceUrl:!0,data:{id:t},success:function(o){function a(){function e(){if(y[9]>0)y=[y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7],y[8],y[9]-1],i([9]);else if(y[8]>0)y=[y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7],y[8]-1,9],i([8,9]);else if(""==y.join("").replace(/0/g,""))return p&&c?($("#content>div>div:nth-of-type(3)>div:nth-of-type(2)").Text("已结束："),$("#confirmBtn").Class("disabled")):a(),!0;setTimeout(e,10)}function t(){var e=[];if(y[7]>0)y=[y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7]-1,9,9],e=e.concat([7]);else if(y[6]>0)y=[y[0],y[1],y[2],y[3],y[4],y[5],y[6]-1,9,9,9],e=e.concat([6,7]);else if(y[5]>0)y=[y[0],y[1],y[2],y[3],y[4],y[5]-1,5,9,9,9],e=e.concat([5,6,7]);else if(y[4]>0)y=[y[0],y[1],y[2],y[3],y[4]-1,9,5,9,9,9],e=e.concat([4,5,6,7]);else if(y[3]>0)y=[y[0],y[1],y[2],y[3]-1,5,9,5,9,9,9],e=e.concat([3,4,5,6,7]);else if(y[2]>0)y=[y[0],y[1],y[2]-1,9,5,9,5,9,9,9],e=e.concat([2,3,4,5,6,7]);else if(y[1]>0)y=[y[0],y[1]-1,2,4,5,9,5,9,9,9],e=e.concat([1,2,3,4,5,6,7]);else if(y[0]>0)y=[y[0]-1,9,2,4,5,9,5,9,9,9],e=e.concat([0,1,2,3,4,5,6,7]);else if(""==y.join("").replace(/0/g,""))return p&&c?($("#content>div>div:nth-of-type(3)>div:nth-of-type(2)").Text("已结束："),$("#confirmBtn").Class("disabled")):a(),!0;i(e),setTimeout(t,1e3)}function i(e){e.forEach(function(e){g.Index(e).Children().Index(0).Text(y[e]),m.Index(e).Class("toggle")})}var o,d,l,f,h,v,u,y,C=(Math.round,Math.floor),x=+new Date,m=$("#content>div>div:nth-of-type(3)>span"),g=$("#content>div>div:nth-of-type(3)>span>div"),T=!1;if(s>x)o=s-x,$("#content>div>div:nth-of-type(3)>div:nth-of-type(2)").Text("距开始还剩：");else{if(!(r>x))return p=!0,c=!0,$("#content>div>div:nth-of-type(3)>div:nth-of-type(2)").Text("已结束："),void $("#confirmBtn").Class("disabled");o=r-x,$("#content>div>div:nth-of-type(3)>div:nth-of-type(2)").Text("距结束还剩："),p=!0,n&&$("#confirmBtn").ClassClear("disabled")}d=o/1e3,d>0&&(l=C(o%1e3/10),f=C(d%60),h=C(d/60%60),v=C(d/3600%24),u=C(d/3600/24),y=[C(u/10),u%10,C(v/10),v%10,C(h/10),h%10,C(f/10),f%10,C(l/10),C(o%10)],g.Index(0).Children().Text(y[0]),g.Index(1).Children().Text(y[1]),g.Index(2).Children().Text(y[2]),g.Index(3).Children().Text(y[3]),g.Index(4).Children().Text(y[4]),g.Index(5).Children().Text(y[5]),g.Index(6).Children().Text(y[6]),g.Index(7).Children().Text(y[7]),g.Index(8).Children().Text(y[8]),g.Index(9).Children().Text(y[9]),0!=u||T||(T=!0,$(".rob-day").Class("hide"),$(".rob-milli").ClassClear("hide"),setTimeout(e,10)),setTimeout(t,o%1e3),m.Event(function(){var e,t=document.createElement("tmpelement"),n={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd",MsTransition:"msTransitionEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}(),function(e,t){var n=$(t),i=n.Children().Index(0).Children();i.Index(1).Text(i.Index(0).Text()),n.ClassClear("toggle"),0!=y[0]||0!=y[1]||T||(T=!0,$(".rob-day").Class("hide"),$(".rob-milli").ClassClear("hide"))}))}function d(){return $.$.userToken?!!$.$.userTel||($.$.loginUrl=location.hash,$.bindPhone(!0),!1):($.tipShow("请您先登录！"),$.$.loginUrl=location.hash,$.page("login"),!1)}if(200==o.statusCode){o=o.respData,$("#content>div>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)").Text(o.name),(0==o.canPaidCount||o.canPaidCount-o.paidCount>0)&&(n=!0),$("#content>div>div:nth-of-type(2)>div:nth-of-type(3)>div:nth-of-type(2)").Html(o.canPaidCount>0?"剩余<span>"+(o.canPaidCount-o.paidCount)+"</span>份":"<span>不限份数</span>"),$("#content>div>div:nth-of-type(2)>div:nth-of-type(2)>span:nth-of-type(1)").Text(o.amount),$("#content>div>div:nth-of-type(2)>div:nth-of-type(3)>div:nth-of-type(1)>span>span").Text(o.price),o.credits<=0&&$("#content>div>div:nth-of-type(2)>div:nth-of-type(2)>span:nth-of-type(2),#content>div>div:nth-of-type(2)>div:nth-of-type(2)>span:nth-of-type(3)").Class("hide"),$("#content>div>div:nth-of-type(2)>div:nth-of-type(2)>span:nth-of-type(3)>span").Text(o.credits),$.ajax({url:"../api/v2/user/switches",isReplaceUrl:!0,data:{clubId:$.$.clubID},success:function(t){200==t.statusCode&&(t=t.respData,"on"==t.credit.clubSwitch&&"on"==t.credit.systemSwitch&&o.credits>0&&($("#confirmBtn>div:nth-of-type(1)").ClassClear("hide"),e=!0))}});var s=+new Date(o.startDate.replace(/-/g,"/")),r=+new Date(o.endDate.replace(/-/g,"/")),p=!1,c=!1;a(),$("#content>div>div:nth-of-type(4)>div:nth-of-type(1)").CSS("background-image","url("+$.$.clubLogo+")"),$("#content>div>div:nth-of-type(4)>div:nth-of-type(2)").Text($.$.clubName),$("#projectExplain>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(2)").Text(o.startDate+" - "+o.endDate),$("#projectExplain>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)>div>span").Text(o.useStartDate.split(" ")[0]+" - "+o.useEndDate.split(" ")[0]),$("#projectExplain>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)").Html(o.instructions),$("#itemExplain>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(1)").CSS("background-image","url("+o.imageUrl+")"),$("#itemExplain>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(1)").Text(o.name),$("#itemExplain>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(2)>span:nth-of-type(1)").Text(o.price+"元/"+o.duration+o.durationUnit),$("#itemExplain>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(2)>span:nth-of-type(2)").Text(o.pricePlus?o.pricePlus+"元/"+o.durationPlus+o.durationUnit:""),$("#itemExplain>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(1)").Html(o.description||"无"),$("#content>div>div:nth-of-type(4)").Click(function(){$.page("home",-1,!0)}),$.$.ua.isWX&&$.X5Config({title:$.$.clubName+"-"+o.name+"限时抢购就等你来",desc:"据说这个项目一般人抢不到，但是我觉得你可以！抢项目，约技师，享人间极乐。",link:o.shareUrl||location.href,imgUrl:o.imageUrl,success:function(){$("#_shareMask",!0).ClassClear("active")},cancel:function(){},fail:function(e){$.tipShow("分享失败！请稍后再试！")}});var l=$("#confirmBtn"),f=$("#confirmBtn>div");f.Index(0).Click(function(){if(d()){if(!p)return $.tipShow("活动未开始");if(c)return $.tipShow("活动已结束");if(e){if(l.ClassHave("disabled"))return;if(l.ClassHave("processing"))return $.tipShow("购买中，请稍候...");l.Class("processing"),f.Index(0).Class("loading").Text("购买中..."),$.ajax({url:"../api/v2/club/credits/paid/service_item",isReplaceUrl:!0,data:{id:t,techCode:$.$.techInviteCode||$.param("techCode")||"",userCode:$.$.userCode||$.param("userCode")||""},success:function(e){l.ClassClear("processing"),f.Index(0).ClassClear("loading").Text("积分购买"),200==e.statusCode?($.tipShow("支付成功！"),$.page("robProjectSuccess&id="+e.respData)):$.tipShow(e.msg||"积分支付失败")}})}else $.tipShow("未开通积分购买")}}),f.Index(1).Click(function(){if(d()){if(!p)return $.tipShow("活动未开始");if(c)return $.tipShow("活动已结束");if(!$.$.ua.isWX)return void($.checkAccessMenu("robProjectDetail")&&$.tipShow("请在微信中打开"));if(!l.ClassHave("disabled")){if(l.ClassHave("processing"))return $.tipShow("购买中，请稍候...");l.Class("processing"),f.Index(1).Class("loading").Text("购买中..."),$.ajax({url:"../api/v2/wx/pay/paid_service_item",isReplaceUrl:!0,type:"post",data:{paidServiceItemId:t,clubId:o.clubId,tradeChannel:"wx",businessChannel:$.getUrlParam("channel")||"link"},success:function(e){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appId,timeStamp:e.timeStamp+"",nonceStr:e.nonceStr,"package":e["package"],signType:e.signType,paySign:e.paySign},function(t){l.ClassClear("processing"),t.err_msg.indexOf("ok")>=0?($.tipShow("支付成功！"),$.page("robProjectSuccess&id="+e.bizId)):(f.Index(1).ClassClear("loading").Text("现金购买"),$.tipShow("未能成功支付！"),$.ajax({url:"../api/v2/club/user_paid_service_item/delete/paid",isReplaceUrl:!0,data:{id:e.bizId},success:function(){}}))})}200==e.statusCode?(e=JSON.parse(e.respData),"undefined"==typeof WeixinJSBridge?doc.addEventListener?doc.addEventListener("WeixinJSBridgeReady",t,!1):doc.attachEvent&&(doc.attachEvent("WeixinJSBridgeReady",t),doc.attachEvent("onWeixinJSBridgeReady",t)):t()):"935801"==e.statusCode?($.localStorage("con-rob-project-param",!0),$.getOauthCode("","9358","confirm-rob-project","base")):($.tipShow(e.msg||"抢项目失败！"),l.ClassClear("processing"),f.Index(1).ClassClear("loading").Text("现金购买"))},error:function(){$.tipShow("error"),l.ClassClear("processing"),f.Index(1).ClassClear("loading").Text("现金购买")}})}}}),i&&l[0].click()}else $.tipShow(o.msg||"查询抢项目详情失败")}})}var t=$.param("robProjectId")||$.getUrlParam("robProjectId")||"",n=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode,i=$.sessionStorage("con-rob-project-param");return $.$.payAuthCode=n,t?(i&&n?$.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:$.$.payAuthCode,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"confirm-order"},success:function(t){if(200==t.statusCode)e();else{if("935801"!=t.statusCode)return $.tipShow(t.msg||"获取openId失败！"),$.pageCancel();$.getOauthCode("","9358","confirm-rob-project","base")}}}):e(),void $.pageSwitch()):($.tipShow("缺少活动ID"),$.pageCancel())}();