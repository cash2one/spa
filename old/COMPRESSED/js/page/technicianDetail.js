!function(){function e(){function e(){$.ajax({url:"../api/v2/club/"+t+"/coupons",isReplaceUrl:!0,data:{clubId:t},success:function(e){function o(e,i){function o(){$.updateSessionList(s,"text",!1),$.addToMsgList(s,"text"),$.page("paidCouponDetail&userActId="+e)}var a=$.$.userHeader,d=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,c=$.$.easemob,s={from:c.userId,to:n.emchatId,data:"您购买了"+n.name+'的"'+i.actTitle+'"',ext:{name:n.name,header:n.avatarUrl,avatar:"",no:n.serialNo,techId:n.id,clubId:t,msgType:"paidCouponTip"}},l=setTimeout(function(){s.status=0,o()},5e3);c.conn.isOpened()&&c.conn.send({to:n.emchatId,msg:i.actTitle+"&"+actId,type:"chat",ext:{name:d,header:a,msgType:"paidCouponTip",time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(n.emchatId,"business_process"),clearTimeout(l),s.status=1,o()}})}if(200==e.statusCode){var a=$("#couponList"),d=[],c=[];e=e.respData.coupons||[],e.sort(function(e,t){return e.useType>=t.useType?t.consumeMoney-t.actValue-(e.consumeMoney-e.actValue):-1}),e.forEach(function(e){"paid"==e.couponType?c.push('<div class="hour-coupon">                              <div data-act-id="'+e.actId+'">                                <div>'+e.actTitle+"</div>                                <div>"+e.consumeMoneyDescription+'</div>                              </div>                              <div>                                <div>点钟券</div>                                <div class="sure-btn" data-act-id="'+e.actId+'" data-act-value="'+e.actValue+'">立即购买</div>                              </div>                            </div>'):d.push('<div class="money-coupon">                              <div data-act-id="'+e.actId+'">                                <div>'+e.actTitle+"</div>                                <div>"+("money"==e.useType?e.actValue+"元现金券，":"")+e.consumeMoneyDescription+"</div>                              </div>                              <div>                                <div>"+e.useTypeName+'</div>                                <div class="sure-btn '+("already_get"==e.getFlag||"finish_get"==e.getFlag?"disabled":"")+'" data-act-id="'+e.actId+'" data-act-value="'+e.actValue+'" data-act-title="'+e.actTitle+'" data-user-get-count="'+e.userGetCount+'"  data-user-get-counts="'+e.userGetCounts+'">'+("already_get"==e.getFlag?"已领取":"finish_get"==e.getFlag?"已领完":"立即领取")+"</div>                              </div>                            </div>")}),0==c.length&&$("#couponList>div>div:nth-of-type(2)>div:nth-of-type(1)").CSS("display","none"),0==d.length&&$("#couponList>div>div:nth-of-type(2)>div:nth-of-type(2)").CSS("display","none"),$("#couponList>div>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(2)").Html(c.join("")),$("#couponList>div>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)").Html(d.join("")),(c.length>0||d.length>0)&&$("#paidCoupon").Event("click",function(){a.Class("active")}).ClassClear("hide"),$("#couponList>div>div:nth-of-type(1)>div").Click(function(){a.ClassClear("active")}),a.Delegate("click",".hour-coupon .sure-btn",function(e,n){var a=$(n),d=n.dataset;return $.$.ua.isWX?$.$.userToken?$.$.userTel?a.ClassHave("processing")?$.tipShow("购买中,请稍候..."):(a.Class("processing"),a.Text("购买中..."),void $.ajax({url:"../api/v2/wx/pay/paid_coupon",isReplaceUrl:!0,type:"post",data:{actId:d.actId,businessType:"paid_coupon",businessChannel:$.param("chanel")||"link",clubId:t,money:d.actValue,openId:$.$.openId,techId:i,tradeChannel:"wx",token:$.$.userToken,sessionType:$.$.sessionType},success:function(e){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appId,timeStamp:e.timeStamp+"",nonceStr:e.nonceStr,"package":e["package"],signType:e.signType,paySign:e.paySign},function(t){if(a.ClassClear("processing").Text("立即购买"),t.err_msg.indexOf("ok")>=0){$.tipShow("支付成功！"),a.Text("购买成功");var n=$.$.easemob;if(n.userId&&!n.conn.isOpened())var i=setInterval(function(){n.conn.isOpened()&&(clearInterval(i),o(e.bizId,d))},10);else o(e.bizId,d)}else $.tipShow("未能成功支付！")})}200==e.statusCode?(e=JSON.parse(e.respData),"undefined"==typeof WeixinJSBridge?doc.addEventListener?doc.addEventListener("WeixinJSBridgeReady",t,!1):doc.attachEvent&&(doc.attachEvent("WeixinJSBridgeReady",t),doc.attachEvent("onWeixinJSBridgeReady",t)):t()):"935801"==e.statusCode?($.localStorage("paid-coupon-param",!0),$.getOauthCode("","9358","paid-coupon","base")):(a.ClassClear("processing").Text("立即购买"),$.tipShow(e.msg||"购买点钟券请求失败！"))},error:function(){a.ClassClear("processing").Text("立即购买")}})):($.$.loginUrl=location.hash,$.bindPhone(!1),!0):($.tipShow("请您先登录！"),$.$.loginUrl="paidCoupon"+location.hash.split("paidCoupon")[1],$.page("login"),!0):$.tipShow("需在微信中打开才可购买")}).Delegate("click",".money-coupon .sure-btn",function(e,t){var i=$(t),o=t.dataset;if(!i.ClassHave("disabled")){if(!$.$.userToken)return $.$.loginUrl=location.hash,$.page("login"),!0;if(!$.$.userTel)return $.$.loginUrl=location.hash,$.bindPhone(!1),!0;if(i.ClassHave("processing"))return $.tipShow("领取中,请稍候...");i.Class("processing"),i.Text("领取中..."),$.ajax({url:"../get/redpacket",data:{actId:o.actId,phoneNum:$.$.userTel,openId:$.$.openId,techCode:n.inviteCode},success:function(e){i.ClassClear("processing").Text("立即领取"),200==e.statusCode?(o.userGetCount-0>o.userGetCounts-0+1?t.dataset.userGetCounts=o.userGetCounts-0+1:i.Text("已领取").Class("disabled"),$.tipShow("领取成功")):206==e.statusCode?(i.Text("已领取").Class("disabled"),$.tipShow(e.msg||"你已经领取过了！")):$.tipShow(e.msg||"领取失败！")},error:function(e){e.msg&&$.tipShow(e.msg),i.ClassClear("processing").Text("立即领取")}})}}),$(".hour-coupon>div:nth-of-type(1)").Click(function(e,t){$.page("paidCoupon&actId="+t.dataset.actId+"&techCode="+n.inviteCode+"&chanel="+($.param("chanel")||"link"))})}else $.tipShow(e.msg||"查询优惠券列表失败")}})}$("#backHome").Click(function(){$.page("home",-1,!0)}),$("#content").CSS("overflow-y","hidden"),$.ajax({url:($.$.clubID?"../":"")+"/technician/"+i,success:function(o){function a(){function e(){var n=[];if(a[3]>0)a=[a[0],a[1],a[2],a[3]-1],n=n.concat([3]);else if(a[2]>0)a=[a[0],a[1],a[2]-1,9],n=n.concat([2,3]);else if(a[1]>0)a=[a[0],a[1]-1,5,9],n=n.concat([1,2,3]);else{if(!(a[0]>0))return!0;a=[a[0]-1,9,5,9],n=n.concat([0,1,2,3])}t(n),setTimeout(e,1e3)}function t(e){e.forEach(function(e){s.Index(e).Children().Index(0).Text(a[e]),c.Index(e).Class("toggle")})}var n,i,o,a,d=(Math.round,Math.floor),c=(+new Date,$("#content>div:nth-of-type(1)>div:nth-of-type(2)>span")),s=$("#content>div:nth-of-type(1)>div:nth-of-type(2)>span>div");i=d(n%60),o=d(n/60%60),a=[1,0,0,1],s.Index(0).Children().Text(a[0]),s.Index(1).Children().Text(a[1]),s.Index(2).Children().Text(a[2]),s.Index(3).Children().Text(a[3]),setTimeout(e,1e3),c.Event(function(){var e,t=document.createElement("tmpelement"),n={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd",MsTransition:"msTransitionEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}(),function(e,t){var n=$(t),i=n.Children().Index(0).Children();i.Index(1).Text(i.Index(0).Text()),n.ClassClear("toggle")})}if(!o.id)return $.tipShow(o.msg||"无相关技师信息"),$.pageCancel();+new Date,+new Date;a();var d,c,s,l,r,p="",u="",v="",h=$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(3)"),f=$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(3)>span"),y=$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(3)>div:nth-of-type(2)"),C=$("#footer>div:nth-of-type(4)"),g=$("#telDetail");for(t=o.info.clubId,n=o.info,n.emchatId=o.emchatId,e(),y.Text(o.favoriteCount),$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(1)").CSS("backgroundImage","url("+(o.info.avatarUrl||$.$.defaultHeader)+")"),$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(1)").Text(o.info.name||$.$.defaultTechName),o.info.serialNo?$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(2)").Text(o.info.serialNo):$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(2)").Hide(),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(1)>div").CSS("width",(o.info.star||0)+"%"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(2)").Text((o.info.commentCount||0)+"评论"),$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(3)").Text("忙"),$("#content>div:nth-of-type(1)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(3)").Class("busy"),o.info.description?$("#content>div:nth-of-type(1)>div:nth-of-type(3)").Html(o.info.description||""):$("#content>div:nth-of-type(1)>div:nth-of-type(3)").Hide(),c=0,d=o.albums.length;c<d;c++)o.albums[c].imageUrl&&(p+="<div style=\"background-image: url('"+o.albums[c].imageUrl+"')\"></div>",u+='<img imageCache="'+o.albums[c].bigImageUrl+'"/>',v+="<span></span>");for($("#content>div:nth-of-type(2)>div>div")[0].innerHTML=p,setTimeout(function(){$("#content").CSS("overflow-y","auto")},1e3),$("#_picture>div:nth-of-type(1)")[0].innerHTML=u,$("#_picture>div:nth-of-type(2)")[0].innerHTML=v,""==p&&$("#content>div:nth-of-type(2)").Hide(),p="",c=0,d=o.service.length;c<d;c++)p+='<div hh="'+o.service[c].id+'">                        <div></div>                        <div style="background-image: url(\''+(o.service[c].imageUrl||$.$.defaultService)+"')\"></div>                        <div>"+(o.service[c].name||"")+"</div>                        <div>                            <div>"+$.formatPrice(o.service[c].price1,o.service[c].duration1,o.service[c].durationUnit)+"</div>                            <div>"+$.formatPrice(o.service[c].price2,o.service[c].duration2,o.service[c].durationUnitPlus)+"</div>                        </div>                    </div>";if(""==p?$("#content>div:nth-of-type(5)").Hide():($("#content>div:nth-of-type(5)>div:nth-of-type(2)").Html(p),$("#content>div:nth-of-type(5)>div:nth-of-type(2)>div").Click(function(e,t){"selected"!=t.className?($("#content>div:nth-of-type(5)>div:nth-of-type(2)>div.selected").ClassClear("selected"),t.className="selected",r=t.getAttribute("hh")):(t.className="",r=null)})),"y"==(o.isFavorite||"n").toLowerCase()&&h.Class("collected"),"n"==(o.appointment||"y").toLowerCase()&&"n"==(o.phoneAppointment||"y").toLowerCase()||C.Class("active"),p="",""!=o.telephone)for(c=0,u=o.telephone.split(","),length=u.length;c<length;c++)p+="<div>"+u[c]+"</div>";$("#telDetail>div").Html(p+"<div>取消</div>"),$("#pics>div>div>div").Click(function(e,t,n){x.IndexX(n),I.style.display=""});var m,T,I=$("#_picture")[0];I.addEventListener("touchstart",function(e){m=e.touches[0].clientX,T=Date.now()}),I.addEventListener("touchend",function(e){Date.now()-T<500&&Math.abs(e.changedTouches[0].clientX-m)<20&&(I.style.display="none",e.preventDefault())},!1);var x=$.scroll({content:I,contentX:I.children[0],flagX:I.children[1]});$("#content>div:nth-of-type(3)")[0].onclick=function(){$.page("review&id="+$.param("id"))},$("#content>div:nth-of-type(4)")[0].onclick=function(){$.page("technicianList",1,!0)};var b=null;h.Click(function(){if(!$.$.userToken)return $.$.loginUrl="technicianDetail&id="+$.param("id"),void $.page("login");var e=h.ClassHave("collected");b&&(clearTimeout(b),f.CSS("display","none"),f.ClassClear("active")),$.ajax({url:($.$.clubID?"../":"")+"../profile/user/favorite/"+(e?"delete":"create"),data:{id:$.param("id")},success:function(){e?h.ClassClear("collected"):h.Class("collected"),e?(f.Text("已取消"),y.Text(y.Text()-1)):(f.Text("已收藏"),y.Text(y.Text()-0+1)),f.CSS("display","block"),f.Class("active"),b=setTimeout(function(){f.CSS("display","none"),f.ClassClear("active")},1100)}})}),$("#footer>div:nth-of-type(3)").Click(function(){history.replaceState&&history.replaceState(null,document.title,location.search+location.hash.toString().replace(new RegExp("chat&techId="+i+("9358"==$.$.visitChannel?"&clubId="+o.info.clubId:"")+"[^/]*/"),"")),$.login("chat&techId="+i+("9358"==$.$.visitChannel?"&clubId="+o.info.clubId:"")+"&backPublic=true")}),C.Click(function(e,t){if(C.ClassHave("active"))if("n"!=(o.phoneAppointment||"y").toLowerCase()){if($.login())return;""==o.telephone?$.tipShow("暂无电话"):g.Class("active")}else"n"!=(o.appointment||"y").toLowerCase()&&("on"!=o.payAppointment||$.$.ua.isWX?$.login("confirmOrder&techId="+i+(r?"&itemId="+r:"")+("9358"==$.$.visitChannel?"&clubId="+o.info.clubId:""),!1,!0,!0):$.checkAccessMenu("confirmOrder")&&$.tipShow("【此会所需支付预约，请在微信客户端中打开】"))}),g.Event("touchmove",function(e){e.preventDefault()},!1),g.Click(function(e,t){e.target==t&&g.ClassClear()}),s=$("#telDetail>div>div"),l=s.Remove(s.length-1),s.Click(function(e,t){location.href="tel:"+t.innerHTML}),l.Click(function(){g.ClassClear()}),$.pageSwitch(!1,!1),$.$.ua.isWX&&$.X5Config({title:(o.info.name||$.$.defaultTechName)+"欢迎您",desc:"点我聊聊，更多优惠，更好服务！",link:location.href.split("?")[0]+"?club="+o.info.clubId+"#technicianDetail&id="+$.param("id"),imgUrl:o.info.avatarUrl||$.$.defaultHeader}),$("#footer>div:nth-of-type(1)").Click(function(){1==o.toDayCommentCount?$.tipShow("您今天已经评论过该技师了"):$.login("comment&techId="+i+"&type=tech&backPublic=true")}),$("#footer>div:nth-of-type(2)").Click(function(){$.$.ua.isWX?$.login("techReward&techId="+i+"&backPublic=true"):$.tipShow("请在微信中打开",4e3)}),$("#_picture>div:nth-of-type(1) img").ImgSrcCacheBack(!0)},error:function(e){$.tipShow(e),$.pageCancel()}})}var t,n,i=$.param("id"),o=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode;if(!i)return $.tipShow("技师不存在！"),$.pageCancel();if($.$.ua.isWX)if(!$.$.openId||$.$.openId.length<10){if((new Date).getTime()-($.getUrlParam("_t")||0)>24e3||!o)return void $.getOauthCode("","9358","confirm-tech-pay","base");$.ajax({url:"../api/v2/wx/oauth2/openid",isReplaceUrl:!0,data:{code:o,scope:"snsapi_base",wxmp:"9358",openId:"",webSessionId:""},success:function(t){if(200==t.statusCode)$.$.openId=t.respData.openid,e();else{if("40029"!=t.statusCode)return $.tipShow(t.msg||"获取openId失败！"),$.pageCancel();$.getOauthCode("","9358","confirm-tech-pay","base")}}})}else e();else e()}();