!function(){function t(){$.ajax({url:($.$.clubID?"../":"")+"/order/appoint/view",data:{clubId:r,techId:i||"",itemId:n||""},success:function(t){function o(t){if(i){var e=$.$.easemob;if(e.conn.isOpened())h(t);else{if(!e.conn.userId)return $.tipShow("未能获取您的账号信息，请您重新登录！"),$.page("login");var a=setInterval(function(){e.conn.isOpened()&&(clearInterval(a),h(t))},20)}}else $.page("orderDetail&id="+t+"&tag=submit"+($.param("backChat")?"&backChat=true":"")+("true"==$.param("backPublic")?"&backPublic=true":""),0,!0)}function h(e){function a(){$.updateSessionList(s,"text",!1),$.addToMsgList(s,"text"),"on"==v&&D>0?$.page("order"):$.page("orderDetail&id="+e+"&tag=submit"+($.param("backChat")?"&backChat=true":"")+("true"==$.param("backPublic")?"&backPublic=true":""),0,!0)}var i=$.$.userHeader,n=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,o="<span>发起预约</span><br>到店时间：<b>"+m.innerHTML+"</b><br>预约项目：<b>"+(t.item?t.item.name:"到店选择")+"</b>",r=$.$.easemob,s={from:$.$.easemob.userId,to:t.emchatId,data:o,ext:{name:t.tech.name,header:t.tech.avatarUrl,avatar:t.tech.avatar,no:t.tech.serialNo,techId:t.tech.id,clubId:t.tech.clubId,msgType:"order",orderId:e}},d=setTimeout(function(){s.status=0,a()},5e3);r.conn.isOpened()&&r.conn.send({to:t.emchatId,msg:o,type:"chat",ext:{name:n,header:i,msgType:"order",orderId:e,time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(t.emchatId,"off"==v?"order":"paid_order"),clearTimeout(d),s.status=1,a()}})}function f(t,e,a,s){var d={businessChannel:"link",clubId:r||"",dateDay:t||0,dateTime:e,downPayment:a,itemId:n||"",orderType:"paid",serviceDuration:s,techId:i||"",tradeChannel:"wx",username:g.Value()};$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/paid_order",type:"post",data:d,success:function(t){function e(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:t.appId,timeStamp:t.timeStamp+"",nonceStr:t.nonceStr,"package":t["package"],signType:t.signType,paySign:t.paySign},function(e){e.err_msg.indexOf("ok")>=0?(b.ClassClear("active"),$.tipShow("支付成功！"),o(t.bizId)):(b.ClassClear("active"),$.tipShow("未能成功支付！"),$.page("order")),y=!1})}200==t.statusCode?(t=JSON.parse(t.respData),"undefined"==typeof WeixinJSBridge?doc.addEventListener?doc.addEventListener("WeixinJSBridgeReady",e,!1):doc.attachEvent&&(doc.attachEvent("WeixinJSBridgeReady",e),doc.attachEvent("onWeixinJSBridgeReady",e)):e()):"935801"==t.statusCode?(d.arriveTime=m.innerHTML,$.localStorage("con-order-param",JSON.stringify(d)),$.getOauthCode("","9358","confirm-order","base")):($.tipShow(t.msg||"付费预约失败！"),y=!1,b.ClassClear("active"))},error:function(){$.tipShow("error"),y=!1,b.ClassClear("active")}})}if("200"!=t.statusCode)return $.tipShow(t.msg||"请求数据失败！"),$.pageCancel();var m=(new Date,$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)")[0]),y=!1,C=$("#footer>div"),g=$("#content>div:nth-of-type(5)>div:nth-of-type(1)>input");t=t.respData,D=t.downPayment||0,v=t.payAppointment,t.tech?(t.tech.avatarUrl=t.tech.avatarUrl||$.$.defaultHeader,$("#content>div:nth-of-type(2)>div:nth-of-type(1)").CSS("backgroundImage","url('"+t.tech.avatarUrl+"')"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(1)").Html(t.tech.name+"<span>[<span>"+(t.tech.serialNo||"")+"</span>]</span>"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)").Text(t.tech.description||"这个技师很懒，没有填写个人简介..."),$("#content>div:nth-of-type(2)>div:nth-of-type(1)>div").Class(t.tech.status),$("#content>div:nth-of-type(2)>div:nth-of-type(1)>div").Text("free"==t.tech.status?"闲":"忙"),$("#content>div:nth-of-type(2)>div:nth-of-type(1)").Login("chat&techId="+t.tech.id+("9358"==$.$.visitChannel?"&clubId="+t.tech.clubId:""))):($("#content>div:nth-of-type(2)>div:nth-of-type(1)").CSS("backgroundImage","url('"+$.$.defaultHeader+"')"),$("#content>div:nth-of-type(2)>div:nth-of-type(1)>div").CSS("display","none"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(1)").Html("技师待定"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)").Text("到店选择技师")),t.item?($("#content>div:nth-of-type(3)>div:nth-of-type(1)>span").Text(t.item.name),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>span").Text($.formatPrice(t.item.price,t.item.duration,t.item.durationUnit)),$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Hide()):($("#content>div:nth-of-type(3)>div:nth-of-type(1)>span").Text("到店选择"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>span").Text("待定"),$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Show()),s&&($("#content>div:nth-of-type(6)>div>span").CSS({"text-decoration":"line-through"}),D=d,$("#content>div:nth-of-type(5)>div>input").Value(c),$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Hide()),$("#content>div:nth-of-type(5)>div:nth-of-type(2)>span").Text($.$.userTel),!v||"off"==v||D<=0?($("#content>div:nth-of-type(6),#content>div:nth-of-type(7)").Hide(),$("#content>div:nth-of-type(5)").CSS("margin-bottom","4rem")):$("#content>div:nth-of-type(6)>div>span").Text("￥"+D+"元");var x=!1;p=[{time:[]},{time:[]},{time:[]}],t.time.forEach(function(t,e){t.time&&t.time.length>0&&(x=!0),t.time.sort(function(t,e){return t.time-e.time}),p[t.id]=t,Array.prototype.push.apply(w,t.time)});var S,T=45;if(n){var H=t.item;T=/次/g.test(H.durationUnit)?30*Number(H.duration):/天/g.test(H.durationUnit)?24*Number(H.duration)*60:/时/g.test(H.durationUnit)?60*Number(H.duration):Number(H.duration),N=T}S=Math.ceil(T/30),w.forEach(function(t,e){if("N"==t.status)t.tmpFlag=!1;else if(e+1<w.length){var a=w.slice(e+1,e+S),i=a.every(function(t){return"N"!=t.status});t.tmpFlag=i}else t.tmpFlag=!0;p[~~(e/48)].time[e%48].tmpFlag=t.tmpFlag});for(var P,A=new Date(t.today),U=1;U<4;U++)P=e(A,1==U?0:1),$(u[U-1]).Text(I[U-1]+P.month+"月"+P.day+"日"),$(u[U-1]).Attr("data-index",U),k.push(P);if(a(0),x||($("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)").Class("cancel"),$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)").Text("当前无可预约时间"),C.ClassClear("active")),$.pageSwitch(!0,!1),$.localStorage("customerName")&&!s&&g.Value($.localStorage("customerName")),C.Click(function(){if(g.Value()&&$.localStorage("customerName",g.Value()),y)$.tipShow("正在提交，请稍候...");else{if("cancel"==$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)")[0].className)return $.tipShow("当前无可预约时间！");if(!C.ClassHave("active"))return $.tipShow("请选择到店时间！");if(!g.Value())return $.tipShow("请输入联系人姓名！");if(b.Class("active"),!n){var t=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span.active");t=t.ClassHave("disabled")?"0":t.Text(),N=/小时/.test(t)?60*parseFloat(t):parseInt(t)}if(s)y=!0,C.Class("disabled"),C.Text("预约中..."),$.ajax({url:($.$.clubID?"../":"")+"/order/update_time",data:{clubId:r,dateDay:$(".day-list>div.active").Attr("data-index")-1,dateTime:m.innerHTML.slice(-5),orderId:s,sessionType:$.$.sessionType},success:function(t){y=!1,C.ClassClear("disabled"),C.Text("立即预约"),"200"==t.statusCode?o(s):($.tipShow(t.msg||"预约失败！"),b.ClassClear("active"))},error:function(){$.tipShow("预约失败！"),b.ClassClear("active"),y=!1,C.ClassClear("disabled"),C.Text("立即预约")}});else{if(!n&&0==N)return b.ClassClear("active"),$.tipShow("无项目时长，请更改到店时间。");if(v&&"on"==v&&D>0){if(!$.$.ua.isWX)return b.ClassClear("active"),void($.checkAccessMenu("confirmOrder")&&$.tipShow("请您打开微信登录'9358'公众号！"));$.$.userToken?(y=!0,C.Class("disabled"),C.Text("预约中..."),f($(".day-list>div.active").Attr("data-index")-1,m.innerHTML.slice(-5),D,N)):($.tipShow("请您先登录！"),$.$.loginUrl="confirmOrder"+location.hash.split("confirmOrder")[1],$.page("login"))}else y=!0,C.Class("disabled"),C.Text("预约中..."),$.ajax({url:($.$.clubID?"../":"")+"/order/appoint",type:"post",data:{username:g.Value(),dateDay:$(".day-list>div.active").Attr("data-index")-1,dateTime:m.innerHTML.slice(-5),clubId:r,techId:i||"",itemId:n||"",orderType:"on"==v?"paid":"appoint",downPayment:0,serviceDuration:N},success:function(t){y=!1,C.ClassClear("disabled"),C.Text("立即预约"),"200"==t.statusCode?o(t.respData):($.tipShow(t.msg||"预约失败！"),b.ClassClear("active"))},error:function(){$.tipShow("预约失败！"),b.ClassClear("active"),y=!1,C.ClassClear("disabled"),C.Text("立即预约")}})}}}),l){$.localStorageClear("con-order-param");var M={45:1,60:2,90:3,120:4}[l.serviceDuration];if(M){var E=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span");E.ClassClear("cancel"),E.ClassClear("active"),$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span:nth-of-type("+M+")")[0].click()}m.innerHTML=l.arriveTime,g[0].value=l.username,f(l.dateDay,l.dateTime,l.downPayment,l.serviceDuration)}}})}function e(t,e){return e&&t.setDate(t.getDate()+e),{date:t.getTime(),year:t.getFullYear(),month:t.getMonth()+1,day:t.getDate(),week:t.getDay()}}function a(t,e){(!t||t<0)&&(t=0),$(".time-list>div").Class("disabled"),$(".time-list>div").ClassClear("active");var a=[];h[0].innerHTML="",p[t].time.forEach(function(t,i){var n="";"N"===t.status||"Y"===t.status&&!t.tmpFlag?n="disabled":e&&e==t.timeStr&&(n="active"),t.timeStr&&("Y"!==t.status||t.tmpFlag?a.push('<div ix="'+i+'" class="'+n+'"><span >'+t.timeStr+"</span><span >&#45;&#45;:&#45;&#45;</span></div>"):a.push('<div ix="'+i+'" class="'+n+'"><span '+(t.tmpFlag||"N"===t.status?"":'style="display:block;"')+">"+t.timeStr+"</span><span "+(t.tmpFlag||"N"===t.status?"":'style="display:none;"')+">&#45;&#45;:&#45;&#45;</span></div>"))}),h[0].innerHTML=a.join(""),$(".time-list>div.active").length>0&&$(".time-list>div.active")[0].click()}var i=$.param("techId"),n=$.param("itemId"),o=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode,r=$.param("clubId")||$.getUrlParam("clubId")||$.$.clubID,s=$.param("orderId")||$.getUrlParam("orderId"),d=$.param("downPayment")||$.getUrlParam("downPayment"),c=$.param("customerName")||$.getUrlParam("customerName")||"",l=$.localStorage("con-order-param")?JSON.parse($.localStorage("con-order-param")):null;if($.$.payAuthCode=o,l&&o&&$.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:$.$.payAuthCode,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"confirm-order"},success:function(e){if(200==e.statusCode)t();else{if("935801"!=e.statusCode)return $.tipShow(e.msg||"获取openId失败！"),$.pageCancel();$.getOauthCode("","9358","confirm-order","base")}}}),!i&&!n||!r)return $.pageCancel(),$.tipShow("地址栏参数不正确！");$.$.userToken||($.tipShow("请您先登录！"),$.$.loginUrl="paidCoupon"+location.hash.split("paidCoupon")[1],$.page("login"));var p,v,u=$(".day-list>div"),h=$(".time-list"),f=($(".time-list>div"),$(".selected-time>span")),m=$(".confirm-button"),y=$("#_timePicker"),C=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span"),g=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span"),b=$("#payMask"),x=[45,60,90,120],S="",T=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],I=["今天","明天","后天"],k=[],w=[],D=0,N=0;"true"==$.param("backPublic")&&$("#title>div:nth-of-type(2)").Click(function(t){t.stopImmediatePropagation(),history.back()}),t(),$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)").Event("click",function(t,e){var a=$(e);S=a.Attr("data-time");var i=a.Attr("data-index")-1;i=i<0?0:i,u.Index(i)[0].click(),y.Class("active")}),C.Event("click",function(t,e){var a=$(e);a.ClassHave("cancel")||a.ClassHave("disabled")||(C.ClassClear("active"),a.Class("active"))}),u.Event("click",function(t,e){var i=$(e);i.ClassHave("active")&&!S||(u.ClassClear("active"),i.Class("active"),$(".time-list>div").ClassClear("active"),f.Text("--:--"),m.Class("disabled"),a(i.Attr("data-index")-1,S),S="")}),$(".time-list").Delegate("click",">div",function(t,e){var a=$(e);if(!a.ClassHave("disabled")){$(".time-list>div").ClassClear("active"),a.Class("active");var i=k[$(".day-list>div.active").Attr("data-index")-1];f.Text(i.month+"月"+i.day+"日 "+T[i.week]+" "+a.Children().Index(0).Text()),m.ClassClear("disabled")}}),m.Event("click",function(t,e){if(!$(e).ClassHave("disabled")){var a=$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)"),i=$(".day-list>div.active"),o=$(".time-list>div.active");a.Text(f.Text()),a.Attr("data-index",i.Attr("data-index")),a.Attr("data-time",i.Children().Index(0).Text()),a.ClassClear("cancel"),y.ClassClear("active"),C.ClassClear("cancel"),$("#footer>div").Class("active");var r=48*(i.Attr("data-index")-1)+(o.Attr("ix")-0);n||(g.ClassClear("cancel"),g.ClassClear("disabled"),x.every(function(t,e){var a=Math.ceil(t/30),i=w.slice(r+1,r+a),n=i.every(function(t){return"N"!==t.status});if(!n){for(var o=e,s=g.length;o<s;o++)g.Index(o).Class("disabled"),1==o?g.Index(0)[0].click():g.Index(1)[0].click();return!1}return!0}))}}),$("#_timePicker>div>div>div:nth-of-type(1)>span").Event("click",function(){y.ClassClear("active")})}();