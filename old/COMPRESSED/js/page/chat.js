!function(){function e(){f?$.ajax({url:($.$.clubID?"..":"")+"/technician/"+f,data:{needServiceInfo:"N"},success:function(e){return e.id?(oe.currChatTech=de={chatId:e.emchatId,name:e.info.name||$.$.defaultTechName,header:e.info.avatarUrl||$.$.defaultHeader,avatar:e.info.avatar,clubId:e.info.clubId,clubName:e.clubName,techId:e.info.id,inviteCode:e.info.inviteCode,no:e.info.serialNo||"",appointment:e.appointment,phoneAppointment:e.phoneAppointment,telephone:e.telephone,chatName:le,chatHeader:re},"y"==(e.isFavorite||"n").toLowerCase()&&$("div#title>i:nth-of-type(1)").Class("collected"),t(),void 0):($.tipShow(e.msg||"未能获取技师的信息！"),$.pageCancel())},error:function(){return $.tipShow("未能获取技师的信息，技师可能已离开会所！"),$.pageCancel()}}):oe.currChatTech&&oe.currChatTech.chatId?($("#tip").Hide(),$("div#title>i:nth-of-type(1)").Hide(),z.Hide(),$("#chatInput>div:nth-of-type(2)>div.reward").Hide(),de=oe.currChatTech,ae=!0,t()):$.page("message",-1,!0)}function t(){function e(){return""==k[0].innerHTML?void $.tipShow("当前无积分礼物可发送！"):(D.ClassHave("active")?(M.className="",B.className="",R.ClassClear("active"),D.ClassClear("active")):(l("gift"),M.className="popExpression",B.className="popExp",R.Class("active"),D.Class("active")),void o())}function t(e){var t,a=oe.msgList[de.chatId].list;for(t=a.length-1;t>=0;t--)if(a[t].msgType&&"diceGame"==a[t].msgType&&a[t].gameId==e&&"request"==a[t].gameStatus){a[t].gameStatus="handled",$.localStorage($.$.userID+"_MsgList_"+de.chatId,JSON.stringify(oe.msgList[de.chatId]));break}}var d=$.localStorage($.$.userID+"_isChatThisDay_"+de.chatId);B.addEventListener("touchmove",function(e){e.preventDefault()},!1),y=new IScroll("#message-list-wrapper",{probeType:1,tap:!0,click:!1,preventDefaultException:{tagName:/.*/},mouseWheel:!0,scrollbars:!0,fadeScrollbars:!0,interactiveScrollbars:!1,keyBindings:!1,deceleration:2e-4,startY:parseInt(J)*-1}),y.on("scrollStart",function(){X=!0}),y.on("scroll",function(){X=!0,this.y>=5&&"flip"!=V.className?(V.className="flip",V.querySelector("span").innerHTML="松开之后刷新..."):this.y<=5&&"flip"==V.className&&(V.className="",V.querySelector("span").innerHTML="加载更多...")}),y.on("scrollEnd",function(){setTimeout(function(){X=!1},100),"flip"==V.className&&(V.className="loading",V.querySelector("span").innerHTML="加载更多...",u())}),$("#title>div:nth-of-type(1)").Html(de.name+(de.no?"<span>["+de.no+"]</span>":""));var v=500,T=$.$.winHeight;w.Event("focus",function(){0==w.Html().length&&(L.style.display="none"),setTimeout(function(){o(!1)},300),Y=!0,$.$.ua.isiPhone?setTimeout(function(){H[0].scrollIntoView(!0),v=300},v):setTimeout(function(){T-$.$.winHeight<100&&w[0].scrollIntoView(!0)},500),D.ClassHave("active")&&e()}),L.onclick=function(){L.style.display="none",w[0].focus()},w.Event("blur",function(){0==w.Html().replace(/<br>/,"").length&&(w[0].innerHTML="",L.style.display="block",N[0].className="disabled"),Y=!1,setTimeout(function(){$("#content")[0].scrollIntoView()},300)}),w.Event("input",function(){0==w.Html().length?"disabled"!=N[0].className&&(N[0].className="disabled"):"disabled"==N[0].className&&(N[0].className="");var e=window.getSelection();U.node=e.focusNode,U.offset=e.focusOffset}),w.Event("click",function(t){if("img"==t.target.tagName.toLowerCase()){for(var a,i=t.target,s=i.parentNode,n=0;n<s.childNodes.length;n++)if(i==s.childNodes[n]){a=n+1;break}document.createRange&&window.getSelection&&a&&g(s,a)}var c=window.getSelection();U.node=c.focusNode,U.offset=c.focusOffset,D.ClassHave("active")&&(e(),w[0].focus())}),N.Event("click",function(e,t){if(L.style.display="none","disabled"!=t.className){var a=k[0].querySelector("div.active");if(R.ClassHave("active")&&a){var i=(a.getAttribute("gift-integral")||0)-0;i>0?$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(e){200==e.statusCode&&(e=e.respData,b=e&&e[0]?e[0].amount:0,Q.Text(b),parseInt(b)<=0||i&&parseInt(i)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("发送礼物需要"+(i||"")+"积分，当前您的积分不足。"),Z.Class("active"),w[0].innerHTML="",N[0].className="disabled",a.className="gift-item"):r(a,i))}}):r(a,i)}else{var s=w[0].innerHTML.replace(/<\/div>/g,"").replace(/<div>/g,"<br/>");q.innerHTML=s;for(var n,c=q.getElementsByTagName("img"),d=c.length,l=d-1;l>=0;l--)n=document.createTextNode(c[l].getAttribute("data-exp")),q.replaceChild(n,c[l]);if(q.innerHTML.length>1e3)return $.tipShow("您输入的太多了，无法发送！");q.innerHTML.length!=4*d&&w[0].focus();var u=document.createElement("div");u.className="right",u.innerHTML+="<span>"+$.formatMsgTime(Date.now(),!0)+"</span><div style='background-image: url("+re+")'></div><div>"+s+"</div>",x.appendChild(u),o(),w[0].innerHTML="",N[0].className="disabled";var p={from:oe.userId,to:de.chatId,data:q.innerHTML,ext:{name:de.name,header:de.header,avatar:de.avatar,no:de.no,techId:de.techId,clubId:de.clubId}},m=setTimeout(function(){p.status="0",$.updateSessionList(p,"text",!1),$.addToMsgList(p,"text")},5e3);oe.conn.send({to:de.chatId,msg:q.innerHTML,type:"chat",ext:{name:le,header:re,time:Date.now(),avatar:$.$.userAvatar},success:function(){u.querySelector("div:nth-of-type(2)").classList.add("success"),clearTimeout(m),p.status="1",$.updateSessionList(p,"text",!1),$.addToMsgList(p,"text"),$.sendFriend(de.chatId,"text",ae?"manager":"tech")}}),U.node=w[0],U.offset=0,$.$.ua.isiPhone&&setTimeout(function(){o()},800)}}}),$.scroll({content:_[0],contentX:_.Children()[0],indexX:j-1,endX:function(e){j=e+1,P.ClassClear("active"),P.Index(j-1).Class("active")}}),H.Click(function(){H.ClassHave("active")?(M.className="",B.className="",H.ClassClear("active"),_.Class("hide")):(l("expression"),_.ClassClear("hide"),M.className="popExpression",B.className="popExp",U.offset=w[0].childNodes.length,U.node=w[0],H.Class("active")),o()}),_.Delegate("click","li",function(e,t){if(U.node&&p(U.node)){var a,i,s,n,c,d,r,l=t.children[0];i=document.createElement("img");var o=window.getComputedStyle(l,null).backgroundImage;if(o='"'==o.charAt(4)||"'"==o.charAt(4)?o.slice(5,-2):o.slice(4,-1),i.src=o,i.setAttribute("data-exp",l.getAttribute("data-exp")),3==U.node.nodeType?(a=U.node,0==U.offset?a.parentNode.insertBefore(i,a):U.offset==a.nodeValue.length?a.nextSibling?a.parentNode.insertBefore(i,a.nextSibling):a.parentNode.appendChild(i):(n=a.nodeValue,a.nodeValue=n.substr(0,U.offset),c=a.nextSibling,c?(a.parentNode.insertBefore(i,c),r=document.createTextNode(n.substr(U.offset)),a.parentNode.insertBefore(r,c)):(a.parentNode.appendChild(i),r=document.createTextNode(n.substr(U.offset)),a.parentNode.appendChild(r)))):1==U.node.nodeType&&(U.offset==U.node.childNodes.length?U.node.appendChild(i):(s=U.node.childNodes[U.offset],U.node.insertBefore(i,s))),""!=w[0].innerHTML?(L.style.display="none",N[0].className=""):(L.style.display="block",N[0].className="disabled"),document.createRange){for(var u=i.parentNode,m=0;m<u.childNodes.length;m++)if(u.childNodes[m]==i){d=m+1;break}d&&(Y?g(u,d):(U.offset=d,U.node=u))}}}),k.Delegate("click","div",function(e,t){var a=$(t);a.ClassHave("active")?(a.ClassClear("active"),L.style.display="block",w[0].innerHTML="",N[0].className="disabled"):(E.ClassClear("active"),a.Class("active"),L.style.display="none",w[0].innerHTML="[礼物："+t.getAttribute("gift-name")+"]",N[0].className="")}),R.Click(function(){e()}),$("#chatInput input#uploadImg").Event("change",function(e,t){if(l("pic"),oe.conn){var a=t.files[0];if(a.size>10485760)return $.tipShow("抱歉！所选图片超过10M，太大无法发送！");var i=a.name.lastIndexOf(".");if(i<0)return;var s=a.name.substring(i+1);if(!/^(jpg|jpeg|gif|png|bmp)$/i.test(s))return $.tipShow("请选择图片进行发送！");var n=Easemob.im.Helper.getFileUrl("uploadImg");if(!n.url||0==n.url.length)return;var c=document.createElement("div");c.className="right",c.innerHTML="<span>"+$.formatMsgTime(new Date,!0)+"</span><div style='background-image: url("+re+")'></div><div class='img'><img /></div>";var d=c.children[2].children[0];d.src=window.URL.createObjectURL(a),d.onload=function(){window.URL.revokeObjectURL(this.src),d.setAttribute("w",this.width),d.setAttribute("h",this.height);var e,t=this.width,i=this.height,s=this.width/(16*$.$.scale),r=this.height/(16*$.$.scale);s<10&&r<9||(s=this.width/10,r=this.height/9,e=s>r?s:r,s=this.width/e,r=this.height/e),d.style.width=s+"rem",d.style.height=r+"rem",x.appendChild(c),o(),oe.conn.send({file:n,to:de.chatId,type:"img",width:t,height:i,file_length:a.size,onFileUploadComplete:function(e){$.tipShow("图片发送成功！"),$.sendFriend(de.chatId,"image",ae?"manager":"tech"),d.onload=null,d.src=e.uri+"/"+e.entities[0].uuid,c.querySelector("div:nth-of-type(2)").classList.add("success");var a={from:oe.userId,to:de.chatId,url:e.uri+"/"+e.entities[0].uuid,width:t,height:i,status:1,ext:{name:de.name,header:de.header,avatar:de.avatar,no:de.no,techId:de.techId,clubId:de.clubId}};$.updateSessionList(a,"pic",!1),$.addToMsgList(a,"pic")},onFileUploadError:function(e){$.tipShow("图片发送失败，请稍后重试！"+JSON.stringify(e))},ext:{name:le,header:re,time:Date.now(),avatar:$.$.userAvatar}})}}});var S=null,A=$("#title>i:nth-of-type(1)>span");$("#title>i:nth-of-type(1)").Click(function(e,t){var a="collected"==t.className;S&&(clearTimeout(S),A.CSS("display","none"),A.ClassClear("active")),$.ajax({url:($.$.clubID?"../":"")+"../profile/user/favorite/"+(a?"delete":"create"),data:{id:de.techId},success:function(){t.className=a?"":"collected",a?A.Text("已取消"):A.Text("已收藏"),A.CSS("display","block"),A.Class("active"),S=setTimeout(function(){A.CSS("display","none"),A.ClassClear("active")},1100)}})}),f?$("#title>i:nth-of-type(2)").Click(function(){history.replaceState&&history.replaceState(null,document.title,location.search+location.hash.toString().replace(new RegExp("technicianDetail&id="+f+"[^/]*/"),"")),$.page("technicianDetail&id="+f)}):($("#title>i:nth-of-type(2)").CSS("display","none"),$("#title>i:nth-of-type(3)").CSS("right",".667rem")),$("#title>i:nth-of-type(3)").Click(function(){$.$.clubID?$.page("home",-1,!0):location.href=location.origin+location.pathname+"?club="+de.clubId});var O=$("#telDetail"),F=$("#tip"),G="",ie=de.telephone.split(",");if("y"!=(de.appointment||"y").toLowerCase()&&"y"!=(de.phoneAppointment||"y").toLowerCase()||F.Class("active"),""!=de.telephone)for(C=0;C<ie.length;C++)G+="<div>"+ie[C]+"</div>";O[0].querySelector("div").innerHTML=G+"<div>取消</div>",O.Event("touchmove",function(e){e.preventDefault()},!1),O.Click(function(e,t){e.target==t&&O.ClassClear()});var ue=$("#telDetail>div>div"),pe=ue.Remove(ue.length-1);ue.Click(function(e,t){location.href="tel:"+t.innerHTML}),pe.Click(function(){O.ClassClear()}),$("#chatInput>div:nth-of-type(2)>div.reward").Click(function(){l("reward"),$.$.ua.isWX?$.login("techReward&techId="+f+"&backPublic=true"):$.checkAccessMenu("techReward")&&$.tipShow('请打开微信登录"9358"公众号！')}),F.Click(function(){F.ClassHave("active")?"y"==(de.phoneAppointment||"y").toLowerCase()?""==de.telephone?$.tipShow("暂无预约电话！"):O.ClassHave("active")?O.ClassClear("active"):O.Class("active"):"y"==(de.appointment||"y").toLowerCase()&&$.login("confirmOrder&techId="+f+"&backChat=true"+("9358"==$.$.visitChannel?"&clubId="+I:""),!1,!0,!0):$.tipShow("抱歉！当前技师不可预约！")}),$("#chatInput>div:nth-of-type(2)>div.dice").Click(function(){l("dice"),n()}),K.Click(function(e,t){K.ClassClear("active"),ee=t.innerHTML+"",t.className="active"}),$("#diceSetting div.cancel").Click(function(){W.ClassClear("active")}),$("#diceSetting div.invite").Click(function(){W.ClassClear("active"),s()}),$("#notEnoughTip div.cancel").Click(function(){Z.ClassClear("active")}),$("#notEnoughTip div.get").Click(function(){$.page("integralExplain")}),$.addMsgDiv=function(e,a,i,s,n){var c,d=document.createElement("div");if(a=a||e.type||"text",e.ext&&e.ext.msgType&&(e.msgType=e.ext.msgType),"paidCouponTip"==e.msgType||"couponTip"==e.msgType)d.className="center "+e.msgType,d.innerHTML="<div>"+$.formatMsgTime(e.time||new Date,!0)+"</div><span><i></i>"+e.data+"<a>点击查看</a></span>";else if("diceGame"==e.msgType){var r=e.gameStatus||e.ext.gameStatus,l=e.gameInvite||e.ext.gameInvite,u=e.gameId||e.ext.gameId;if(d.setAttribute("gameId",u),"handled"==r)d=null;else if("over"!=r)l==oe.userId?(c=document.querySelector("#"+u+"_invite"),c&&(x.removeChild(c),t(u)),"request"==r&&(d.setAttribute("id",u+"_invite"),e.time&&Date.now()-e.time>se&&(r="overtime")),d.className="right dice-invite",d.innerHTML="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span>                                                      <div style='background-image: url("+re+")'></div>                                                      <div class='"+(1==(e.status||1)?"success":"")+"'>                                                           <h4>邀请"+de.name+"玩骰子<span>"+e.data+"积分</span></h4>                                                          <div>                                                             <div class='other'><div>"+de.name+"</div>"+("<div gameId="+u+" class='"+("request"==r?"wait":"reject")+"'>"+te[r]+("request"==r?"<a class='cancel dice-game'>取消</a>":"")+"</div>")+"</div>                                                             <div class='dice'></div>                                                             <div class='mine'><div>"+$.$.userName+"</div><div style='background-image: url("+re+")'></div></div>                                                          </div>                                                      </div>                                                     <div class='"+("reject"==r||"cancel"==r||"overtime"==r?"":"hide")+"'><span>"+("reject"==r?"对方拒绝游戏":"cancel"==r?"游戏已取消":"游戏超时")+"，返还"+e.data+"积分</span></div>"):(c=document.querySelector("#"+u+"_request"),c&&("cancel"==c.getAttribute("gameStatus")?d=null:x.removeChild(c),t(u)),d&&("request"==r&&e.time&&Date.now()-e.time>se&&(r="overtime"),d.id=u+"_request",d.className="left dice-request",d.setAttribute("gameStatus",r),d.innerHTML="<span>"+$.formatMsgTime(e.time||Date.now(),!0)+"</span>                                                            <div style='background-image: url("+de.header+")'></div>                                                            <div>                                                                <div>                                                                    <div>"+de.name+"邀请您玩骰子"+("request"!=r?"<span>("+te[r]+")</span>":"")+"</div>                                                                    <div>比大小，每局胜方将获得负方"+e.data+"积分</div>                                                                </div>                                                                <div gameId='"+u+"' class='"+("request"!=r?"disabled":"")+"'><div class='reject dice-game'>拒绝</div><div class='accept dice-game'>接受</div></div>                                                            </div>"));else{var p=e.gameResult||e.ext.gameResult,g=l==oe.userId;p=p.split(":");var v=g?p[0]>p[1]:p[0]<p[1],f=g?p[1]:p[0],I=g?p[0]:p[1];d.className="right dice-result"+(e.ext?"":" show"),d.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span>                                                                <div style='background-image: url("+re+")'></div>                                                                <div class='success'>                                                                    <div class='left'><div>"+de.name+"</div><div class='"+(v?"":"act")+"'><img src='img/chat/dice/dice"+f+(e.ext?".gif":".png")+"'/></div></div>                                                                    <div class='right'><div class='"+(v?"victory":"failure")+"'>"+le+"</div><div class='"+(v?"act":"")+"'><img src='img/chat/dice/dice"+I+(e.ext?".gif":".png")+"'/></div><span>"+(v?"+":"-")+e.data+"</span></div>                                                                    <div class='split'><i>vs</i></div>                                                                </div>                                                                <div><span>"+(v?"获取":"消费")+e.data+"积分，<a amount='"+e.data+"' class='dice-game-tip'>再玩一局</a></span></div>",e.ext&&setTimeout(function(){v&&h();var e=d.querySelectorAll("img");e[0].src=e[0].src.slice(0,-3)+"png",e[1].src=e[1].src.slice(0,-3)+"png",d.classList.add("show")},2100)}}else if("gift"==e.msgType){var C=ne[e.giftId||e.ext.giftId];C=C?C.url||ce:ce,d.className="right gift",d.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span><div style='background-image: url("+re+")'></div><div "+(1==(e.status||1)?"class='success'":"")+"><img gift='true' src='"+C+"'/></div>"}else{d.className=e.from==oe.userId?"right":"left";var T=e.from==oe.userId?re:de.header;"paidCoupon"==e.msgType&&(e.actId=e.actId||e.ext.actId,e.techCode=e.techCode||e.ext.techCode);var y="right"==d.className&&1==(e.status||1)?"success":"";if("text"==a)d.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span><div style='background-image: url("+T+")'></div><div class='"+(e.msgType||"")+" "+y+"' "+("paidCoupon"==e.msgType?"actId='"+e.actId+"' techCode='"+e.techCode+"'":"ordinaryCoupon"==e.msgType&&e.userActId?"userActId='"+e.userActId+"'":"")+">"+m(e.data)+"</div>";else if("pic"==a){var b,S=e.width/(16*$.$.scale),w=e.height/(16*$.$.scale);S<10&&w<9||(S=e.width/10,w=e.height/9,b=S>w?S:w,S=e.width/b,w=e.height/b),d.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span><div style='background-image: url("+T+")'></div><div class='img "+y+"'><img "+(1==n?"data-":"")+"src='"+e.url+"' style='width:"+S+"rem;height:"+w+"rem' w='"+e.width+"' h='"+e.height+"'/></div>"}}d&&(0==x.children.length||1!=i?x.appendChild(d):x.insertBefore(d,x.children[0])),0!=s&&o()},$.pageSwitch(!0),$.ajax({url:"../api/v2/credit/switch/status",isReplaceUrl:!0,data:{clubId:I},success:function(e){e=e.respData,e&&"on"==e.clubSwitch?("on"!=e.diceGameSwitch||ae||($("#chatInput>div:nth-of-type(2)>div.dice").Show(),se=1e3*e.gameTimeoutSeconds),R.Show(),$.ajax({url:"../api/v2/credit/gift/list",isReplaceUrl:!0,success:function(e){if(e=e.respData){var t,a="";for(t=0;t<e.length;t++)ne[e[t].id]={url:e[t].gifUrl},a+="<div class='gift-item' gift-id='"+e[t].id+"' gift-name='"+e[t].name+"' gift-integral = '"+e[t].ratio+"' gift-url='"+e[t].gifUrl+"'>                                                                <i></i>                                                                <img src='"+e[t].iconUrl+"'/>                                                                <div><span>"+e[t].ratio+"</span>积分</div>                                                            </div>";k[0].innerHTML=a,k.CSS("width",5*e.length+"rem"),E=$("#chatInput>div.gift-list>div.list>div>div.gift-item")}i(d)}}),a()):i(d)}}),$(x).Event("click",function(e){var t=e.target,a=t.parentNode,i=a.parentNode;if(/(paidCoupon|begReward|ordinaryCoupon|dice-game|dice-game-tip)/.test(a.className)&&(t=a),"img"!=t.tagName.toLowerCase()||/dice/.test(t.src)||t.getAttribute("gift")){if(/paidCoupon/.test(t.className))$.$.userTel?$.page("paidCoupon&actId="+t.getAttribute("actId")+"&techCode="+t.getAttribute("techCode")+"&chanel=link"):($.$.loginUrl=location.hash.substring(1).replace(/^\//,"").replace(/\/$/,""),$.bindPhone(!0));else if(/begReward/.test(t.className))$("#chatInput>div:nth-of-type(2)>div.reward")[0].click();else if(/ordinaryCoupon/.test(t.className))t.getAttribute("userActId")?$.page("couponDetail&userActId="+t.getAttribute("userActId")):$.page("coupon");else if(/dice-game-tip/.test(t.className))return n(t.getAttribute("amount")),!0}else t.getAttribute("data-exp")||($.param("imgScan","true"),$.$.lastScanImgParent=a,$.$.scanimg.showImg(t));if(/center/.test(a.className)?t=a:/center/.test(i.className)&&(t=i),/center/.test(t.className)&&$.page("coupon"),a=t.parentNode,/dice-game/.test(t.className)&&"disabled"!=a.className){var s,d,r=oe.msgList[de.chatId].list;for(s=r.length-1;s>=0;s--)if(r[s].msgType&&"diceGame"==r[s].msgType&&r[s].gameId==a.getAttribute("gameId")){d=r[s];break}if(d){var l=t.className.split(" ")[0];"cancel"==l?c(l,d,a):(a.className="disabled","accept"==l?$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(e){200==e.statusCode?(e=e.respData,b=e&&e[0]?e[0].amount:0,Q.Text(b),parseInt(d.data)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("玩骰子需要"+d.data+"积分，当前您的积分不足。"),Z.Class("active"),a.className=""):c(l,d,a.parentNode.children[0].children[0])):$.tipShow("请求异常！")}}):c(l,d,a.parentNode.children[0].children[0]))}}}),de.techId&&$.ajax({url:"../api/v1/profile/redpack/list",isReplaceUrl:!0,data:{clubId:de.clubId},success:function(e){if(200==e.statusCode){var t,e=e.respData.coupons||[],a="";for(t=0;t<e.length;t++)a+="paid"==e[t].couponType?t==e.length-1?"<li type='paid' actId='"+e[t].actId+"'>"+(e[t].actTitle.length>7?e[t].actTitle.substr(0,7)+"...":e[t].actTitle)+"<i></i><i></i></li>":"<li type='paid' actId='"+e[t].actId+"'>"+e[t].actTitle+"</li>":t==e.length-1?"<li type='"+e[t].couponType+"' actId='"+e[t].actId+"' techCode='"+de.inviteCode+"' actTitle='"+e[t].actTitle+"'>"+(e[t].actTitle.length>7?e[t].actTitle.substr(0,7)+"...":e[t].actTitle)+"<i></i><i></i></li>":"<li type='"+e[t].couponType+"' actId='"+e[t].actId+"' techCode='"+de.inviteCode+"' actTitle='"+e[t].actTitle+"'>"+e[t].actTitle+"</li>";z[0].querySelector("ul").innerHTML=a,e.length>0?(z.Click(function(){l("coupon"),z.ClassHave("active")?z.ClassClear("active"):z.Class("active")}),$("#chatInput>div:nth-of-type(2)>div.coupon>ul>li").Click(function(e,t){var a=t.getAttribute("type");if("paid"==a)$.login("paidCoupon&actId="+t.getAttribute("actId")+"&techCode="+de.inviteCode,!1,!0,!0);else{if(!$.$.userTel)return $.$.loginUrl=location.hash.substring(1).replace(/^\//,"").replace(/\/$/,""),$.bindPhone(!0),!1;$.ajax({url:($.$.clubID?"../":"")+"get/redpacket",data:{actId:t.getAttribute("actId"),phoneNum:$.$.userTel,openId:$.$.openId,userCode:"",techCode:t.getAttribute("techCode"),chanel:"link"},success:function(e){if(200==e.statusCode){$.tipShow("成功领取一张优惠券！");var a={from:oe.userId,to:de.chatId,data:"您领取了"+de.name+'的"'+t.getAttribute("actTitle")+'"',ext:{name:de.name,header:de.header,avatar:de.avatar,no:de.no,techId:de.techId,clubId:de.clubId,msgType:"couponTip"},status:1};oe.conn.send({to:de.chatId,msg:t.getAttribute("actTitle"),type:"chat",ext:{name:le,header:re,msgType:"couponTip",time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(de.chatId,"coupon",ae?"manager":"tech"),$.addMsgDiv(a,"couponTip",!1,!0,!1),$.updateSessionList(a,"text",!1),$.addToMsgList(a,"text")}})}else $.tipShow(e.msg||"未能成功领取优惠券！")}})}})):z.Click(function(){l("coupon"),$.tipShow("抱歉！暂无优惠券！")})}}})}function a(){$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(e){200==e.statusCode&&(e=e.respData,b=e&&e[0]?e[0].amount:0,Q.Text(b))}})}function i(e){var t=$.getSessionList(!1),a=$.getMsgList(de.chatId);if(t[de.chatId]&&a.name){var i=t[de.chatId]["new"],s=a.list.length;for(i<10&&(i=s>=10?10:s),C=a.list.length-1;C>=s-i;C--)$.addMsgDiv(a.list[C],null,!0,!1,!0);F=C,$.showMsgNum(-t[de.chatId]["new"]),t[de.chatId]["new"]=0,$.localStorage($.$.userID+"_SessionList",JSON.stringify(t)),setTimeout(function(){o(!0,800)},200);var n=x.querySelectorAll("div>div.img>img");for(C=0;C<n.length;C++)n[C].getAttribute("data-src")&&(n[C].src=n[C].getAttribute("data-src"))}e===!0&&a.list&&0!=a.list.length||$.addMsgDiv({from:de.chatId,to:oe.userId,type:"text",data:de.clubName+"欢迎您！",time:Date.now()},"text",!0,!0)}function s(e){var t=(e||ee)+"";parseInt(t)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("玩骰子需要"+t+"积分，当前您的积分不足。"),Z.Class("active")):$.ajax({url:"../api/v2/credit/game/dice/submit",isReplaceUrl:!0,data:{clubId:I,amount:t,emchatId:de.chatId},success:function(e){if(200==e.statusCode){var a=e.respData.gameId,i=document.createElement("div"),s=Date.now();i.className="right dice-invite",i.setAttribute("gameId","dice_"+a),i.setAttribute("id","dice_"+a+"_invite"),i.innerHTML+="<span>"+$.formatMsgTime(s,!0)+"</span>                                                                <div style='background-image: url("+re+")'></div>                                                                <div>                                                                    <h4>邀请"+de.name+"玩骰子<span>"+t+"积分</span></h4>                                                                    <div>                                                                        <div class='other'><div>"+de.name+"</div><div class='wait' gameId='dice_"+a+"'>等待接受...<a class='cancel dice-game'>取消</a></div></div>                                                                        <div class='dice'></div>                                                                        <div class='mine'><div>"+$.$.userName+"</div><div style='background-image: url("+re+")'></div></div>                                                                    </div>                                                                </div>                                                                <div class='hide'><span>对方拒绝游戏，返还"+t+"积分</span></div>",x.appendChild(i),o();var n={from:oe.userId,to:de.chatId,data:t,ext:{name:de.name,header:de.header,avatar:de.avatar,no:de.no,techId:de.techId,clubId:de.clubId,msgType:"diceGame",gameInvite:oe.userId,gameStatus:"request",gameId:"dice_"+a,gameResult:"0:0"}},c=setTimeout(function(){n.status="0",$.updateSessionList(n,"diceGame",!1),$.addToMsgList(n,"diceGame")},5e3);oe.conn.send({to:de.chatId,msg:t,type:"chat",ext:{name:le,header:re,time:s,avatar:$.$.userAvatar,msgType:"diceGame",gameStatus:"request",gameInvite:oe.userId,gameId:"dice_"+a,gameResult:"0:0"},success:function(){i.querySelector("div:nth-of-type(2)").classList.add("success"),clearTimeout(c),n.status="1",$.updateSessionList(n,"text",!1),$.addToMsgList(n,"text"),$.sendFriend(de.chatId,"game",ae?"manager":"tech")}})}else $.tipShow(e.msg||"游戏创建失败！")}})}function n(e){$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(t){200==t.statusCode&&(b=t.respData&&t.respData[0]?t.respData[0].amount:0,Q.Text(b),parseInt(b)<=0||e&&parseInt(e)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("玩骰子需要"+(e||"")+"积分，当前您的积分不足。"),Z.Class("active")):e?s(e):W.Class("active"))}})}function c(e,t,a){var i=e;if(+new Date-t.time>se?(e="overtime",d(e,t)):$.ajax({url:"../api/v2/credit/game/dice/accept",isReplaceUrl:!0,data:{gameId:t.gameId.split("_")[1],status:e},success:function(i){200==i.statusCode?(i=i.respData,d(e,t,i)):($.tipShow(i.msg||"处理游戏操作异常！"),"accept"==e&&(e="overtime",a.querySelector("span").innerHTML="("+te[e]+")",d(e,t)))}}),"cancel"==e||"cancel"==i){a.className="cancel",a.innerHTML=te[e];var s=document.querySelector("#"+t.gameId+"_invite");s&&(s=s.querySelector("div.hide"),s.className="",s.innerHTML="<span>游戏已取消，"+s.innerHTML.split("，")[1])}else a.innerHTML+="<span>("+te[e]+")</span>"}function d(e,t,a){if("overtime"==e?(t.gameStatus=e,$.localStorage($.$.userID+"_MsgList_"+de.chatId,JSON.stringify(oe.msgList[de.chatId]))):oe.conn.send({to:de.chatId,msg:t.data,type:"chat",ext:{name:le,header:re,time:Date.now(),avatar:$.$.userAvatar,msgType:"diceGame",gameInvite:t.gameInvite,gameStatus:e,gameId:t.gameId,gameResult:"0:0"},success:function(){t.gameStatus=e,$.localStorage($.$.userID+"_MsgList_"+de.chatId,JSON.stringify(oe.msgList[de.chatId])),$.sendFriend(de.chatId)}}),a&&"accept"==a.status){var i=t.gameId.split("_")[1],s=document.createElement("div"),n=Date.now(),c=a.dstPoint>a.srcPoint;s.className="right dice-result",s.innerHTML+="<span>"+$.formatMsgTime(n,!0)+"</span>                                                                <div style='background-image: url("+re+")'></div>                                                                <div class='success'>                                                                    <div class='left'><div>"+de.name+"</div><div class='"+(c?"":"act")+"'><img src='img/chat/dice/dice"+a.srcPoint+".gif'/></div></div>                                                                    <div class='right'><div class='"+(c?"victory":"failure")+"'>"+le+"</div><div class='"+(c?"act":"")+"'><img src='img/chat/dice/dice"+a.dstPoint+".gif'/></div><span>"+(c?"+":"-")+a.belongingsAmount+"</span></div>                                                                    <div class='split'><i>vs</i></div>                                                                </div>                                                                <div><span>"+(c?"获取":"消费")+a.belongingsAmount+"积分，<a amount='"+a.belongingsAmount+"' class='dice-game-tip'>再玩一局</a></span></div>",x.appendChild(s),o(),setTimeout(function(){c&&h();var e=s.querySelectorAll("img");e[0].src=e[0].src.slice(0,-3)+"png",e[1].src=e[1].src.slice(0,-3)+"png",s.classList.add("show")},2100);var d={from:oe.userId,to:de.chatId,data:a.belongingsAmount+"",ext:{name:de.name,header:de.header,avatar:de.avatar,no:de.no,techId:de.techId,clubId:de.clubId,msgType:"diceGame",gameInvite:de.chatId,gameStatus:"over",gameId:"dice_"+i,gameResult:a.srcPoint+":"+a.dstPoint}};oe.conn.send({to:de.chatId,msg:a.belongingsAmount+"",type:"chat",ext:{name:le,header:re,time:n,avatar:$.$.userAvatar,msgType:"diceGame",gameStatus:"over",gameInvite:de.chatId,gameId:"dice_"+i,gameResult:a.srcPoint+":"+a.dstPoint},success:function(){d.status="1",$.updateSessionList(d,"text",!1),$.addToMsgList(d,"text"),$.sendFriend(de.chatId)}})}}function r(e,t){var i=document.createElement("div"),s=e.getAttribute("gift-name"),n=e.getAttribute("gift-id"),c=e.getAttribute("gift-url");i.className="right gift",i.innerHTML+="<span>"+$.formatMsgTime(Date.now(),!0)+"</span><div style='background-image: url("+re+")'></div><div><img gift='true' src='"+c+"'/></div>",x.appendChild(i),w[0].innerHTML="",N[0].className="disabled",e.className="gift-item";var d={from:oe.userId,to:de.chatId,data:"[礼物："+s+"]",ext:{name:de.name,header:de.header,avatar:de.avatar,no:de.no,techId:de.techId,clubId:de.clubId,msgType:"gift",giftValue:t,giftName:s,giftId:n}},r=setTimeout(function(){d.status="0",$.updateSessionList(d,"text",!1),$.addToMsgList(d,"text")},5e3);oe.conn.send({to:de.chatId,msg:"[礼物："+s+"]",type:"chat",ext:{name:le,header:re,time:Date.now(),avatar:$.$.userAvatar,msgType:"gift",giftValue:t+"",giftName:s,giftId:n},success:function(){i.querySelector("div:nth-of-type(2)").classList.add("success"),clearTimeout(r),d.status="1",$.updateSessionList(d,"text",!1),$.addToMsgList(d,"text"),$.ajax({url:"../api/v2/credit/gift/send",isReplaceUrl:!0,data:{clubId:I,emchatId:de.chatId,giftId:n,num:1},success:function(e){200==e.statusCode?a():$.tipShow(e.msg||"礼物发送失败！")}}),$.sendFriend(de.chatId,"text",ae?"manager":"tech")}}),U.node=w[0],U.offset=0,o()}function l(e){"expression"!=e&&(M.className="",B.className="",H.ClassClear("active"),_.Class("hide")),"coupon"!=e&&z.ClassClear("active"),"gift"!=e&&(M.className="",B.className="",R.ClassClear("active"),D.ClassClear("active"),$("#chatInput>div.gift-list>div.list>div>div.gift-item").ClassClear("active"),L.style.display="block",w[0].innerHTML="",N[0].className="disabled")}function o(e,t){y&&(0!=e&&y.refresh(),G.offsetHeight>B.offsetHeight&&setTimeout(function(){parseInt(G.style.top)!=y.maxScrollY&&y.scrollTo(0,y.maxScrollY,t||300,!1)},0!=e?300:1))}function u(){if(F>=0){for(var e=F;e>=0&&e>=F-O;e--)$.addMsgDiv(oe.msgList[de.chatId].list[e],null,!0,!1);F=e}y.refresh()}function p(e,t){return!(!e||t>4)&&(e==w[0]||(e=e.parentNode,p(e,t+1)))}function m(e){return e.replace(T,function(){var e=S[arguments[0]];if(e){var t=window.getComputedStyle(A[e-1].children[0],null).backgroundImage;return t='"'==t.charAt(4)||"'"==t.charAt(4)?t.slice(5,-2):t.slice(4,-1),"<img src='"+t+"' data-exp='"+arguments[0]+"'/>"}return arguments[0]})}function g(e,t){var a=document.createRange(),i=window.getSelection();a.selectNodeContents(e),a.collapse(!0),a.setEnd(e,t),a.setStart(e,t),i.removeAllRanges(),i.addRange(a),U.offset=t,U.node=e}function v(e,t,a){t=t||3,t<3&&(t=3),a=a||3e3,a<=0&&(a=3e3),a*=2;for(var i,s=1,n=parseInt(Math.random(+new Date)*(t-3))+3;s<n;s++)i=parseInt(Math.random(+new Date)*a+4e3)+"ms",
ie+='<div class="'+e+'" style="left:'+parseInt(18*Math.random(+new Date))+"rem;transition-duration: "+i+";-webkit-transition-duration: "+i+";-moz-transition-duration: "+i+";-ms-transition-duration: "+i+"; -o-transition-duration: "+i+';"></div>'}function h(){ie="",v("m1",18),v("m2",18),$("#specEffect").Html(ie),setTimeout(function(){$("#specEffect>div").Translate(0,2*$.$.winHeight+"px")},300)}var f=$.param("techId"),I=$.param("clubId")||$.$.clubID;if(!I)return $.tipShow("会所不存在！"),$.pageCancel();for(;$.param("imgScan");)$.paramClear("imgScan");var C,T,y,b,S={"/::O":1,"/::Y":2,"/::B":3,"/::A":4,"/::C":5,"/::D":6,"/::X":7,"/::Z":8,"/::F":9,"/::E":10,"/::T":11,"/::P":12,"/::G":13,"/::H":14,"/::I":15,"/::J":16,"/::K":17,"/::L":18,"/::M":19,"/::N":20,"/::Q":21,"/::R":22,"/::S":23,"/::U":24,"/::V":25,"/::W":26,"/::a":27,"/::b":28},w=$("#chatInput>div:nth-of-type(1)>div.input"),N=$("#chatInput>div:nth-of-type(1)>a"),x=$("#message-list-scroller>div.talk")[0],L=$("#chatInput>div:nth-of-type(1)>span")[0],M=$("#chatInput")[0],H=$("#chatInput>div:nth-of-type(2)>div.expression"),A=$("#chatInput>div:nth-of-type(3) li"),D=$("#chatInput>div.gift-list"),k=$("#chatInput>div.gift-list>div.list>div"),E=null,R=$("#chatInput>div:nth-of-type(2)>div.gift"),q=document.createElement("div"),U={node:null,offset:null},_=$("#chatInput>div:nth-of-type(3)"),j=1,P=$("#chatInput>div:nth-of-type(3)>div:nth-of-type(2)>span"),O=10,F=-1,G=$("#message-list-scroller")[0],B=$("#message-list-wrapper")[0],V=G.querySelector("div:nth-of-type(1)"),J=Math.round(1.387*$.$.scale*16),X=!1,Y=!1,z=$("#chatInput>div:nth-of-type(2)>div.coupon"),W=$("#diceSetting"),Z=$("#notEnoughTip"),K=$("#diceSetting>div>ul>li"),Q=$("#chatInput>div.gift-list>div.info>b"),ee="1",te={request:"等待接受...",accept:"已接受",reject:"已拒绝",overtime:"已超时",cancel:"已取消"},ae=!1,ie="",se=864e5,ne={},ce="img/chat/gift_default.png";T=new RegExp("/::[A-Zab]+","g");var de,re=$.$.userHeader,le=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,oe=$.$.easemob;if(oe.conn.isOpened())e();else{if(!oe.userId)return $.$.loginUrl="chat&techId="+(f||"")+("9358"==$.$.visitChannel?"&clubId="+I:""),$.page("login");var ue=setInterval(function(){oe.conn.isOpened()&&(clearInterval(ue),e())},20)}$("#message-list-wrapper").Delegate("click",".talk>.left>div:nth-of-type(1)",function(){ae||(history.replaceState&&history.replaceState(null,document.title,location.search+location.hash.toString().replace(new RegExp("technicianDetail&id="+f+"[^/]*/"),"")),$.page("technicianDetail&id="+f))})}();