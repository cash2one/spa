!function(){function e(){function e(e){if(a="true"===e.hasInnerProvider,"phone"==e.appointType){var t="";if(""!=e.telephone)for(var c=0,o=e.telephone.split(","),r=o.length;c<r;c++)t+="<div>"+o[c]+"</div>";$("#telDetail>div").Html(t+"<div>取消</div>"),h.Event("touchmove",function(e){e.preventDefault()},!1),h.Click(function(e,t){e.target==t&&h.ClassClear()}),i=$("#telDetail>div>div"),n=i.Remove(i.length-1),i.Click(function(e,t){location.href="tel:"+t.innerHTML}),n.Click(function(){h.ClassClear()}),$("#confirmBtn>div:nth-of-type(1)").Click(function(){""==e.telephone?$.tipShow("暂无电话"):h.Class("active")})}else $("#confirmBtn>div:nth-of-type(1)").Click(function(){if("paid"!=e.appointType&&"paid_full"!=e.appointType&&!a||$.$.ua.isWX){var t=1==d?$("#content>div.scroll_content>div:nth-of-type("+(s+1)+")").Attr("hh"):b[s].id,i=$("#content>div.scroll_content>div:nth-of-type("+(s+1)+")>div>div:nth-of-type(3)>div.selected").Attr("hh");if(a&&!i)return $.tipShow("必须选择一技师");$.login("confirmOrder&itemId="+t+(i?"&techId="+i:"")+"&backPublic=true",!1,!0,!0)}else $.checkAccessMenu("confirmOrder")&&$.tipShow("【此会所需支付预约，请在微信客户端中打开】")})}function g(i,n){$.ajax({url:"service/item",data:{top:0,index:n,itemId:i,pageSize:5},success:function(a){if("200"!=a.statusCode)return $.tipShow(a.msg||"数据请求失败！"),$.pageCancel();if(!b){if(0==a.pageCount)return r.Class("nullData"),$.pageSwitch(!0,!1);y(a)}e(a.respData),x=a.respData.itemIndex,a=a.respData.serviceItems;var d;for(t=0;t<a.length;t++)if(a[t].id==i){d=t;break}for(d||0==n||n==-1&&(d=a.length),d=x-d,t=0;t<a.length;t++)b[t+d]||(b[t+d]={status:0,id:a[t].id,dataObj:a[t]});for(t=0;t<b.length;t++)b[t]&&0==b[t].status&&($("#content>div.scroll_content>div:nth-of-type("+(t+1)+")").Html(k(b[t].dataObj)),$("div#content>div.scroll_content>div:nth-of-type("+(t+1)+") div.list").Click(function(e,t){var i=e.timeStamp||(new Date).getTime();l?(i-l>350&&w(t),l=i):(l=i,w(t))}),b[t].status=1);0==n&&$.pageSwitch(!0,!1),$("#content>div>div>div>div:nth-of-type(1)>div:nth-of-type(1)").DivBackgroundCacheBack(),$("#content>div>div>div>div:nth-of-type(2) img").ImgSrcCacheBack(),C(s)}})}function C(e){b[e].dataObj.discountPrice?(u.Class("has-discount"),f.Text(b[e].dataObj.discountPrice)):u.ClassClear("has-discount")}function y(e){b=[],b.length=e.pageCount;for(var t="",i=0;i<b.length;i++)t+="<div></div>";p.Html(t),s=e.respData.itemIndex,$.scroll({content:v,contentX:p[0],indexX:s,endX:function(e){var t=e-s>0?1:-1;s=e,$.param("id",b[e].id),1==t&&s<b.length-1&&!b[s+1]||t==-1&&s>0&&!b[s-1]?g(b[e].id,t):C(s)}})}function k(e){var t,i=1==d?'<div hh="'+e.id+'">':"";if(i+='<div>                                <div>                                    <div imageCache="'+(e.imageUrl||$.$.defaultService)+'"></div>                                    <div>                                        <div>'+e.name+"</div>                                        <div"+(e.price?"":' style="display:none;"')+">                                            <div></div>                                            <div>"+$.formatPrice(e.price,e.duration,e.durationUnit)+"</div>                                        </div>                                        <div"+(e.pricePlus?"":' class="none"')+">加钟"+$.formatPrice(e.pricePlus,e.durationPlus,e.durationUnitPlus)+"</div>                                    </div>                                </div>                                <div><div><div></div>项目说明</div>"+(e.description||"").replace(/src/g,"imageCache")+"</div>",e.technicians&&e.technicians.length>0){for(i+='<div>                                    <div class="title"><div></div>选择技师</div>',t=0;t<e.technicians.length;t++)i+='<div class="list" hh="'+e.technicians[t].id+'">                                            <div></div>                                            <div style="background-image: url('+(e.technicians[t].avatarUrl||$.$.defaultHeader)+')"></div>                                            <div>                                                <div><div>'+($.$.ua.isFirefox&&e.technicians[t].name.length>3?e.technicians[t].name.substr(0,3)+"...":e.technicians[t].name||"小摩豆技师")+"</div><div>[<span>"+(e.technicians[t].serialNo||"")+"</span>]</div> </div>                                                <div>"+(e.technicians[t].description||"这个技师很懒，没有填写个人简介...")+'</div>                                                <div><div><div style="width:'+e.technicians[t].star+'%"></div></div><span>'+e.technicians[t].commentCount+"评论</span></div>                                            </div>                                        </div>";i+="</div>"}return i+="</div>",1==d&&(i+="</div>"),i}function w(e){var e=$(e);e.ClassHave("selected")?e.ClassClear("selected"):($("#content>div.scroll_content>div:nth-of-type("+(s+1)+")>div>div:nth-of-type(3)>div.list").ClassClear("selected"),e.Class("selected"))}function I(e){if(!$.$.ua.isWX)return $.tipShow("请在微信中打开");$.tipShow("支付购买中..."),$.eventMaskShow(!0);var t={itemId:e.itemId,techId:e.techId,businessChannel:e.businessChannel||$.getUrlParam("channel")||"link"};t.clubId=$.$.clubID,t.tradeChannel="wx",t.openId=$.$.openId,$.ajax({url:"../api/v2/wx/pay/service_item_coupon/save",isReplaceUrl:!0,type:"post",data:t,success:function(e){function i(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appId,timeStamp:e.timeStamp+"",nonceStr:e.nonceStr,"package":e["package"],signType:e.signType,paySign:e.paySign},function(t){$.eventMaskShow(!1),t.err_msg&&t.err_msg.indexOf("ok")>=0?($.tipShow("支付成功！"),$.page("robProjectSuccess&couponType=service_item&id="+e.payId)):$.tipShow("未能成功支付！")})}200==e.statusCode?(e=JSON.parse(e.respData),"undefined"==typeof WeixinJSBridge?doc.addEventListener?doc.addEventListener("WeixinJSBridgeReady",i,!1):doc.attachEvent&&(doc.attachEvent("WeixinJSBridgeReady",i),doc.attachEvent("onWeixinJSBridgeReady",i)):i()):"935801"==e.statusCode?($.sessionStorage("con-service-item-param",JSON.stringify(t)),$.getOauthCode("","9358","confirm-rob-project","base"),$.eventMaskShow(!1)):($.tipShow(e.msg||"系统错误，请联系管理员"),$.eventMaskShow(!1))},error:function(){$.tipShow("error"),$.eventMaskShow(!1)}})}var b,x;1==d?$.ajax({url:"service/item",data:{top:1},success:function(i){if("200"!=i.statusCode)return $.tipShow(i.msg||"数据请求失败！"),$.pageCancel();for(e(i.respData),i=i.respData.serviceItems,b=[],t=0;t<i.length;t++)b[t]={status:0,id:i[t].id,dataObj:i[t]},c+=k(i[t]),o==i[t].id&&(s=t);""==c?r.Class("nullData"):p.Html(c),$.scroll({content:v,contentX:p[0],indexX:s,endX:function(e){s=e,$.param("id",i[e].id),C(s)}}),$("div.list").Click(function(e,t){var i=e.timeStamp||(new Date).getTime();l?(i-l>350&&w(t),l=i):(l=i,w(t))}),$.pageSwitch(!0,!1),$("#content>div>div>div>div:nth-of-type(1)>div:nth-of-type(1)").DivBackgroundCacheBack(),$("#content>div>div>div>div:nth-of-type(2) img").ImgSrcCacheBack(),C(s)}}):g(o,0),m.Click(function(){if(!$.$.userTel)return $.$.loginUrl=location.hash,$.bindPhone(!0),!0;var e=1==d?$("#content>div.scroll_content>div:nth-of-type("+(s+1)+")").Attr("hh"):b[s].id,t=$("#content>div.scroll_content>div:nth-of-type("+(s+1)+")>div>div:nth-of-type(3)>div.selected").Attr("hh");I({itemId:e,techId:t})}),S&&(S=JSON.parse(S),$.sessionStorageClear("con-service-item-param"),I(S))}var t,i,n,a,d=$.param("top")||"",c="",o=$.param("id"),s=0,r=$("#content"),v=$("#content")[0],l=null,p=$("#content>div"),h=$("#telDetail"),u=$("#confirmBtn"),f=$("#discountPrice"),m=$("#confirmBtn>div:nth-of-type(2)"),g=$.param("code")||$.getUrlParam("code"),C=$.param("state")||$.getUrlParam("state"),S=$.sessionStorage("con-service-item-param");$.$.ua.isWX&&S&&g.length>20&&"con-service-item"==C?$.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:g,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"con-service-item"},success:function(t){if(200==t.statusCode)$.$.openId=resp.respData.openid,e();else{if("935801"!=t.statusCode)return $.tipShow(t.msg||"获取openId失败！"),$.pageCancel();$.getOauthCode("","9358","confirm-rob-project","base")}}}):e()}();