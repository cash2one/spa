!function(){function e(e,r){h||(h=!0,m=e||m+1,y.ClassClear("none"),C.Class("none"),S=!1,$.ajax({url:($.$.clubID?"../":"")+"../profile/user/order/list",data:{token:$.$.userToken,clubId:$.$.clubID,page:m,pageSize:L},success:function(e){for(e="200"!=e.statusCode?[]:e.respData,1==m&&(f={}),c=0,v="",p=e.length;c<p;c++)if(M[e[c].status]){if(!f[e[c].id]){f[e[c].id]=1,e[c].refundStatus&&(e[c].status=e[c].refundStatus),u=/^(reject|sysReject|failure)$/.test(e[c].status)?"failure":e[c].status,v+="<div orderId='"+e[c].id+"' clubId='"+e[c].clubId+"' techid='"+(e[c].techId||"")+"' itemid='"+(e[c].serviceItemId||"")+"' downPayment='"+(e[c].downPayment||0)+"' customerName='"+(e[c].customerName||"")+"' tradeYear='"+e[c].createdAt.match(/^(\d{4})/g)[0]+"'>                            <div >"+e[c].clubName+"<span>"+(e[c].downPayment>0?"￥"+e[c].downPayment+"元":"")+"</span><span>"+M[e[c].status].name+"</span></div>                            <div>                                <div>选择技师<span>"+(e[c].techId?e[c].techName+"<span>编号 [<strong>"+(e[c].techSerialNo||"")+"</strong>]</span></span>":"到店安排</span>")+"</div>                                 <div>选择项目<span>"+(e[c].serviceItemName||"到店选择")+"</span></div>                                <div>到店时间<span>"+(t(e[c].appointTime)||"")+"</span></div>";var a="paid"==e[c].orderType||"paid_full"==e[c].orderType,i=!!e[c].innerProvider;switch(e[c].status){case"unpaid":v+="</div>",a&&(v+="<a orderId='"+e[c].id+"' class='paid'>支付</a>",k[e[c].id]=e[c]);break;case"submit":v+=a?"<div style='display:none;'><img src='"+e[c].qrCodeUrl+"'/><div></div></div></div>":"</div>",v+="<a class='reminder'>催单</a>",a&&!i&&(v+="<span class='expandBtn'>展开</span>");break;case"accept":v+=a&&!i?"<div style='display:none;'><img src='"+e[c].qrCodeUrl+"'/><div>预约号："+e[c].orderNo+"</div></div></div>":"</div>",v+="<a class='inquiries'>问询</a>",a&&!i&&(v+="<span class='expandBtn'>展开</span>");break;case"complete":v+=a&&!i?"<div style='display:none;'><img src='"+e[c].qrCodeUrl+"'/><div></div></div></div>":"</div>",e[c].techId&&"N"==e[c].commented&&(v+="<a orderId='"+e[c].id+"' class='comment'>点评</a>"),a&&!i&&(v+="<span class='expandBtn'>展开</span>");break;case"refundfailure":case"reject":case"overtime":v+="</div>",a&&(v+="<a orderId='"+e[c].id+"' class='refund'>退款</a>",k[e[c].id]=e[c]);break;case"refund":v+="</div>",a&&(v+="<a orderId='"+e[c].id+"' class='refunded'>查询</a>");break;case"error":v+="</div><a orderId='"+e[c].id+"' class='reAppoint'>预约</a>",a&&!i&&(v+="<a orderId='"+e[c].id+"' class='refund'>退款</a>",k[e[c].id]=e[c]);break;case"cancel":case"refunded":case"failure":case"expire":case"process":default:v+="</div>"}v+="</div>","error"==e[c].status&&x.ClassHave("hide")&&+function(e){setTimeout(function(){var t=$("#reAppointDlg>div>p:nth-of-type(2)"),r=t.Html().replace(/\{\d+\}/g,function(){return e.techName});$("#reAppointDlg>div>p:nth-of-type(2)")[0].innerHTML=r,$("#reAppointDlg>div>div>div:nth-of-type(2)").Attr("orderid",e.id),x.ClassClear("hide"),$.hideOrderMenu()},100)}(e[c])}}else console.warn("已忽略：未定义的订单状态：",e[c].status,"; 订单ID:",e[c].id);1==m?(I.Html(v),v?I.ClassClear("nullData"):(I.Class("nullData"),S=!0),J=I[0].scrollHeight):(I.Html(v,!0),p<L&&(S=!0,C.ClassClear("none"))),d(),h=!1,y.Class("none"),r&&r()}}))}function t(e){if(/^\d{2}:\d{2}$/g.test(e)&&(e="今天 "+e),/今天|明天|后天|大后天/.test(e)){var t=new Date;e=e.split(" ");var r={"今天":0,"明天":1,"后天":2,"大后天":3};return t.setDate(t.getDate()+r[e[0]]||0),e[0]+" ( "+(t.getMonth()<9?"0"+(t.getMonth()+1):t.getMonth()+1)+"-"+(t.getDate()<=9?"0"+t.getDate():t.getDate())+" ) "+e[1]}return e}function r(e,t){if(/今天|明天|后天|大后天/.test(e)){t=t||new Date,e=e.split(" ");var r={"今天":0,"明天":1,"后天":2,"大后天":3};return t.setDate(t.getDate()+r[e[0]]||0),t.getMonth()+1+"月"+(t.getDate()<=9?"0"+t.getDate():t.getDate())+"日 "+e[1]}return/^\d{2}:\d{2}$/g.test(e)?(t=new Date,t.getMonth()+1+"月"+(t.getDate()<=9?"0"+t.getDate():t.getDate())+"日 "+e):e}function a(){$.sessionStorage("order_data",I.Html()),$.sessionStorage("order_page",m),$.sessionStorage("order_page_height",J),$.sessionStorage("order_end",S),$.sessionStorage("order_ID",JSON.stringify(f)),$.sessionStorage("order_top",b[0].scrollTop),$.sessionStorage("unpaidDatas",JSON.stringify(k))}function d(){$("#content>div>div:nth-of-type(2)>div>div:nth-of-type(1),#content>div>div:nth-of-type(2)>div>div:nth-of-type(2)>div",!0).Event("click",function(e,t){a(),$.page("orderDetail&id="+(t.parentNode.getAttribute("orderId")||t.parentNode.parentNode.getAttribute("orderId")))})}function i(){D.Class("active"),$.hideOrderMenu()}function n(){D.ClassClear("active"),$.showOrderMenu()}function s(e){a();var t={bizId:e.id,sessionType:$.$.sessionType,token:$.$.userToken,openId:$.$.payOpenId,clubId:e.clubId,businessChannel:"link",tradeChannel:"wx",downPayment:e.downPayment};j||(j=!0,$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/paid_order_immediately",type:"post",data:t,success:function(r){function d(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:r.appId,timeStamp:r.timeStamp+"",nonceStr:r.nonceStr,"package":r["package"],signType:r.signType,paySign:r.paySign},function(t){if(j=!1,t.err_msg.indexOf("ok")>=0){$.tipShow("支付成功！"),$('div[orderid="'+e.id+'"][tradeyear] > div:nth-of-type(1) > span:nth-of-type(2)').Text("付款处理中"),$('div[orderid="'+e.id+'"][tradeyear] > a.paid[orderid="'+e.id+'"]').Class("hide"),$.ajax({url:($.$.clubID?"../":"")+"../profile/user/order/view",data:{id:e.id},success:function(t){if(200==t.statusCode){if(t=t.respData.order,"submit"==t.status){var r=$('div[orderid="'+e.id+'"][tradeyear]'),a=document.createElement("div"),d=$('div[orderid="'+e.id+'"][tradeyear] > a.paid[orderid="'+e.id+'"]'),i=document.createElement("span");a.style.display="none",a.innerHTML='<img src="'+t.qrCodeUrl+'" /><div>'+(t.orderNo?"预约号："+t.orderNo:"")+"</div>",r.Children().Index(1)[0].appendChild(a),i.classList.add("expandBtn"),i.innerHTML="展开",r[0].appendChild(i),$('div[orderid="'+e.id+'"][tradeyear] > div:nth-of-type(1) > span:nth-of-type(2)').Text(M[t.status].name),d.ClassClear("paid"),d.Class("reminder"),d.ClassClear("hide"),d.Text("催单")}else if("error"==t.status){var r=$('div[orderid="'+e.id+'"][tradeyear]'),d=$('div[orderid="'+e.id+'"][tradeyear] > a.paid[orderid="'+e.id+'"]'),n=document.createElement("a");n.className="refund",n.textContent="退款",r[0].appendChild(n),$('div[orderid="'+e.id+'"][tradeyear] > div:nth-of-type(1) > span:nth-of-type(2)').Text(M[t.status].name),d.ClassClear("paid"),d.Class("reAppoint"),d.Text("预约"),d.ClassClear("hide");var s=$("#reAppointDlg>div>p:nth-of-type(2)"),o=s.Html().replace(/\{\d+\}/g,function(){return t.techName});$("#reAppointDlg>div>p:nth-of-type(2)")[0].innerHTML=o,$("#reAppointDlg>div>div>div:nth-of-type(2)").Attr("orderid",t.id),x.ClassClear("hide"),$.hideOrderMenu()}}else $.tipShow(t.msg),location.href=location.href}});var r=$.$.easemob;if(r.userId&&!r.conn.isOpened())var a=setInterval(function(){r.conn.isOpened()&&(clearInterval(a),o(e))},10);else o(e)}else $.tipShow("未能成功支付！"),j=!1;n()})}200==r.statusCode?(r=JSON.parse(r.respData),g=r["package"].split("=")[1],n(),"undefined"==typeof WeixinJSBridge?doc.addEventListener?doc.addEventListener("WeixinJSBridgeReady",d,!1):doc.attachEvent&&(doc.attachEvent("WeixinJSBridgeReady",d),doc.attachEvent("onWeixinJSBridgeReady",d)):d()):"935801"==r.statusCode?(a(),$.localStorage("order-list-param",JSON.stringify(t)),$.getOauthCode("&targetid="+t.bizId,"9358","order-list","base")):(n(),$.tipShow(r.msg||"支付预约请求失败！"),j=!1)},error:function(){n(),j=!1}}))}function o(e){var t=$.$.userHeader,a=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,d="<span>发起预约</span><br>到店时间：<b>"+r(e.appointTime)+"</b><br>预约项目：<b>"+(e.serviceItemId?e.serviceItemName:"到店选择")+"</b>",i=e.id,n=$.$.easemob;$.ajax({url:($.$.clubID?"../":"")+"/technician/"+e.techId,success:function(e){var r=e.emchatId;e=e.info;var s={from:$.$.easemob.userId,to:r,data:d,ext:{name:e.name,header:e.avatarUrl,avatar:e.avatar,no:e.serialNo,techId:e.id,clubId:e.clubId,msgType:"order",orderId:i}},o=setTimeout(function(){s.status=0,$.updateSessionList(s,"text",!1),$.addToMsgList(s,"text")},5e3);n.conn.isOpened()&&n.conn.send({to:r,msg:d,type:"chat",ext:{name:a,header:t,msgType:"order",orderId:i,time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(r,"business_process"),clearTimeout(o),s.status=1,$.updateSessionList(s,"text",!1),$.addToMsgList(s,"text")}})}})}function l(e){if(!e)return $.tipShow("暂无服务电话");var t=[],e=e.split(",");e.forEach(function(e,r){t.push("<div>"+e+"</div>")}),t.push("<div>取消</div>"),N.Children().Index(0).Html(t.join("")),N.Class("active"),$.hideOrderMenu()}$.tipShow("Test",0,!0);var c,p,u,g,v="",f=JSON.parse($.sessionStorage("order_ID")||"{}"),h=!1,m=1,y=$("#loadTip"),C=$("#finishTip"),S="true"==($.sessionStorage("order_end")||"false"),I=$("#content>div>div:nth-of-type(2)"),b=$("#content"),D=$("#payMask"),x=$("#reAppointDlg"),A=$.sessionStorage("order_top"),T=$.sessionStorage("order_page"),w=$.sessionStorage("order_data"),N=$("#telDetail"),_={},k=($.sessionStorage("unpaidDatas")?JSON.parse($.sessionStorage("unpaidDatas")):0)||{},O=!1,M={unpaid:{tag:"unpaid",name:"待支付"},submit:{tag:"fail",name:"待接受"},accept:{tag:"normal",name:"已接受"},cancel:{tag:"fail",name:"取消"},reject:{tag:"fail",name:"拒接"},complete:{tag:"normal",name:"完成"},failure:{tag:"fail",name:"失效"},overtime:{tag:"fail",name:"超时"},refund:{tag:"refund",name:"退款中"},refunded:{tag:"refunded",name:"退款完成"},refundfailure:{tag:"refunded",name:"退款失败"},error:{tag:"error",name:"下单失败"},expire:{tag:"expire",name:"过期"},process:{tag:"process",name:"付款处理中"}},H=$.localStorage("order-list-param")?JSON.parse($.localStorage("order-list-param")):null,E=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode,j=!1,J=$.sessionStorage("order_page_height")||0,L=10,P=.4;if($.$.payAuthCode=E,$("#content").Delegate("click",".paid:not(.disabled)",function(e,t){var r=$(t).Attr("orderid"),a=k[r];return $.$.ua.isWX?void($.$.userToken?E?(i(),s(a)):"9358"==$.$.sessionType?s(a):($.sessionStorage("order_data",I.Html()),$.sessionStorage("order_page",m),$.sessionStorage("order_page_height",J),$.sessionStorage("order_end",S),$.sessionStorage("order_ID",JSON.stringify(f)),$.sessionStorage("order_top",b[0].scrollTop),$.sessionStorage("unpaidDatas",JSON.stringify(k)),$.ajax({url:"../api/v1/check_login/"+$.$.sessionType+"/"+$.$.userToken,isReplaceUrl:!0,success:function(e){"Y"==e.msg?$.getOauthCode("&targetid="+r,"9358","order-list","base"):($.tipShow("请您先登录！"),$.$.loginUrl="order"+location.hash.split("order")[1],$.page("login"))}})):($.tipShow("请您先登录！"),$.$.loginUrl="order"+location.hash.split("order")[1],$.page("login"))):void($.checkAccessMenu("order")&&$.tipShow("请您打开微信登录'9358'公众号！"))}).Delegate("click",".reminder",function(e,t){var r=$(t.parentNode);_[r.Attr("clubid")]?l(_[r.Attr("clubid")]):$.ajax({url:($.$.clubID?"../":"")+"../club/"+r.Attr("clubid")+"/clubName",type:"get",data:{},success:function(e){_[r.Attr("clubid")]=e.telephone,l(e.telephone)}})}).Delegate("click",".inquiries",function(e,t){var r=($(t),$(t.parentNode)),a=r.Attr("techId");if(a)$.sessionStorage("order_data",I.Html()),$.sessionStorage("order_page",m),$.sessionStorage("order_page_height",J),$.sessionStorage("order_end",S),$.sessionStorage("order_ID",JSON.stringify(f)),$.sessionStorage("order_top",b[0].scrollTop),$.page("chat&techId="+a+("9358"==$.$.visitChannel?"&clubId="+r.Attr("clubId"):""));else{var d=$(t.parentNode);_[d.Attr("clubid")]?(l(_[d.Attr("clubid")]),$.hideOrderMenu()):$.ajax({url:($.$.clubID?"../":"")+"../club/"+d.Attr("clubid")+"/clubName",type:"get",data:{},success:function(e){_[d.Attr("clubid")]=e.telephone,l(e.telephone),$.hideOrderMenu()}})}}).Delegate("click",".comment",function(e,t){a(),$.page("orderDetail&id="+(t.parentNode.getAttribute("orderId")||t.parentNode.parentNode.getAttribute("orderId")))}).Delegate("click",".refund",function(e,t){var r=$(t.parentNode);O||(O=!0,$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/refund/applyfor",type:"post",data:{bizId:r.Attr("orderid"),businessChannel:"link",clubId:r.Attr("clubid"),tradeChannel:"wx",tradeYear:r.Attr("tradeyear")||(new Date).getFullYear(),userId:$.$.userID},success:function(e){if(O=!1,200==e.statusCode){$.hideOrderMenu(),$("#refundDialog>div>p:nth-of-type(2)").Text("您的退款申请已提交，退款将在3个工作日内退回支付账号。"),$("#refundDialog").ClassClear("hide");var t=($('div[orderid="'+r.Attr("orderid")+'"][tradeyear]'),$('div[orderid="'+r.Attr("orderid")+'"][tradeyear] > a.refund[orderid="'+r.Attr("orderid")+'"]'));$('div[orderid="'+r.Attr("orderid")+'"][tradeyear] > div:nth-of-type(1) > span:nth-of-type(2)').Text(M.refund.name),t.ClassClear("refund"),t.Class("refunded"),t.Text("查询")}else $.tipShow(e.msg||"退款不成功，请重试！")},error:function(){O=!1,$.tipShow("error")}}))}).Delegate("click",".refunded",function(e,t){var r=$(t.parentNode);O||(O=!0,$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/refund/applyfor",type:"post",data:{bizId:r.Attr("orderid"),businessChannel:"link",clubId:r.Attr("clubid"),tradeChannel:"wx",tradeYear:r.Attr("tradeyear")||2016,userId:$.$.userID},success:function(e){O=!1,200==e.statusCode?($("#refundDialog>div>p:nth-of-type(2)").Text(e.msg),$("#refundDialog").ClassClear("hide"),$.hideOrderMenu()):$.tipShow(e.msg||"查询失败，请重试！")},error:function(){O=!1,$.tipShow("error")}}))}).Delegate("click",".expandBtn",function(e,t){for(var r=$(t),a=t;"DIV"!=a.tagName;)a=a.previousSibling;a=$(a).Children().Index(3),r.ClassHave("expand")?(r.ClassClear("expand"),r.Text("展开"),a.CSS({display:"none"})):(r.Class("expand"),r.Text("收起"),a.CSS({display:"block"}))}).Delegate("click",".reAppoint",function(e,t){var r=$(t.parentNode),a="&orderId="+r.Attr("orderid")+"&clubId="+r.Attr("clubid")+"&downPayment="+r.Attr("downpayment")+"&customerName="+encodeURIComponent(r.Attr("customername"));r.Attr("itemid")&&(a+="&itemId="+r.Attr("itemid")),r.Attr("techid")&&(a+="&techId="+r.Attr("techid")),$.page("confirmOrder"+a)}),N.Event("touchmove",function(e){e.preventDefault()},!1),N.Click(function(e,t){e.target==t&&(N.ClassClear("active"),$.showOrderMenu())}),N.Delegate("click",">div>div:not(:last-child)",function(e,t){location.href="tel:"+t.innerHTML}).Delegate("click",">div>div:last-child",function(e,t){N.ClassClear("active"),$.showOrderMenu()}),$("#refundDialog>div>div").Event("click",function(){$("#refundDialog").Class("hide"),$.showOrderMenu()}),$("#refundDialog").Event("touchmove",function(e){e.preventDefault()}),D.Event("click",function(e){e.preventDefault()}),D.Event("touchmove",function(e){e.preventDefault()}),$("#reAppointDlg>div>div>div:nth-of-type(1)").Event("click",function(e,t){x.Class("hide"),$.showOrderMenu()}),$("#reAppointDlg>div>div>div:nth-of-type(2)").Event("click",function(e,t){var r=$(t).Attr("orderid");$('#content>div>div:nth-of-type(2)>div[orderid="'+r+'"] .reAppoint')[0].click(),$.showOrderMenu()}),b.Event("scroll",function(t){!S&&b[0].scrollTop+b[0].clientHeight-(m+P-1)*J>=0&&e()}),w){m=parseInt(T),I.Html(w);var U=$.sessionStorage("order_submitID");if(U){var B=$('div[orderId="'+U+'"]');1==B.length&&4==B[0].children[1].children.length&&(B[0].children[1].children[3].style.display="none")}setTimeout(function(){b[0].scrollTop=A},1),d(),S&&C.ClassClear("none"),E&&$.param("targetid")?($('.paid[orderid="'+$.param("targetid")+'"]')[0].click(),setTimeout(function(){$.pageSwitch()},1e3)):$.pageSwitch()}else e(1,function(){$.pageSwitch()});$.sessionStorageClear("order_ID"),$.sessionStorageClear("order_data"),$.sessionStorageClear("order_end"),$.sessionStorageClear("order_top"),$.sessionStorageClear("order_page"),$.sessionStorageClear("order_submitID"),$.sessionStorageClear("order_submitStr"),$.sessionStorageClear("order_page_height"),$.sessionStorageClear("unpaidDatas"),H&&E&&$.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:$.$.payAuthCode,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"order-list"},success:function(e){if(200==e.statusCode)$.localStorageClear("order-list-param"),s({id:H.bizId,downPayment:H.downPayment,clubId:H.clubId});else{if("935801"!=e.statusCode)return $.tipShow(e.msg||"获取openId失败！"),$.pageCancel();$.getOauthCode("&targetid="+H.bizId,"9358","order-list","base")}}})}();