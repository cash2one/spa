!function(){function e(){f?$.ajax({url:($.$.clubID?"..":"")+"/technician/"+f,data:{needServiceInfo:"N"},success:function(e){return e.id?(ge.currChatTech=oe={chatId:e.emchatId,name:e.info.name||$.$.defaultTechName,header:e.info.avatarUrl||$.$.defaultHeader,avatar:e.info.avatar,clubId:e.info.clubId,clubName:e.clubName,techId:e.info.id,inviteCode:e.info.inviteCode,no:e.info.serialNo||"",appointment:e.appointment,phoneAppointment:e.phoneAppointment,telephone:e.telephone,chatName:pe,chatHeader:ue,appointType:e.appointType},"y"==(e.isFavorite||"n").toLowerCase()&&$("div#title>i:nth-of-type(1)").Class("collected"),S="true"===e.hasInnerProvider,t(),void 0):($.tipShow(e.msg||"未能获取技师的信息！"),$.pageCancel())},error:function(){return $.tipShow("未能获取技师的信息，技师可能已离开会所！"),$.pageCancel()}}):ge.currChatTech&&ge.currChatTech.chatId?($("#tip").Hide(),$("div#title>i:nth-of-type(1)").Hide(),z.Hide(),$("#chatInput>div:nth-of-type(2)>div.reward").Hide(),oe=ge.currChatTech,ie=!0,t()):$.page("message",-1,!0)}function t(){function e(){return""==E[0].innerHTML?void $.tipShow("当前无积分礼物可发送！"):(H.ClassHave("active")?(A.className="",J.className="",_.ClassClear("active"),H.ClassClear("active")):(l("gift"),A.className="popExpression",J.className="popExp",_.Class("active"),H.Class("active")),void o())}function t(e){var t,a=ge.msgList[oe.chatId].list;for(t=a.length-1;t>=0;t--)if(a[t].msgType&&"diceGame"==a[t].msgType&&a[t].gameId==e&&"request"==a[t].gameStatus){a[t].gameStatus="handled",$.localStorage($.$.userID+"_MsgList_"+oe.chatId,JSON.stringify(ge.msgList[oe.chatId]));break}}var r=$.localStorage($.$.userID+"_isChatThisDay_"+oe.chatId);J.addEventListener("touchmove",function(e){e.preventDefault()},!1),C=new IScroll("#message-list-wrapper",{probeType:1,tap:!0,click:!1,preventDefaultException:{tagName:/.*/},mouseWheel:!0,scrollbars:!0,fadeScrollbars:!0,interactiveScrollbars:!1,keyBindings:!1,deceleration:2e-4,startY:parseInt(W)*-1}),C.on("scrollStart",function(){B=!0}),C.on("scroll",function(){B=!0,this.y>=5&&"flip"!=V.className?(V.className="flip",V.querySelector("span").innerHTML="松开之后刷新..."):this.y<=5&&"flip"==V.className&&(V.className="",V.querySelector("span").innerHTML="加载更多...")}),C.on("scrollEnd",function(){setTimeout(function(){B=!1},100),"flip"==V.className&&(V.className="loading",V.querySelector("span").innerHTML="加载更多...",u())}),$("#title>div:nth-of-type(1)").Html(oe.name+(oe.no?"<span>["+oe.no+"]</span>":""));var h=500,y=$.$.winHeight;N.Event("focus",function(){0==N.Html().length&&(D.style.display="none"),setTimeout(function(){o(!1)},300),X=!0,$.$.ua.isiPhone?setTimeout(function(){M[0].scrollIntoView(!0),h=300},h):setTimeout(function(){y-$.$.winHeight<100&&N[0].scrollIntoView(!0)},500),H.ClassHave("active")&&e()}),D.onclick=function(){D.style.display="none",N[0].focus()},N.Event("blur",function(){0==N.Html().replace(/<br>/,"").length&&(N[0].innerHTML="",D.style.display="block",x[0].className="disabled"),X=!1,setTimeout(function(){$("#content")[0].scrollIntoView()},300)}),N.Event("input",function(){0==N.Html().length?"disabled"!=x[0].className&&(x[0].className="disabled"):"disabled"==x[0].className&&(x[0].className="");var e=window.getSelection();q.node=e.focusNode,q.offset=e.focusOffset}),N.Event("click",function(t){if("img"==t.target.tagName.toLowerCase()){for(var a,i=t.target,s=i.parentNode,n=0;n<s.childNodes.length;n++)if(i==s.childNodes[n]){a=n+1;break}document.createRange&&window.getSelection&&a&&g(s,a)}var c=window.getSelection();q.node=c.focusNode,q.offset=c.focusOffset,H.ClassHave("active")&&(e(),N[0].focus())}),x.Event("click",function(e,t){if(D.style.display="none","disabled"!=t.className){var a=E[0].querySelector("div.active");if(_.ClassHave("active")&&a){var i=(a.getAttribute("gift-integral")||0)-0;i>0?$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(e){200==e.statusCode&&(e=e.respData,b=e&&e[0]?e[0].amount:0,ee.Text(b),parseInt(b)<=0||i&&parseInt(i)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("发送礼物需要"+(i||"")+"积分，当前您的积分不足。"),K.Class("active"),N[0].innerHTML="",x[0].className="disabled",a.className="gift-item"):d(a,i))}}):d(a,i)}else{var s=N[0].innerHTML.replace(/<\/div>/g,"").replace(/<div>/g,"<br/>");j.innerHTML=s;for(var n,c=j.getElementsByTagName("img"),r=c.length,l=r-1;l>=0;l--)n=document.createTextNode(c[l].getAttribute("data-exp")),j.replaceChild(n,c[l]);if(j.innerHTML.length>1e3)return $.tipShow("您输入的太多了，无法发送！");j.innerHTML.length!=4*r&&N[0].focus();var u=document.createElement("div");u.className="right",u.innerHTML+="<span>"+$.formatMsgTime(Date.now(),!0)+"</span><div style='background-image: url("+ue+")'></div><div>"+s+"</div>",L.appendChild(u),o(),N[0].innerHTML="",x[0].className="disabled";var p={from:ge.userId,to:oe.chatId,data:j.innerHTML,ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId}},m=setTimeout(function(){p.status="0",$.updateSessionList(p,"text",!1),$.addToMsgList(p,"text")},5e3);ge.conn.send({to:oe.chatId,msg:j.innerHTML,type:"chat",ext:{name:pe,header:ue,time:Date.now(),avatar:$.$.userAvatar},success:function(){u.querySelector("div:nth-of-type(2)").classList.add("success"),clearTimeout(m),p.status="1",$.updateSessionList(p,"text",!1),$.addToMsgList(p,"text"),$.sendFriend(oe.chatId,"text",ie?"manager":"tech")}}),q.node=N[0],q.offset=0,$.$.ua.isiPhone&&setTimeout(function(){o()},800)}}}),$.scroll({content:U[0],contentX:U.Children()[0],indexX:P-1,endX:function(e){P=e+1,O.ClassClear("active"),O.Index(P-1).Class("active")}}),M.Click(function(){M.ClassHave("active")?(A.className="",J.className="",M.ClassClear("active"),U.Class("hide")):(l("expression"),U.ClassClear("hide"),A.className="popExpression",J.className="popExp",q.offset=N[0].childNodes.length,q.node=N[0],M.Class("active")),o()}),U.Delegate("click","li",function(e,t){if(q.node&&p(q.node)){var a,i,s,n,c,r,d,l=t.children[0];i=document.createElement("img");var o=window.getComputedStyle(l,null).backgroundImage;if(o='"'==o.charAt(4)||"'"==o.charAt(4)?o.slice(5,-2):o.slice(4,-1),i.src=o,i.setAttribute("data-exp",l.getAttribute("data-exp")),3==q.node.nodeType?(a=q.node,0==q.offset?a.parentNode.insertBefore(i,a):q.offset==a.nodeValue.length?a.nextSibling?a.parentNode.insertBefore(i,a.nextSibling):a.parentNode.appendChild(i):(n=a.nodeValue,a.nodeValue=n.substr(0,q.offset),c=a.nextSibling,c?(a.parentNode.insertBefore(i,c),d=document.createTextNode(n.substr(q.offset)),a.parentNode.insertBefore(d,c)):(a.parentNode.appendChild(i),d=document.createTextNode(n.substr(q.offset)),a.parentNode.appendChild(d)))):1==q.node.nodeType&&(q.offset==q.node.childNodes.length?q.node.appendChild(i):(s=q.node.childNodes[q.offset],q.node.insertBefore(i,s))),""!=N[0].innerHTML?(D.style.display="none",x[0].className=""):(D.style.display="block",x[0].className="disabled"),document.createRange){for(var u=i.parentNode,m=0;m<u.childNodes.length;m++)if(u.childNodes[m]==i){r=m+1;break}r&&(X?g(u,r):(q.offset=r,q.node=u))}}}),E.Delegate("click","div",function(e,t){var a=$(t),i=t.getAttribute("gift-name");i&&(a.ClassHave("active")?(a.ClassClear("active"),D.style.display="block",N[0].innerHTML="",x[0].className="disabled"):(R.ClassClear("active"),a.Class("active"),D.style.display="none",N[0].innerHTML="[礼物："+i+"]",x[0].className=""))}),_.Click(function(){e()}),$("#chatInput input#uploadImg").Event("change",function(e,t){if(l("pic"),ge.conn){var a=t.files[0];if(a.size>10485760)return $.tipShow("抱歉！所选图片超过10M，太大无法发送！");var i=a.name.lastIndexOf(".");if(i<0)return;var s=a.name.substring(i+1);if(!/^(jpg|jpeg|gif|png|bmp)$/i.test(s))return $.tipShow("请选择图片进行发送！");var n=Easemob.im.Helper.getFileUrl("uploadImg");if(!n.url||0==n.url.length)return;var c=document.createElement("div");c.className="right",c.innerHTML="<span>"+$.formatMsgTime(new Date,!0)+"</span><div style='background-image: url("+ue+")'></div><div class='img'><img /></div>";var r=c.children[2].children[0];r.src=window.URL.createObjectURL(a),r.onload=function(){window.URL.revokeObjectURL(this.src),r.setAttribute("w",this.width),r.setAttribute("h",this.height);var e,t=this.width,i=this.height,s=this.width/(16*$.$.scale),d=this.height/(16*$.$.scale);s<10&&d<9||(s=this.width/10,d=this.height/9,e=s>d?s:d,s=this.width/e,d=this.height/e),r.style.width=s+"rem",r.style.height=d+"rem",L.appendChild(c),o(),ge.conn.send({file:n,to:oe.chatId,type:"img",width:t,height:i,file_length:a.size,onFileUploadComplete:function(e){$.tipShow("图片发送成功！"),$.sendFriend(oe.chatId,"image",ie?"manager":"tech"),r.onload=null,r.src=e.uri+"/"+e.entities[0].uuid,c.querySelector("div:nth-of-type(2)").classList.add("success");var a={from:ge.userId,to:oe.chatId,url:e.uri+"/"+e.entities[0].uuid,width:t,height:i,status:1,ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId}};$.updateSessionList(a,"pic",!1),$.addToMsgList(a,"pic")},onFileUploadError:function(e){$.tipShow("图片发送失败，请稍后重试！"+JSON.stringify(e))},ext:{name:pe,header:ue,time:Date.now(),avatar:$.$.userAvatar}})}}});var S=null,w=$("#title>i:nth-of-type(1)>span");$("#title>i:nth-of-type(1)").Click(function(e,t){var a="collected"==t.className;S&&(clearTimeout(S),w.CSS("display","none"),w.ClassClear("active")),$.ajax({url:($.$.clubID?"../":"")+"../profile/user/favorite/"+(a?"delete":"create"),data:{id:oe.techId},success:function(){t.className=a?"":"collected",a?w.Text("已取消"):w.Text("已收藏"),w.CSS("display","block"),w.Class("active"),S=setTimeout(function(){w.CSS("display","none"),w.ClassClear("active")},1100)}})}),f?$("#title>i:nth-of-type(2)").Click(function(){history.replaceState&&history.replaceState(null,document.title,location.search+location.hash.toString().replace(new RegExp("technicianDetail&id="+f+"[^/]*/"),"")),$.page("technicianDetail&id="+f)}):($("#title>i:nth-of-type(2)").CSS("display","none"),$("#title>i:nth-of-type(3)").CSS("right",".667rem")),$("#title>i:nth-of-type(3)").Click(function(){$.$.clubID?$.page("home",-1,!0):location.href=location.origin+location.pathname+"?club="+oe.clubId});var k=$("#telDetail"),F=$("#tip"),Y="",G=oe.telephone.split(",");if(oe.appointType&&F.Class("active"),""!=oe.telephone)for(T=0;T<G.length;T++)Y+="<div>"+G[T]+"</div>";k[0].querySelector("div").innerHTML=Y+"<div>取消</div>",k.Event("touchmove",function(e){e.preventDefault()},!1),k.Click(function(e,t){e.target==t&&k.ClassClear()});var se=$("#telDetail>div>div"),he=se.Remove(se.length-1);se.Click(function(e,t){location.href="tel:"+t.innerHTML}),he.Click(function(){k.ClassClear()}),$("#chatInput>div:nth-of-type(2)>div.reward").Click(function(){return le?(l("reward"),void($.$.ua.isWX?$.login("techReward&techId="+f+"&backPublic=true"):$.checkAccessMenu("techReward")&&$.tipShow('请打开微信登录"9358"公众号！'))):$.tipShow("会所关闭了打赏！")}),F.Click(function(){F.ClassHave("active")?"phone"==oe.appointType?""==oe.telephone?$.tipShow("暂无预约电话！"):k.ClassHave("active")?k.ClassClear("active"):k.Class("active"):"paid"==oe.appointType||"paid_full"==oe.appointType?$.$.ua.isWX?(history.replaceState&&history.replaceState(null,document.title,location.search+location.hash.toString().replace(new RegExp("technicianDetail&id="+f+"[^/]*/"),"")),$.page("technicianDetail&id="+f)):$.checkAccessMenu("confirmOrder")&&$.tipShow("【此会所需支付预约，请在微信中打开】"):"appoint"==oe.appointType?$.login("confirmOrder&techId="+f+"&backChat=true"+("9358"==$.$.visitChannel?"&clubId="+I:""),!1,!0,!0):$.tipShow("此会所不支持线上预约。"):$.tipShow("抱歉！当前技师不可预约！")}),$("#chatInput>div:nth-of-type(2)>div.dice").Click(function(){l("dice"),n()}),Q.Click(function(e,t){Q.ClassClear("active"),te=t.innerHTML+"",t.className="active"}),$("#diceSetting div.cancel").Click(function(){Z.ClassClear("active")}),$("#diceSetting div.invite").Click(function(){Z.ClassClear("active"),s()}),$("#notEnoughTip div.cancel").Click(function(){K.ClassClear("active")}),$("#notEnoughTip div.get").Click(function(){$.page("integralExplain")}),$.addMsgDiv=function(e,a,i,s,n){if(e){var c,r=document.createElement("div");if(a=a||e.type||"text",e.ext&&e.ext.msgType){var d=e.ext;e.msgType=d.msgType,"oneYuan"!=e.msgType&&"plumFlower"!=e.msgType&&"journal"!=e.msgType&&"timeLimit"!=e.msgType&&"luckyWheel"!=e.msgType||(e.actId=d.actId,e.techCode=e.techCode||d.techCode),"ordinaryCoupon"==e.msgType&&(e.userActId=e.userActId||d.userActId,e.groupmessageId=e.groupmessageId||d.groupmessageId)}if("paidCouponTip"==e.msgType||"couponTip"==e.msgType)r.className="center "+e.msgType,r.innerHTML="<div>"+$.formatMsgTime(e.time||new Date,!0)+"</div><span><i></i>"+e.data+"<a>点击查看</a></span>";else if("diceGame"==e.msgType){var l=e.gameStatus||e.ext.gameStatus,u=e.gameInvite||e.ext.gameInvite,p=e.gameId||e.ext.gameId;if(r.setAttribute("gameId",p),"handled"==l)r=null;else if("over"!=l)u==ge.userId?(c=document.querySelector("#"+p+"_invite"),c&&(L.removeChild(c),t(p)),"request"==l&&(r.setAttribute("id",p+"_invite"),e.time&&Date.now()-e.time>ne&&(l="overtime")),r.className="right dice-invite",r.innerHTML="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span>                                                      <div style='background-image: url("+ue+")'></div>                                                      <div class='"+(1==(e.status||1)?"success":"")+"'>                                                           <h4>邀请"+oe.name+"玩骰子<span>"+e.data+"积分</span></h4>                                                          <div>                                                             <div class='other'><div>"+oe.name+"</div>"+("<div gameId="+p+" class='"+("request"==l?"wait":"reject")+"'>"+ae[l]+("request"==l?"<a class='cancel dice-game'>取消</a>":"")+"</div>")+"</div>                                                             <div class='dice'></div>                                                             <div class='mine'><div>"+$.$.userName+"</div><div style='background-image: url("+ue+")'></div></div>                                                          </div>                                                      </div>                                                     <div class='"+("reject"==l||"cancel"==l||"overtime"==l?"":"hide")+"'><span>"+("reject"==l?"对方拒绝游戏":"cancel"==l?"游戏已取消":"游戏超时")+"，返还"+e.data+"积分</span></div>"):(c=document.querySelector("#"+p+"_request"),c&&("cancel"==c.getAttribute("gameStatus")?r=null:L.removeChild(c),t(p)),r&&("request"==l&&e.time&&Date.now()-e.time>ne&&(l="overtime"),r.id=p+"_request",r.className="left dice-request",r.setAttribute("gameStatus",l),r.innerHTML="<span>"+$.formatMsgTime(e.time||Date.now(),!0)+"</span>                                                            <div style='background-image: url("+oe.header+")'></div>                                                            <div>                                                                <div>                                                                    <div>"+oe.name+"邀请您玩骰子"+("request"!=l?"<span>("+ae[l]+")</span>":"")+"</div>                                                                    <div>比大小，每局胜方将获得负方"+e.data+"积分</div>                                                                </div>                                                                <div gameId='"+p+"' class='"+("request"!=l?"disabled":"")+"'><div class='reject dice-game'>拒绝</div><div class='accept dice-game'>接受</div></div>                                                            </div>"));else{var g=e.gameResult||e.ext.gameResult,h=u==ge.userId;g=g.split(":");var f=h?g[0]>g[1]:g[0]<g[1],I=h?g[1]:g[0],T=h?g[0]:g[1];r.className="right dice-result"+(e.ext?"":" show"),r.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span>                                                                <div style='background-image: url("+ue+")'></div>                                                                <div class='success'>                                                                    <div class='left'><div>"+oe.name+"</div><div class='"+(f?"":"act")+"'><img src='img/chat/dice/dice"+I+(e.ext?".gif":".png")+"'/></div></div>                                                                    <div class='right'><div class='"+(f?"victory":"failure")+"'>"+pe+"</div><div class='"+(f?"act":"")+"'><img src='img/chat/dice/dice"+T+(e.ext?".gif":".png")+"'/></div><span>"+(f?"+":"-")+e.data+"</span></div>                                                                    <div class='split'><i>vs</i></div>                                                                </div>                                                                <div><span>"+(f?"获取":"消费")+e.data+"积分，<a amount='"+e.data+"' class='dice-game-tip'>再玩一局</a></span></div>",e.ext&&setTimeout(function(){f&&v();var e=r.querySelectorAll("img");e[0].src=e[0].src.slice(0,-3)+"png",e[1].src=e[1].src.slice(0,-3)+"png",r.classList.add("show")},2100)}}else if("gift"==e.msgType){var y=ce[e.giftId||e.ext.giftId];y=y?y.url||re:re,r.className="right gift",r.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span><div style='background-image: url("+ue+")'></div><div "+(1==(e.status||1)?"class='success'":"")+"><img gift='true' src='"+y+"'/></div>"}else if("oneYuan"==e.msgType||"plumFlower"==e.msgType||"timeLimit"==e.msgType||"luckyWheel"==e.msgType||"journal"==e.msgType){r.className="left activity";var C=e.from==ge.userId?ue:oe.header;r.innerHTML="<span>"+$.formatMsgTime(e.time||new Date,!0)+'</span><div style="background-image: url('+C+')"></div><div class="'+e.msgType+'" actid="'+e.actId+'"><div><div></div><div><div>'+(de[e.msgType]?de[e.msgType].title:"消息类型不存在")+"</div><div>"+(de[e.msgType]?de[e.msgType].subTitle:"消息类型不存在")+"</div></div></div></div>"}else{r.className=e.from==ge.userId?"right":"left";var C=e.from==ge.userId?ue:oe.header;"paidCoupon"==e.msgType&&(e.actId=e.actId||e.ext.actId,e.techCode=e.techCode||e.ext.techCode);var b="right"==r.className&&1==(e.status||1)?"success":"";if("text"==a){if("ordinaryCoupon"==e.msgType&&!e.userActId){var S=e;e.ext&&(S=e.ext),r.setAttribute("actId",S.actId||""),r.setAttribute("techCode",S.techCode||""),r.setAttribute("groupmessageId",S.groupmessageId||""),r.setAttribute("msgTime",e.time)}r.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span><div style='background-image: url("+C+")'></div><div class='"+(e.msgType||"")+" "+b+"' "+("paidCoupon"==e.msgType?"actId='"+e.actId+"' techCode='"+e.techCode+"'":"ordinaryCoupon"==e.msgType&&e.userActId?"userActId='"+e.userActId+"'":"")+">"+m(e.data)+"</div>"}else if("pic"==a){var w,N=e.width/(16*$.$.scale),x=e.height/(16*$.$.scale);N<10&&x<9||(N=e.width/10,x=e.height/9,w=N>x?N:x,N=e.width/w,x=e.height/w),r.innerHTML+="<span>"+$.formatMsgTime(e.time||new Date,!0)+"</span><div style='background-image: url("+C+")'></div><div class='img "+b+"'><img "+(1==n?"data-":"")+"src='"+e.url+"' style='width:"+N+"rem;height:"+x+"rem' w='"+e.width+"' h='"+e.height+"'/></div>"}}r&&(0==L.children.length||1!=i?L.appendChild(r):L.insertBefore(r,L.children[0])),0!=s&&o()}},$.pageSwitch(!0),$.ajax({url:"../api/v2/credit/switch/status",isReplaceUrl:!0,data:{clubId:I},success:function(e){e=e.respData,e&&"on"==e.clubSwitch?("on"!=e.diceGameSwitch||ie||($("#chatInput>div:nth-of-type(2)>div.dice").Show(),ne=1e3*e.gameTimeoutSeconds),ie||_.Show(),$.ajax({url:"../api/v2/credit/gift/list",isReplaceUrl:!0,success:function(e){if(e=e.respData){var t,a="";for(t=0;t<e.length;t++)ce[e[t].id]={url:e[t].gifUrl},a+="<div class='gift-item' gift-id='"+e[t].id+"' gift-name='"+e[t].name+"' gift-integral = '"+e[t].ratio+"' gift-url='"+e[t].gifUrl+"'>                                                                <i></i>                                                                <img src='"+e[t].iconUrl+"'/>                                                                <div><span>"+e[t].ratio+"</span>积分</div>                                                            </div>";E[0].innerHTML=a,E.CSS("width",5*e.length+"rem"),R=$("#chatInput>div.gift-list>div.list>div>div.gift-item")}i(r)}}),a()):i(r)}}),$.ajax({url:"../api/v2/user/reward/isRewardOn",data:{clubId:I},isReplaceUrl:!0,success:function(e){200==e.statusCode&&(le=e.respData)}}),$(L).Event("click",function(e){var t=e.target,a=t.parentNode,i=a.parentNode;if(/(paidCoupon|begReward|ordinaryCoupon|dice-game|dice-game-tip|oneYuan|plumFlower|timeLimit|luckyWheel|journal)/.test(a.className)&&(t=a),"img"!=t.tagName.toLowerCase()||/dice/.test(t.src)||t.getAttribute("gift")){if(/paidCoupon/.test(t.className))$.$.userTel?$.page("paidCoupon&actId="+t.getAttribute("actId")+"&techCode="+t.getAttribute("techCode")+"&chanel=link"):($.$.loginUrl=location.hash.substring(1).replace(/^\//,"").replace(/\/$/,""),$.bindPhone(!0));else if(/begReward/.test(t.className))$("#chatInput>div:nth-of-type(2)>div.reward")[0].click();else if(/ordinaryCoupon/.test(t.className))if(a=t.parentNode,t.getAttribute("userActId"))$.page("couponDetail&userActId="+t.getAttribute("userActId"));else if(a.getAttribute("groupmessageId"))$.page("coupon");else if($.$.userTel){if(me)return void $.tipShow("领取优惠券中，请稍后...");me=!0,$.ajax({url:"../api/v2/club/get/redpacket",isReplaceUrl:!0,data:{actId:a.getAttribute("actId"),phoneNum:$.$.userTel,openId:$.$.openId,userCode:"",techCode:a.getAttribute("techCode")||"",chanel:"link",groupMessageId:a.getAttribute("groupmessageId")||""},success:function(e){var i;if(200==e.statusCode&&e.respData&&e.respData.userActId){i=e.respData.userActId;var s=t.querySelector("span").innerHTML+"元"+t.querySelector("i").innerHTML;t.setAttribute("userActId",i);var n={from:ge.userId,to:oe.chatId,data:"您领取了"+oe.name+'的"'+s+'"',ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId,msgType:"couponTip"},status:1};ge.conn.send({to:oe.chatId,msg:s,type:"chat",ext:{name:pe,header:ue,msgType:"couponTip",time:Date.now()},success:function(){var e,t,s=ge.msgList[oe.chatId].list;for(e=s.length-1;e>=0;e--)if(s[e].msgType&&"ordinaryCoupon"==s[e].msgType&&s[e].time==a.getAttribute("msgTime")){t=s[e];break}t&&(t.userActId=i),$.sendFriend(oe.chatId,"tech",ge.userId,"user"),$.addMsgDiv(n,"couponTip",!1,!0,!1),$.updateSessionList(n,"text",!1),$.addToMsgList(n,"text")}})}else $.tipShow(e.msg||"未能成功领取！");me=!1}})}else $.$.loginUrl=location.hash.substring(1).replace(/^\//,"").replace(/\/$/,""),$.bindPhone(!0);else if(/dice-game-tip/.test(t.className))return n(t.getAttribute("amount")),!0}else t.getAttribute("data-exp")||($.param("imgScan","true"),$.$.lastScanImgParent=a,$.$.scanimg.showImg(t));if(/center/.test(a.className)?t=a:/center/.test(i.className)&&(t=i),/center/.test(t.className)&&$.page("coupon"),a=t.parentNode,/dice-game/.test(t.className)&&"disabled"!=a.className){var s,r,d=ge.msgList[oe.chatId].list;for(s=d.length-1;s>=0;s--)if(d[s].msgType&&"diceGame"==d[s].msgType&&d[s].gameId==a.getAttribute("gameId")){r=d[s];break}if(r){var l=t.className.split(" ")[0];"cancel"==l?c(l,r,a):(a.className="disabled","accept"==l?$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(e){200==e.statusCode?(e=e.respData,b=e&&e[0]?e[0].amount:0,ee.Text(b),parseInt(r.data)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("玩骰子需要"+r.data+"积分，当前您的积分不足。"),K.Class("active"),a.className=""):c(l,r,a.parentNode.children[0].children[0])):$.tipShow("请求异常！")}}):c(l,r,a.parentNode.children[0].children[0]))}}}),$("#message-list-wrapper").Delegate("click",".activity>.timeLimit",function(e,t){var a=t.getAttribute("actid");a&&"undefined"!==a?$.$.clubID?$.page("robProjectDetail&robProjectId="+a):($.sessionStorage("curr_chat_tech",JSON.stringify(ge.currChatTech)),location.href=location.origin+location.pathname+"?club="+I+"#robProjectDetail&robProjectId="+a):$.tipShow("无活动ID")}).Delegate("click",".activity>.oneYuan,.activity>.plumFlower",function(e,t){var a=t.getAttribute("actid"),i=$(t).ClassHave("oneYuan");a&&"undefined"!==a?$.$.clubID?i?$.page("oneYuanDetail&oneYuanId="+a):$.page("plumflowers&id="+a):($.sessionStorage("curr_chat_tech",JSON.stringify(ge.currChatTech)),i?location.href=location.origin+location.pathname+"?club="+I+"#oneYuanDetail&oneYuanId="+a:location.href=location.origin+location.pathname+"?club="+I+"#plumflowers&id="+a):$.tipShow("无活动ID")}).Delegate("click",".activity>.luckyWheel",function(e,t){var a=t.getAttribute("actid");a&&"undefined"!==a?location.href=location.origin+"/spa-manager/luckyWheel/?actId="+a+"&clubId="+I:$.tipShow("无活动ID")}).Delegate("click",".activity>.journal",function(e,t){var a=t.getAttribute("actid");a&&"undefined"!==a?location.href=location.origin+"/spa-manager/journal/?id="+a:$.tipShow("无期刊ID")}),oe.techId&&$.ajax({url:"../api/v1/profile/redpack/list",isReplaceUrl:!0,data:{clubId:oe.clubId},success:function(e){if(200==e.statusCode){var t,e=e.respData.coupons||[],a="";for(t=0;t<e.length;t++)a+="paid"==e[t].couponType?t==e.length-1?"<li type='paid' actId='"+e[t].actId+"'>"+(e[t].actTitle.length>7?e[t].actTitle.substr(0,7)+"...":e[t].actTitle)+"<i></i><i></i></li>":"<li type='paid' actId='"+e[t].actId+"'>"+e[t].actTitle+"</li>":t==e.length-1?"<li type='"+e[t].couponType+"' actId='"+e[t].actId+"' techCode='"+oe.inviteCode+"' actTitle='"+e[t].actTitle+"'>"+(e[t].actTitle.length>7?e[t].actTitle.substr(0,7)+"...":e[t].actTitle)+"<i></i><i></i></li>":"<li type='"+e[t].couponType+"' actId='"+e[t].actId+"' techCode='"+oe.inviteCode+"' actTitle='"+e[t].actTitle+"'>"+e[t].actTitle+"</li>";z[0].querySelector("ul").innerHTML=a,e.length>0?(z.Click(function(){l("coupon"),z.ClassHave("active")?z.ClassClear("active"):z.Class("active")}),$("#chatInput>div:nth-of-type(2)>div.coupon>ul>li").Click(function(e,t){var a=t.getAttribute("type");if("paid"==a)$.login("paidCoupon&actId="+t.getAttribute("actId")+"&techCode="+oe.inviteCode,!1,!0,!0);else{if(!$.$.userTel)return $.$.loginUrl=location.hash.substring(1).replace(/^\//,"").replace(/\/$/,""),$.bindPhone(!0),!1;$.ajax({url:($.$.clubID?"../":"")+"get/redpacket",data:{actId:t.getAttribute("actId"),phoneNum:$.$.userTel,openId:$.$.openId,userCode:"",techCode:t.getAttribute("techCode")||"",chanel:"link"},success:function(e){if(200==e.statusCode){$.tipShow("成功领取一张优惠券！");var a={from:ge.userId,to:oe.chatId,data:"您领取了"+oe.name+'的"'+t.getAttribute("actTitle")+'"',ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId,msgType:"couponTip"},status:1};ge.conn.send({to:oe.chatId,msg:t.getAttribute("actTitle"),type:"chat",ext:{name:pe,header:ue,msgType:"couponTip",time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(oe.chatId,"coupon",ie?"manager":"tech"),$.addMsgDiv(a,"couponTip",!1,!0,!1),$.updateSessionList(a,"text",!1),$.addToMsgList(a,"text")}})}else $.tipShow(e.msg||"未能成功领取优惠券！")}})}})):z.Click(function(){l("coupon"),$.tipShow("抱歉！暂无优惠券！")})}}})}function a(){$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(e){200==e.statusCode&&(e=e.respData,b=e&&e[0]?e[0].amount:0,ee.Text(b))}})}function i(e){var t=$.getSessionList(!1),a=$.getMsgList(oe.chatId);if(t[oe.chatId]&&a.name){var i=t[oe.chatId]["new"],s=a.list.length;for(i<10&&(i=s>=10?10:s),T=a.list.length-1;T>=s-i;T--)$.addMsgDiv(a.list[T],null,!0,!1,!0);Y=T,$.showMsgNum(-t[oe.chatId]["new"]),t[oe.chatId]["new"]=0,$.localStorage($.$.userID+"_SessionList",JSON.stringify(t)),setTimeout(function(){o(!0,800)},200);var n=L.querySelectorAll("div>div.img>img");for(T=0;T<n.length;T++)n[T].getAttribute("data-src")&&(n[T].src=n[T].getAttribute("data-src"))}e===!0&&a.list&&0!=a.list.length||$.addMsgDiv({from:oe.chatId,to:ge.userId,type:"text",data:oe.clubName+"欢迎您！",time:Date.now()},"text",!0,!0)}function s(e){var t=(e||te)+"";parseInt(t)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("玩骰子需要"+t+"积分，当前您的积分不足。"),K.Class("active")):$.ajax({url:"../api/v2/credit/game/dice/submit",isReplaceUrl:!0,data:{clubId:I,amount:t,emchatId:oe.chatId},success:function(e){if(200==e.statusCode){var a=e.respData.gameId,i=document.createElement("div"),s=Date.now();i.className="right dice-invite",i.setAttribute("gameId","dice_"+a),i.setAttribute("id","dice_"+a+"_invite"),i.innerHTML+="<span>"+$.formatMsgTime(s,!0)+"</span>                                                                <div style='background-image: url("+ue+")'></div>                                                                <div>                                                                    <h4>邀请"+oe.name+"玩骰子<span>"+t+"积分</span></h4>                                                                    <div>                                                                        <div class='other'><div>"+oe.name+"</div><div class='wait' gameId='dice_"+a+"'>等待接受...<a class='cancel dice-game'>取消</a></div></div>                                                                        <div class='dice'></div>                                                                        <div class='mine'><div>"+$.$.userName+"</div><div style='background-image: url("+ue+")'></div></div>                                                                    </div>                                                                </div>                                                                <div class='hide'><span>对方拒绝游戏，返还"+t+"积分</span></div>",L.appendChild(i),o();var n={from:ge.userId,to:oe.chatId,data:t,ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId,msgType:"diceGame",gameInvite:ge.userId,gameStatus:"request",gameId:"dice_"+a,gameResult:"0:0"}},c=setTimeout(function(){n.status="0",$.updateSessionList(n,"diceGame",!1),$.addToMsgList(n,"diceGame")},5e3);ge.conn.send({to:oe.chatId,msg:t,type:"chat",ext:{name:pe,header:ue,time:s,avatar:$.$.userAvatar,msgType:"diceGame",gameStatus:"request",gameInvite:ge.userId,gameId:"dice_"+a,gameResult:"0:0"},success:function(){i.querySelector("div:nth-of-type(2)").classList.add("success"),clearTimeout(c),n.status="1",$.updateSessionList(n,"text",!1),$.addToMsgList(n,"text"),$.sendFriend(oe.chatId,"game",ie?"manager":"tech")}})}else $.tipShow(e.msg||"游戏创建失败！")}})}function n(e){$.ajax({url:"../api/v2/credit/user/account",isReplaceUrl:!0,data:{clubId:I,userType:"user"},success:function(t){200==t.statusCode&&(b=t.respData&&t.respData[0]?t.respData[0].amount:0,ee.Text(b),parseInt(b)<=0||e&&parseInt(e)>parseInt(b)?($("#notEnoughTip>div>div.tip").Text("玩骰子需要"+(e||"")+"积分，当前您的积分不足。"),K.Class("active")):e?s(e):Z.Class("active"))}})}function c(e,t,a){var i=e;if(+new Date-t.time>ne?(e="overtime",r(e,t)):$.ajax({url:"../api/v2/credit/game/dice/accept",isReplaceUrl:!0,data:{gameId:t.gameId.split("_")[1],status:e},success:function(i){200==i.statusCode?(i=i.respData,r(e,t,i)):($.tipShow(i.msg||"处理游戏操作异常！"),"accept"==e&&(e="overtime",a.querySelector("span").innerHTML="("+ae[e]+")",r(e,t)))}}),"cancel"==e||"cancel"==i){a.className="cancel",a.innerHTML=ae[e];var s=document.querySelector("#"+t.gameId+"_invite");s&&(s=s.querySelector("div.hide"),s.className="",s.innerHTML="<span>游戏已取消，"+s.innerHTML.split("，")[1])}else a.innerHTML+="<span>("+ae[e]+")</span>"}function r(e,t,a){if("overtime"==e?(t.gameStatus=e,$.localStorage($.$.userID+"_MsgList_"+oe.chatId,JSON.stringify(ge.msgList[oe.chatId]))):ge.conn.send({to:oe.chatId,msg:t.data,type:"chat",ext:{name:pe,header:ue,time:Date.now(),avatar:$.$.userAvatar,msgType:"diceGame",gameInvite:t.gameInvite,gameStatus:e,gameId:t.gameId,gameResult:"0:0"},success:function(){t.gameStatus=e,$.localStorage($.$.userID+"_MsgList_"+oe.chatId,JSON.stringify(ge.msgList[oe.chatId])),$.sendFriend(oe.chatId)}}),a&&"accept"==a.status){var i=t.gameId.split("_")[1],s=document.createElement("div"),n=Date.now(),c=a.dstPoint>a.srcPoint;s.className="right dice-result",s.innerHTML+="<span>"+$.formatMsgTime(n,!0)+"</span>                                                                <div style='background-image: url("+ue+")'></div>                                                                <div class='success'>                                                                    <div class='left'><div>"+oe.name+"</div><div class='"+(c?"":"act")+"'><img src='img/chat/dice/dice"+a.srcPoint+".gif'/></div></div>                                                                    <div class='right'><div class='"+(c?"victory":"failure")+"'>"+pe+"</div><div class='"+(c?"act":"")+"'><img src='img/chat/dice/dice"+a.dstPoint+".gif'/></div><span>"+(c?"+":"-")+a.belongingsAmount+"</span></div>                                                                    <div class='split'><i>vs</i></div>                                                                </div>                                                                <div><span>"+(c?"获取":"消费")+a.belongingsAmount+"积分，<a amount='"+a.belongingsAmount+"' class='dice-game-tip'>再玩一局</a></span></div>",
L.appendChild(s),o(),setTimeout(function(){c&&v();var e=s.querySelectorAll("img");e[0].src=e[0].src.slice(0,-3)+"png",e[1].src=e[1].src.slice(0,-3)+"png",s.classList.add("show")},2100);var r={from:ge.userId,to:oe.chatId,data:a.belongingsAmount+"",ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId,msgType:"diceGame",gameInvite:oe.chatId,gameStatus:"over",gameId:"dice_"+i,gameResult:a.srcPoint+":"+a.dstPoint}};ge.conn.send({to:oe.chatId,msg:a.belongingsAmount+"",type:"chat",ext:{name:pe,header:ue,time:n,avatar:$.$.userAvatar,msgType:"diceGame",gameStatus:"over",gameInvite:oe.chatId,gameId:"dice_"+i,gameResult:a.srcPoint+":"+a.dstPoint},success:function(){r.status="1",$.updateSessionList(r,"text",!1),$.addToMsgList(r,"text"),$.sendFriend(oe.chatId)}})}}function d(e,t){var i=document.createElement("div"),s=e.getAttribute("gift-name"),n=e.getAttribute("gift-id"),c=e.getAttribute("gift-url");i.className="right gift",i.innerHTML+="<span>"+$.formatMsgTime(Date.now(),!0)+"</span><div style='background-image: url("+ue+")'></div><div><img gift='true' src='"+c+"'/></div>",L.appendChild(i),N[0].innerHTML="",x[0].className="disabled",e.className="gift-item";var r={from:ge.userId,to:oe.chatId,data:"[礼物："+s+"]",ext:{name:oe.name,header:oe.header,avatar:oe.avatar,no:oe.no,techId:oe.techId,clubId:oe.clubId,msgType:"gift",giftValue:t,giftName:s,giftId:n}},d=setTimeout(function(){r.status="0",$.updateSessionList(r,"text",!1),$.addToMsgList(r,"text")},5e3);ge.conn.send({to:oe.chatId,msg:"[礼物："+s+"]",type:"chat",ext:{name:pe,header:ue,time:Date.now(),avatar:$.$.userAvatar,msgType:"gift",giftValue:t+"",giftName:s,giftId:n},success:function(){i.querySelector("div:nth-of-type(2)").classList.add("success"),clearTimeout(d),r.status="1",$.updateSessionList(r,"text",!1),$.addToMsgList(r,"text"),$.ajax({url:"../api/v2/credit/gift/send",isReplaceUrl:!0,data:{clubId:I,emchatId:oe.chatId,giftId:n,num:1},success:function(e){200==e.statusCode?a():$.tipShow(e.msg||"礼物发送失败！")}}),$.sendFriend(oe.chatId,"text",ie?"manager":"tech")}}),q.node=N[0],q.offset=0,o()}function l(e){"expression"!=e&&(A.className="",J.className="",M.ClassClear("active"),U.Class("hide")),"coupon"!=e&&z.ClassClear("active"),"gift"!=e&&(A.className="",J.className="",_.ClassClear("active"),H.ClassClear("active"),$("#chatInput>div.gift-list>div.list>div>div.gift-item").ClassClear("active"),D.style.display="block",N[0].innerHTML="",x[0].className="disabled")}function o(e,t){C&&(0!=e&&C.refresh(),G.offsetHeight>J.offsetHeight&&setTimeout(function(){parseInt(G.style.top)!=C.maxScrollY&&C.scrollTo(0,C.maxScrollY,t||300,!1)},0!=e?300:1))}function u(){if(Y>=0){for(var e=Y;e>=0&&e>=Y-F;e--)$.addMsgDiv(ge.msgList[oe.chatId].list[e],null,!0,!1);Y=e}C.refresh()}function p(e,t){return!(!e||t>4)&&(e==N[0]||(e=e.parentNode,p(e,t+1)))}function m(e){return e.replace(y,function(){var e=w[arguments[0]];if(e){var t=window.getComputedStyle(k[e-1].children[0],null).backgroundImage;return t='"'==t.charAt(4)||"'"==t.charAt(4)?t.slice(5,-2):t.slice(4,-1),"<img src='"+t+"' data-exp='"+arguments[0]+"'/>"}return arguments[0]})}function g(e,t){var a=document.createRange(),i=window.getSelection();a.selectNodeContents(e),a.collapse(!0),a.setEnd(e,t),a.setStart(e,t),i.removeAllRanges(),i.addRange(a),q.offset=t,q.node=e}function h(e,t,a){t=t||3,t<3&&(t=3),a=a||3e3,a<=0&&(a=3e3),a*=2;for(var i,s=1,n=parseInt(Math.random(+new Date)*(t-3))+3;s<n;s++)i=parseInt(Math.random(+new Date)*a+4e3)+"ms",se+='<div class="'+e+'" style="left:'+parseInt(18*Math.random(+new Date))+"rem;transition-duration: "+i+";-webkit-transition-duration: "+i+";-moz-transition-duration: "+i+";-ms-transition-duration: "+i+"; -o-transition-duration: "+i+';"></div>'}function v(){se="",h("m1",18),h("m2",18),$("#specEffect").Html(se),setTimeout(function(){$("#specEffect>div").Translate(0,2*$.$.winHeight+"px")},300)}var f=$.param("techId"),I=$.param("clubId")||$.$.clubID;if(!I)return $.tipShow("会所不存在！"),$.pageCancel();for(;$.param("imgScan");)$.paramClear("imgScan");var T,y,C,b,S,w={"/::O":1,"/::Y":2,"/::B":3,"/::A":4,"/::C":5,"/::D":6,"/::X":7,"/::Z":8,"/::F":9,"/::E":10,"/::T":11,"/::P":12,"/::G":13,"/::H":14,"/::I":15,"/::J":16,"/::K":17,"/::L":18,"/::M":19,"/::N":20,"/::Q":21,"/::R":22,"/::S":23,"/::U":24,"/::V":25,"/::W":26,"/::a":27,"/::b":28},N=$("#chatInput>div:nth-of-type(1)>div.input"),x=$("#chatInput>div:nth-of-type(1)>a"),L=$("#message-list-scroller>div.talk")[0],D=$("#chatInput>div:nth-of-type(1)>span")[0],A=$("#chatInput")[0],M=$("#chatInput>div:nth-of-type(2)>div.expression"),k=$("#chatInput>div:nth-of-type(3) li"),H=$("#chatInput>div.gift-list"),E=$("#chatInput>div.gift-list>div.list>div"),R=null,_=$("#chatInput>div:nth-of-type(2)>div.gift"),j=document.createElement("div"),q={node:null,offset:null},U=$("#chatInput>div:nth-of-type(3)"),P=1,O=$("#chatInput>div:nth-of-type(3)>div:nth-of-type(2)>span"),F=10,Y=-1,G=$("#message-list-scroller")[0],J=$("#message-list-wrapper")[0],V=G.querySelector("div:nth-of-type(1)"),W=Math.round(1.387*$.$.scale*16),B=!1,X=!1,z=$("#chatInput>div:nth-of-type(2)>div.coupon"),Z=$("#diceSetting"),K=$("#notEnoughTip"),Q=$("#diceSetting>div>ul>li"),ee=$("#chatInput>div.gift-list>div.info>b"),te="1",ae={request:"等待接受...",accept:"已接受",reject:"已拒绝",overtime:"已超时",cancel:"已取消"},ie=!1,se="",ne=864e5,ce={},re="img/chat/gift_default.png",de={plumFlower:{title:"一元夺",subTitle:"我和你只有一块钱的距离"},oneYuan:{title:"一元夺",subTitle:"我和你只有一块钱的距离"},timeLimit:{title:"限时抢",subTitle:"春宵一刻值千金"},luckyWheel:{title:"大转盘",subTitle:"那一世转山转水，只为相见"},journal:{title:"会所期刊",subTitle:"有美女、有福利，你就是我的VIP！"}},le=!1;y=new RegExp("/::[A-Zab]+","g");var oe,ue=$.$.userHeader,pe=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,me=!1,ge=$.$.easemob;if(ge.conn.isOpened())ge.currChatTech&&ge.currChatTech.chatId||(ge.currChatTech=$.sessionStorage("curr_chat_tech")?JSON.parse($.sessionStorage("curr_chat_tech")):void 0),e();else{if(!ge.userId)return $.$.loginUrl="chat&techId="+(f||"")+("9358"==$.$.visitChannel?"&clubId="+I:""),$.page("login");var he=setInterval(function(){ge.conn.isOpened()&&(clearInterval(he),ge.currChatTech&&ge.currChatTech.chatId||(ge.currChatTech=$.sessionStorage("curr_chat_tech")?JSON.parse($.sessionStorage("curr_chat_tech")):void 0),e())},20)}$("#message-list-wrapper").Delegate("click",".talk>.left>div:nth-of-type(1)",function(){ie||(history.replaceState&&history.replaceState(null,document.title,location.search+location.hash.toString().replace(new RegExp("technicianDetail&id="+f+"[^/]*/"),"")),$.page("technicianDetail&id="+f))})}();