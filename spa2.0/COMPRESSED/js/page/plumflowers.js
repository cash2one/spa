!function(){function e(){var e=location.search;/_t=(\d*)/g.test(e)?e=e.replace(/_t=(\d*)/g,function(){return"_t="+Date.now()}):e+=e?"&_t="+Date.now():"?_t="+Date.now();var t=location.origin+location.pathname+e+location.hash;t=t.replace(/(&|\?)code=[\da-zA-Z]+(&?)/g,function(e,t,a){return"?"==t?a?"?":"":a?"&":""}),t=t.replace(/(&|\?)state=[\da-zA-Z_\-]+(&?)/g,function(e,t,a){return"?"==t?a?"?":"":a?"&":""}),$.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/code",data:{wxmp:"9358",state:"plumflowers_pay",pageUrl:encodeURIComponent(t),scope:"snsapi_base"},success:function(e){200==e.statusCode?location.href=e.respData:$.tipShow(msg||e.msg||"请求微信授权失败！")}})}function t(){function e(e){var t;t=e.shareUrl?e.shareUrl:$.param("chanel")?location.href:location.href+"&chanel=link",$.X5Config({title:"一元夺美女",desc:"一元抢会所高端项目，美女技师任你挑~",link:t,imgUrl:e.clubLogo||$.$.defaultClubLogo,success:function(){$.ajax({url:"../api/v2/plumflower/share",type:"post",isReplaceUrl:!0,data:{id:e.plumFloweActivity.id,shareCode:T||"",topShareCode:$.getUrlParam("topShareCode")||"",chanel:$.getUrlParam("chanel")},success:function(){}})},cancel:function(){},fail:function(e){$.tipShow("分享失败！请刷新页面后再试！"),$.ajax({url:"../api/v2/user/share/info",isReplaceUrl:!0,type:"post",token:"null",data:{url:encodeURIComponent(location.href),browser:encodeURIComponent($.$.ua.value),message:encodeURIComponent(JSON.stringify(e||{}))},error:function(){}})}})}function t(e,t){var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in a)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[i]:("00"+a[i]).substr((""+a[i]).length)));return t}$.ajax({url:"../api/v2/plumflower/view",isReplaceUrl:!0,type:"post",data:{id:S,phoneNum:y,shareCode:$.getUrlParam("shareCode")||"",topShareCode:$.getUrlParam("topShareCode")||"",chanel:$.getUrlParam("chanel")||"link"},success:function(b){function F(){clearTimeout(p),p=0,n.Text()>1&&(clearTimeout(p),clearTimeout(d),d=0,n.Text(n.Text()-1),p=setTimeout(F,100))}function N(){clearTimeout(d),d=0,n.Text()<x&&(clearTimeout(p),clearTimeout(d),p=0,n.Text(n.Text()-0+1),d=setTimeout(N,100))}if(200==b.statusCode){if(b=b.respData,m=b.clubId,$.$.ua.isWX?($("#share-coupons-pop>div:nth-of-type(1)").CSS("display","block"),e(b)):$("#share-coupons-pop>div:nth-of-type(2)").CSS("display","block"),T=b.shareCode||T,$("#share-coupons-pop>div:nth-of-type(2)>div:nth-of-type(1)").Html("<a href='"+b.shareUrl+"'>"+b.shareUrl+"</a>"),$(".header > .logo").CSS("background-image","url("+(b.clubLogo||"img/logo_default.jpg")+")"),$(".header > .club-name").Text(b.clubName),$(".show-imgs>img")[0].src=b.plumFloweActivity.imageUrl,$(".act-process > .act-process-detail > div:nth-of-type(2)").Text(b.plumFloweActivity.title),$(".price").Text(b.plumFloweActivity.price),$(".act-process > .act-process-detail > div:nth-of-type(3) > span:nth-of-type(3)").Text("/"+b.plumFloweActivity.serviceTime+"分钟"),x=b.plumFloweActivity.price-b.plumFloweActivity.successPaidAmount,$(".timesSurplus").Text(x),$(".act-process > .act-process-bar > div > div:nth-of-type(1)").CSS("width",(b.plumFloweActivity.successPaidAmount/b.plumFloweActivity.price*100).toFixed(3)+"%"),$(".act-process > .act-process-bar > div > div:nth-of-type(2)").CSS("left",(b.plumFloweActivity.successPaidAmount/b.plumFloweActivity.price*100).toFixed(3)+"%"),"complete"==b.plumFloweActivity.status?($(".act-process > .act-process-detail > div:nth-of-type(1)").Class("complete").Text("已结束"),b.plumFloweActivity.winningNo?($(".act-result > div:nth-of-type(4) > div:nth-of-type(1) > span").Text(b.plumFloweActivity.winningNo),$(".act-result > div:nth-of-type(3)").Class("hide"),$(".act-result > div:nth-of-type(4)").ClassClear("hide"),$(".act-result > div:nth-of-type(4) > div:nth-of-type(2) >span").Text(b.plumFloweActivity.lotteryNo)):($(".act-result > div:nth-of-type(3)").ClassClear("hide"),$(".act-result > div:nth-of-type(4)").Class("hide")),$("#footer>div:nth-of-type(1)").Class("next-time").ClassClear("robed").Text("下次通知我"),$("#footer>div:nth-of-type(2)").Text("给朋友看看"),$(".act-result").ClassClear("hide")):Array.isArray(b.actNos)&&b.actNos.length>0&&($(".act-result > div:nth-of-type(3)").ClassClear("hide"),$(".act-result > div:nth-of-type(4)").Class("hide"),0==x&&$(".act-result").ClassClear("hide"),$(".act-mynums").ClassClear("no-nums")),$(".lottery-date").Text(b.plumFloweActivity.lotteryDate||"无"),0==x&&($("#footer>div:nth-of-type(1)").Class("next-time").ClassClear("robed").Text("下次通知我"),$("#footer>div:nth-of-type(2)").Text("给朋友看看")),Array.isArray(b.actNos)&&b.actNos.length>0){var A=[];b.actNos.forEach(function(e){A.push("<li><div><div><span>手机<span>"+e.phoneNum+"</span></span><span>"+t(new Date(e.createdAt),"MM月dd日 hh:mm:ss")+"</span></div><div>"+function(e){var t=[],e=e.split(",");return e.forEach(function(e){t.push("<span "+(e==b.plumFloweActivity.winningNo?'style="color:#fb5549;"':"")+">"+e+"</span>"),w.push("<span>"+e+"</span>")}),t.join("")}(e.actNo)+"</div></div></li>")}),$(".item.act-mynums > div:nth-of-type(3) > ul").Html(A.join(""))}else y&&$.param("isSearch")&&($.paramClear("isSearch"),$.tipShow("未查询到您的购买信息。",5e3));y&&($("#joinFirst > div:nth-of-type(2) > .input-item:nth-of-type(1) > div:nth-of-type(2) > input,#joinNotice > div:nth-of-type(2) > .input-item > div:nth-of-type(2) > input").Value(y,!0),$("#joinFirst > div.sure-btn,#joinNotice > div.sure-btn").ClassClear("disabled"),g=!0),$(".club-name").Click(function(){location.href=location.origin+location.pathname+"?club="+m}),C.Click(function(e,t){a.Class("active"),i.Class("hide"),o.Class("hide"),s.Class("hide"),$("#joinSearch").ClassClear("hide")}),$("#joinSearch .sure-btn").Click(function(e,t){$.localStorage("_indianas_tel_phone",$("#joinSearch input").Value()),$.page("plumflowers&isSearch=true&_time="+(new Date).getTime()+"&id="+S,0,!0,!1)});var P=$("#share-coupons-pop");$(".shared").Click(function(){P.Class("active")}),$("#share-coupons-pop>div:nth-of-type(2)>div:nth-of-type(3)").Click(function(){P.ClassClear("active")}),P.Click(function(){P.ClassClear("active")}),$("#share-coupons-pop>div:nth-of-type(2)").Click(function(e){e.stopPropagation()}),$("#share-coupons-pop>div:nth-of-type(1)").Click(function(e){e.stopPropagation()}),$("#footer").Delegate("click",">div.robed",function(e,t){a.Class("active"),i.ClassClear("hide"),o.Class("hide"),s.Class("hide"),$("#joinSearch").Class("hide")}).Delegate("click",">div.next-time",function(e,t){a.Class("active"),i.Class("hide"),o.Class("hide"),s.ClassClear("hide"),$("#joinSearch").Class("hide"),$("#joinNotice>div:nth-of-type(2)").ClassClear("hide"),$("#joinNotice>div:nth-of-type(3)").Class("hide")}),u.Click(function(e,t){a.ClassClear("active")}),$("#joinFirst .sure-btn>div").Click(function(e,s){if(!$(s.parentNode).ClassHave("disabled")){if(0==n.Text())return $.localStorage("_indianas_tel_phone",f.Value()),void $.page("plumflowers&isSearch=true&_time="+(new Date).getTime()+"&id="+S,0,!0,!1);if(!$.$.ua.isWX)return void($.checkAccessMenu("plumflowers")&&$.tipShow("请在微信中打开。"));g&&$.ajax({url:"../api/v2/plumflower/view",isReplaceUrl:!0,type:"post",data:{id:S,phoneNum:y,shareCode:$.getUrlParam("shareCode")||"",topShareCode:$.getUrlParam("topShareCode")||"",chanel:$.getUrlParam("chanel")||"link"},success:function(e){if(g=!1,Array.isArray(e.actNos)&&e.actNos.length>0){var a=[];e.actNos.forEach(function(i){a.push("<li><div><div><span>手机<span>"+i.phoneNum+"</span></span><span>"+t(new Date(i.createdAt),"MM月dd日 hh:mm:ss")+"</span></div><div>"+function(t){var a=[],t=t.split(",");return t.forEach(function(t){a.push("<span "+(t==e.plumFloweActivity.winningNo?'style="color:#fb5549;"':"")+">"+t+"</span>"),w.push("<span>"+t+"</span>")}),a.join("")}(i.actNo)+"</div></div></li>")}),$(".item.act-mynums > div:nth-of-type(3) > ul").Html(a.join("")),$(".act-mynums").ClassClear("no-nums")}}}),h?$.tipShow("正在支付，请稍候...",3e3):(h=!0,$.ajax({url:"../api/v2/wx/pay/paid_plumflower",isReplaceUrl:!0,type:"post",data:{plumFloweId:S,amount:n.Text(),phoneNum:f.Value(),shareCode:$.getUrlParam("shareCode"),topShareCode:$.getUrlParam("topShareCode"),chanel:$.getUrlParam("chanel")||"link",openId:j,clubId:m,tradeChannel:"wx",businessChannel:$.getUrlParam("chanel")||"link"},success:function(e){function s(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:p.appId,timeStamp:p.timeStamp+"",nonceStr:p.nonceStr,"package":p["package"],signType:p.signType,paySign:p.paySign},function(a){if(h=!1,a.err_msg&&a.err_msg.indexOf("ok")>=0){$.tipShow("支付成功！"),$.localStorage("_indianas_tel_phone",f.Value()),y&&y!=f.Value()&&$(".act-mynums > div:nth-of-type(3) > ul").Html(""),i.Class("hide"),o.ClassClear("hide");var s=e.userPlumFlowe.userPlumFlowe,l=e.userPlumFlowe.plumFlowe,r=s.amount+l.successPaidAmount;if(x=l.price-s.amount-l.successPaidAmount,$(".timesSurplus").Text(x),$(".act-process > .act-process-bar > div > div:nth-of-type(1)").CSS("width",(r/l.price*100).toFixed(3)+"%"),$(".act-process > .act-process-bar > div > div:nth-of-type(2)").CSS("left",(r/l.price*100).toFixed(3)+"%"),0==x){$(".act-result").ClassClear("hide");var u=new Date;u.getHours()>=20&&u.setDate(u.getDate()+1),$(".lottery-date").Text(t(u,"yyyy-MM-dd")),$("#footer>div:nth-of-type(1)").Class("next-time").ClassClear("robed").Text("下次通知我"),$("#footer>div:nth-of-type(2)").Text("给朋友看看")}$("#joinSuccess .join-times>span").Text(s.amount),$("#joinSuccess .join-tel").Text(s.phoneNum),s.amount+l.successPaidAmount>=l.price?$("#joinSuccess .sure-btn>div").Class("num-over"):$("#joinSuccess .sure-btn>div").ClassClear("num-over");var p=[];s.actNo.split(",").forEach(function(e){p.push("<span>"+e+"</span>")}),$("#joinSuccess .join-nums").Html(p.join("")),$(".act-mynums").ClassClear("hide"),$(".act-mynums").ClassClear("no-nums"),$(".act-mynums > div:nth-of-type(3) > ul").Html("<li><div><div><span>手机<span>"+s.phoneNum+"</span></span><span>"+t(new Date(s.createdAt),"MM月dd日 hh:mm:ss")+"</span></div><div>"+p.join("")+"</div></div></li>",!0)}else $.tipShow("未能成功支付！"),$.ajax({url:"../api/v2/plumflower/userplumflower/delete",type:"post",isReplaceUrl:!0,data:{id:e.userPlumFlowe.userPlumFlowe.id},success:function(e){}});n.Text(1),c.ClassClear("checked")})}if(200==e.statusCode){if(e=e.respData,e.userPlumFlowe.userPlumFlowe.amount<n.Text()){var l=e.userPlumFlowe.userPlumFlowe,r=e.userPlumFlowe.plumFlowe,u=l.amount+r.successPaidAmount;if(x=r.price-r.successPaidAmount,$(".timesSurplus").Text(x),$(".act-process > .act-process-bar > div > div:nth-of-type(1)").CSS("width",(u/r.price*100).toFixed(3)+"%"),$(".act-process > .act-process-bar > div > div:nth-of-type(2)").CSS("left",(u/r.price*100).toFixed(3)+"%"),n.Text(0==x?1:x),0==x){if(a.ClassClear("active"),$(".act-result").ClassClear("hide"),$(".lottery-date").Text(r.lotteryDate),$("#footer>div:nth-of-type(1)").Class("next-time").ClassClear("robed").Text("下次通知我"),$("#footer>div:nth-of-type(2)").Text("给朋友看看"),r.price-r.successPaidAmount==0||0==l.amount)return h=!1,$.tipShow("剩余次数为0，抱歉，您此次未抢到！")}else $.tipShow("剩余次数小于您所选购的次数，请注意！")}var p=JSON.parse(e.tradeReqData);"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",s,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",s),document.attachEvent("onWeixinJSBridgeReady",s)):s()}else 500==e.statusCode&&($.tipShow("此次未抢购成功。"),$.page("plumflowers&isSearch=true&_time="+(new Date).getTime()+"&id="+S,0,!0,!1))}}))}}),$("#joinSuccess .sure-btn>div>div:nth-of-type(1)").Click(function(e,t){i.ClassClear("hide"),o.Class("hide"),n.Text(1)}),$("#joinNotice .sure-btn>div").Click(function(e,t){$(t.parentNode).ClassHave("disabled")||($("#joinNotice > div:nth-of-type(2)").ClassHave("hide")?a.ClassClear("active"):$.ajax({url:"../api/v2/plumflower/nextnoticeuser/save",type:"post",isReplaceUrl:!0,data:{phoneNum:v.Value(),clubId:m,actId:S},success:function(e){200==e.statusCode?($.tipShow("预约成功。"),$("#joinNotice > div:nth-of-type(2)").Class("hide"),$("#joinNotice > div:nth-of-type(3)").ClassClear("hide"),$("#joinNotice > div:nth-of-type(3) > div:nth-of-type(3)").Text(v.Value())):$.tipShow(e.msg||"预约失败。")}}))}),c.Click(function(e,t){c.ClassHave("checked")?c.ClassClear("checked"):(c.Class("checked"),n.Text(x))}),l.Event("touchstart",function(e,t){e.preventDefault(),c.ClassClear("checked"),F()}),l.Event("touchmove",function(e,t){clearTimeout(p),clearTimeout(d),p=0,d=0}),l.Event("touchend",function(e,t){e.preventDefault(),clearTimeout(p),clearTimeout(d),p=0,d=0}),r.Event("touchstart",function(e,t){e.preventDefault(),N()}),r.Event("touchmove",function(e,t){clearTimeout(p),clearTimeout(d),p=0,d=0}),r.Event("touchend",function(e,t){e.preventDefault(),clearTimeout(p),clearTimeout(d),p=0,d=0})}else $.tipShow(b.msg||"数据加载失败");$.pageSwitch()}}),f.Verify("tel",function(e){e?$("#joinFirst > div.sure-btn").ClassClear("disabled"):$("#joinFirst > div.sure-btn").Class("disabled")}),v.Verify("tel",function(e){e?$("#joinNotice > div.sure-btn").ClassClear("disabled"):$("#joinNotice > div.sure-btn").Class("disabled")}),$("#joinSearch input").Verify("tel",function(e){e?$("#joinSearch > div.sure-btn").ClassClear("disabled"):$("#joinSearch > div.sure-btn").Class("disabled")})}var a=$("#join-info"),i=$("#joinFirst"),o=$("#joinSuccess"),s=$("#joinNotice"),n=$("#joinFirst .times-count"),l=$("#joinFirst .reduce-count"),r=$("#joinFirst .plus-count"),c=$("#joinFirst>div:nth-of-type(2)>.input-item:nth-of-type(2)>div:nth-of-type(3)"),u=$("#join-info .close-btn"),p=null,d=null,h=!1,m="",f=$("#joinFirst > div:nth-of-type(2) > .input-item:nth-of-type(1) > div:nth-of-type(2) > input"),v=$("#joinNotice > div:nth-of-type(2) > .input-item > div:nth-of-type(2) > input"),C=$(".act-mynums > div:nth-of-type(2) > a"),y=$.localStorage("_indianas_tel_phone")||$.$.userTel||"",g=!1,w=[],S=$.param("id")||$.getUrlParam("id",!0)||"",x=0,T=$.getUrlParam("shareCode")||"",b=$.getUrlParam("code")||"",j=$.localStorage("_indianas_user_open_id")||"";if(!S)return $.tipShow("参数不正确。"),$.pageCancel();if($.$.ua.isWX)if(!j||j.length<10){if((new Date).getTime()-($.getUrlParam("_t")||0)>24e3||!b)return void e();$.ajax({url:"../api/v2/wx/oauth2/openid",isReplaceUrl:!0,data:{code:b,scope:"snsapi_base",wxmp:"9358",openId:"",webSessionId:""},success:function(a){if(200==a.statusCode)j=a.respData.openid,$.localStorage("_indianas_user_open_id",j),t();else{if("935801"!=a.statusCode)return $.tipShow(a.msg||"获取openId失败！"),$.pageCancel();e()}}})}else t();else t();if(document.title="一元夺美女",$.$.ua.isiPhone||$.$.ua.isWX){var F=document,N=F.createElement("iframe");N.style.display="none",N.onload=function(){N.onload=null,setTimeout(function(){F.body.removeChild(N)},0)},N.src="img/cancel_icon.png",F.body.appendChild(N)}}();