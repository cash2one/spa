!function(t,e){function n(){$.ajax({url:($.$.clubID?"../":"")+"/userredpacket/"+a,data:{userType:"user"},success:function(t){function n(){c++,$.ajax({url:($.$.clubID?"../":"")+"/user/coupon_qrcode",data:{userActId:a},success:function(t){200==t.statusCode&&t.respData?$("#content>div:nth-of-type(4)>div:nth-of-type(2)>img")[0].src=t.respData:c<4&&n()}})}function p(){$.localStorageClear("paid-cou-detail-param"),s||(s=!0,r.Class("disabled"),r.Text("支付中..."),$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/paid_coupon_immediately",type:"post",data:{actId:t.userAct.actId,businessType:"paid_coupon",businessChannel:t.userAct.chanel,clubId:t.userAct.clubId,money:t.userAct.actValue,openId:$.$.payOpenId,techId:t.techs.id,tradeChannel:"wx",bizId:t.userAct.bizId,userId:$.$.userID},success:function(t){function n(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:t.appId,timeStamp:t.timeStamp+"",nonceStr:t.nonceStr,"package":t["package"],signType:t.signType,paySign:t.paySign},function(t){if(s=!1,r.ClassClear("disabled"),r.Text("立即支付"),t.err_msg.indexOf("ok")>=0){$("#payBtn>div").Text("立即预约"),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Class("already"),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Text("已支付"),$.tipShow("支付成功！");var e,n,o=$.sessionStorage("coupon_data");o&&(e=document.createElement("div"),e.innerHTML=o,n=e.querySelector("div>div[hh='"+a+"']"),n&&(n.querySelector("span").className="payed",n.querySelector("span").innerHTML="已支付",$.sessionStorage("coupon_data",e.innerHTML)));var i=$.$.easemob;if(i.userId&&!i.conn.isOpened())var d=setInterval(function(){i.conn.isOpened()&&(clearInterval(d),u())},10);else u()}else $.tipShow("未能成功支付！")})}200==t.statusCode?t.respData?(t=JSON.parse(t.respData),o=t["package"].split("=")[1],"undefined"==typeof WeixinJSBridge?e.addEventListener?e.addEventListener("WeixinJSBridgeReady",n,!1):e.attachEvent&&(e.attachEvent("WeixinJSBridgeReady",n),e.attachEvent("onWeixinJSBridgeReady",n)):n()):(s=!1,r.ClassClear("disabled"),$.tipShow("您已成功支付！"),r.Text("立即预约"),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Class("already"),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Text("已支付")):"935801"==t.statusCode?($.localStorage("paid-cou-detail-param",!0),$.getOauthCode("","9358","paid-coupon-detail","base")):(r.ClassClear("disabled"),r.Text("立即支付"),$.tipShow(t.msg||"购买点钟券请求失败！"))}}))}function u(){var e=$.$.userHeader,n=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,o=$.$.easemob,a={from:o.userId,to:t.techs.emchatId,data:"您购买了"+t.techs.name+'的"'+t.userAct.actTitle+'"',ext:{name:t.techs.name,header:t.techs.avatarUrl,avatar:"",no:t.techs.serialNo,techId:t.techs.id,clubId:t.clubId,msgType:"paidCouponTip"}},i=setTimeout(function(){a.status=0,$.updateSessionList(a,"text",!1),$.addToMsgList(a,"text")},5e3);o.conn.isOpened()&&o.conn.send({to:t.techs.emchatId,msg:t.userAct.actTitle+"&"+t.userAct.actId,type:"chat",ext:{name:n,header:e,msgType:"paidCouponTip",time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(t.techs.emchatId,"business_process"),clearTimeout(i),a.status=1,$.updateSessionList(a,"text",!1),$.addToMsgList(a,"text")}})}if(200!=t.statusCode)return $.tipShow(t.msg||"获取点钟券数据详情失败！"),void $.page("home",-1,!0);t=t.respData,"9358"!=$.$.visitChannel?$("#content>div:nth-of-type(2)").CSS("display","none"):($("#content>div:nth-of-type(2)>span").Text(t.clubName),$("#content>div:nth-of-type(2)>div:nth-of-type(1)").CSS("background-image","url("+(t.imageUrl||$.$.defaultClubLogo)+")"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)").Click(function(){$.$.clubID?$.page("home",-1,!0):location.href=location.href.split("spa2")[0]+"spa2/?club="+t.clubId+"#home"})),$("#content>div:nth-of-type(3)>div:nth-of-type(1)>div").CSS("background-image","url("+(t.techs.avatarUrl||$.$.defaultHeader)+")"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(1)").Html("<div>"+t.techs.name+"</div>[<div>"+(t.techs.serialNo||"")+"</div>]"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(2)").Text(t.techs.commentCount+"评论"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(1)>div:nth-of-type(2)>div:nth-of-type(1)>div").CSS("width",t.techs.star+"%"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(3)>div:nth-of-type(1)").Text(t.techs.description||"这个技师很懒，没有填写个人简介..."),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>div:nth-of-type(3)>div:nth-of-type(2)").Click(function(){$.login("confirmOrder&techId="+t.techs.id+("9358"==$.$.visitChannel?"&clubId="+t.clubId+"&backPublic=true":""),!1,!0,!0)}),$("#content>div:nth-of-type(3)>div:nth-of-type(1)>div").Click(function(){$.page("chat&techId="+t.techs.id+("9358"==$.$.visitChannel?"&clubId="+t.clubId:""))}),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(1)").Text(t.userAct.actTitle),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(2)").Text(t.userAct.consumeMoneyDescription),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(3)>span").Text(t.userAct.couponPeriod),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(4)>span").Text(t.userAct.getDate.split(" ")[0]),t.userAct.couponQrCodeUrl?$("#content>div:nth-of-type(4)>div:nth-of-type(2)>img")[0].src=t.userAct.couponQrCodeUrl:n(),$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span").Text(t.userAct.couponNo.substr(0,4)+" "+t.userAct.couponNo.substr(4,4)+" "+t.userAct.couponNo.substr(8)),$("#content>div:nth-of-type(5)>div:nth-of-type(2)").Html(t.userAct.actContent),$("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Text(t.userAct.couponStatusDescription),4==t.userAct.couponStatus?($("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").ClassClear("expire"),$("#payBtn").CSS("display","none")):1==t.userAct.couponStatus?($("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Class("already"),$("#payBtn>div").Text("立即预约")):"online"!=t.actStatus&&"立即预约"!=$("#payBtn>div").Text()?$("#payBtn>div").Class("downline").Text("已下线"):0!=t.userAct.couponStatus&&($("#content>div:nth-of-type(4)>div:nth-of-type(1)>div:nth-of-type(5)").Class("expire"),$("#payBtn").CSS("display","none"));var r=$("#payBtn>div");$("#payBtn>div").Click(function(e,n){if("已下线"!=n.innerHTML)if("立即支付"==n.innerHTML){if(!$.$.ua.isWX)return void($.checkAccessMenu("paidCouponDetail")&&$.tipShow("请您打开微信登录'9358'公众号！"));$.$.userTel?p():($.$.loginUrl=location.hash,$.page("bindPhone",1))}else"立即预约"==n.innerHTML&&$.login("confirmOrder&techId="+t.techs.id+("9358"==$.$.visitChannel?"&clubId="+t.clubId+"&backPublic=true":""),!1,!0,!0)}),i&&d?($.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:$.$.payAuthCode,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"paid-cou-detail"},success:function(t){200==t.statusCode?($.localStorageClear("paid-cou-detail-param"),p()):"935801"==t.statusCode?$.getOauthCode("","9358","paid-cou-detail","base"):$.tipShow(t.msg||"获取openId失败！")}}),$.pageSwitch()):$.pageSwitch()}})}var o,a=$.param("userActId"),i=$.localStorage("paid-cou-detail-param"),d=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode,s=!1,c=0;return a?void($.$.userToken?"web"==$.$.sessionType?$.ajax({url:"../api/v1/check_login/"+$.$.sessionType+"/"+$.$.userToken,isReplaceUrl:!0,success:function(t){"Y"==t.msg?n():($.$.loginUrl="paidCouponDetail"+location.hash.split("paidCouponDetail")[1],$.page("login"))}}):n():($.$.loginUrl="paidCouponDetail"+location.hash.split("paidCouponDetail")[1],$.page("login"))):($.tipShow("地址栏缺少参数！"),$.pageCancel())}(window,document);