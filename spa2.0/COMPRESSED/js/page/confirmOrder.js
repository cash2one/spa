!function(){function e(){$.ajax({url:($.$.clubID?"../":"")+"/order/appoint/view",data:{clubId:l,techId:o||"",itemId:s||""},success:function(e){function i(e){if(o){if(h)return;var t=$.$.easemob;if(t.conn.isOpened())n(e);else{if(!t.conn.userId)return $.tipShow("未能获取您的账号信息，请您重新登录！"),$.$.loginUrl="order",$.page("login");var a=setInterval(function(){t.conn.isOpened()&&(clearInterval(a),n(e))},20)}}else $.page("orderDetail&id="+e+"&tag=submit"+($.param("backChat")?"&backChat=true":"")+("true"==$.param("backPublic")?"&backPublic=true":""),0,!0)}function n(t){function a(){$.updateSessionList(s,"text",!1),$.addToMsgList(s,"text"),"on"==y&&L>0?$.page("order"):$.page("orderDetail&id="+t+"&tag=submit"+($.param("backChat")?"&backChat=true":"")+("true"==$.param("backPublic")?"&backPublic=true":""),0,!0)}if(!h){var i=$.$.userHeader,n=$.$.userName==$.$.defaultUserName?$.$.defaultUserName+"("+$.$.userTel.substr(0,3)+"****"+$.$.userTel.slice(-4)+")":$.$.userName,r="<span>发起预约</span><br>到店时间：<b>"+d.innerHTML+"</b><br>预约项目：<b>"+(e.item?e.item.name:"到店选择")+"</b>",o=$.$.easemob,s={from:$.$.easemob.userId,to:e.emchatId,data:r,ext:{name:e.tech.name,header:e.tech.avatarUrl,avatar:e.tech.avatar,no:e.tech.serialNo,techId:e.tech.id,clubId:e.tech.clubId,msgType:"order",orderId:t}},c=setTimeout(function(){s.status=0,a()},5e3);o.conn.isOpened()&&o.conn.send({to:e.emchatId,msg:r,type:"chat",ext:{name:n,header:i,msgType:"order",orderId:t,time:Date.now(),avatar:$.$.userAvatar},success:function(){$.sendFriend(e.emchatId,"off"==y?"order":"paid_order"),clearTimeout(c),s.status=1,a()}})}}function r(e,t,a,n){var r={businessChannel:"link",clubId:l||"",dateDay:e||0,dateTime:t,downPayment:a,itemId:s||"",orderType:C,serviceDuration:n,techId:o||"",tradeChannel:"wx",username:x.Value(),timeId:J};$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/paid_order",type:"post",data:r,success:function(e){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appId,timeStamp:e.timeStamp+"",nonceStr:e.nonceStr,"package":e["package"],signType:e.signType,paySign:e.paySign},function(t){t.err_msg.indexOf("ok")>=0?(H.ClassClear("active"),$.tipShow("支付成功！"),i(e.bizId)):(H.ClassClear("active"),$.tipShow("未能成功支付！"),h?(b.ClassClear("disabled"),b.Text("立即预约"),$.ajax({url:($.$.clubID?"../":"")+"../wx/pay/delete_order",data:{orderId:e.bizId},success:function(){}})):$.page("order")),c=!1})}200==e.statusCode?(e=JSON.parse(e.respData),"undefined"==typeof WeixinJSBridge?doc.addEventListener?doc.addEventListener("WeixinJSBridgeReady",t,!1):doc.attachEvent&&(doc.attachEvent("WeixinJSBridgeReady",t),doc.attachEvent("onWeixinJSBridgeReady",t)):t()):"935801"==e.statusCode?(r.arriveTime=d.innerHTML,$.localStorage("con-order-param",JSON.stringify(r)),$.getOauthCode("","9358","confirm-order","base")):($.tipShow(e.msg||"付费预约失败！"),c=!1,H.ClassClear("active"))},error:function(){$.tipShow("error"),c=!1,H.ClassClear("active")}})}if("200"!=e.statusCode)return $.tipShow(e.msg||"请求数据失败！"),3==$.localStorage("backIndex")?void $.page(""):$.pageCancel();var d=$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)")[0],c=!1,b=$("#footer>div"),x=$("#content>div:nth-of-type(5)>div:nth-of-type(1)>input");e=e.respData,h="true"===e.hasInnerProvider,L=e.downPayment||0,F=L,y=h?"on":"paid"==e.appointType||"paid_full"==e.appointType?"on":"off",C=e.appointType,e.tech?(e.tech.avatarUrl=e.tech.avatarUrl||$.$.defaultHeader,$("#content>div:nth-of-type(2)>div:nth-of-type(1)").CSS("backgroundImage","url('"+e.tech.avatarUrl+"')"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(1)").Html(e.tech.name+"<span>[<span>"+(e.tech.serialNo||"")+"</span>]</span>"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)").Text(e.tech.description||"这个技师很懒，没有填写个人简介..."),$("#content>div:nth-of-type(2)>div:nth-of-type(1)>div").Class(e.tech.status),$("#content>div:nth-of-type(2)>div:nth-of-type(1)>div").Text("free"==e.tech.status?"闲":"忙"),$("#content>div:nth-of-type(2)>div:nth-of-type(1)").Login("chat&techId="+e.tech.id+("9358"==$.$.visitChannel?"&clubId="+e.tech.clubId:""))):($("#content>div:nth-of-type(2)>div:nth-of-type(1)").CSS("backgroundImage","url('"+$.$.defaultHeader+"')"),$("#content>div:nth-of-type(2)>div:nth-of-type(1)>div").CSS("display","none"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(1)").Html("技师待定"),$("#content>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)").Text("到店选择技师")),e.item?($("#content>div:nth-of-type(3)>div:nth-of-type(1)>span").Text(e.item.name),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>span").Text($.formatPrice(e.item.price,e.item.duration,e.item.durationUnit)),$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Hide(),"paid_full"===C&&(L=e.item.price,$("#content>div:nth-of-type(6)>div:nth-of-type(1)>span").Text("￥"+L+"元"),j.Text("支付金额可在结账时抵扣 "+e.item.name+" 的消费"))):($("#content>div:nth-of-type(3)>div:nth-of-type(1)>span").Text("到店选择"),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>span").Text("待定"),$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Show()),p&&($("#content>div:nth-of-type(6)>div>span").CSS({"text-decoration":"line-through"}),L=v,$("#content>div:nth-of-type(5)>div>input").Value(u),$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Hide()),$("#content>div:nth-of-type(5)>div:nth-of-type(2)>span").Text($.$.userTel),!y||"off"==y||L<=0?($("#content>div:nth-of-type(6),#content>div:nth-of-type(7)").Hide(),$("#content>div:nth-of-type(5)").CSS("margin-bottom","4rem")):$("#content>div:nth-of-type(6)>div>span").Text("￥"+L+"元");var T=!1;if(m=[],h)if(e.time.length<=0)$(d).Text("无可预约时间").Class("cancel"),$("#footer")[0].style.display="none";else{for(var I={},S=new Date,k=0;k<3;k++)I[$.commonDateFormat(t(S,0==k?0:1).currDate,"yyyy-MM-dd")]=_[k];_=I,e.time.forEach(function(e,t){e.time&&e.time.length>0&&(T=!0),m[e.id]=e,Array.prototype.push.apply(E,e.time)}),E.forEach(function(e,t){e.tmpFlag="Y"!=e.status,e.status="Y"});var w,D=new Date(e.today);D=$.commonDateFormat(D,"yyyy-MM-dd")==m[0].day?D:new Date(m[0].day.replace(/-/g,"/"));for(var P=1;P<=e.time.length;P++)w=t(D,1==P?0:1),$(g[P-1]).Text(_[e.time[P-1].day]+w.month+"月"+w.day+"日"),$(g[P-1]).Attr("data-index",P).Attr("data-day",P+2-e.time.length),M.push(w);for(P=g.length;P>e.time.length;P--)g[P-1].style.display="none";a(0)}else{e.time.forEach(function(e,t){e.time&&e.time.length>0&&(T=!0),e.time.sort(function(e,t){return e.time-t.time}),m[e.id]=e,Array.prototype.push.apply(E,e.time)});var N,U=45;if(s){var A=e.item;U=/次/g.test(A.durationUnit)?30*Number(A.duration):/天/g.test(A.durationUnit)?24*Number(A.duration)*60:/时/g.test(A.durationUnit)?60*Number(A.duration):Number(A.duration),O=U}N=Math.ceil(U/30),E.forEach(function(e,t){if("N"==e.status)e.tmpFlag=!1;else if(t+1<E.length){var a=E.slice(t+1,t+N),i=a.every(function(e){return"N"!=e.status});e.tmpFlag=i}else e.tmpFlag=!0;m[~~(t/48)].time[t%48].tmpFlag=e.tmpFlag});for(var w,D=new Date(e.today),P=1;P<4;P++)w=t(D,1==P?0:1),$(g[P-1]).Text(_[P-1]+w.month+"月"+w.day+"日"),$(g[P-1]).Attr("data-index",P).Attr("data-day",P+2-e.time.length),M.push(w);a(0)}if(T||($("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)").Class("cancel"),$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)").Text("当前无可预约时间"),b.ClassClear("active")),$.pageSwitch(!0,!1),$.localStorage("customerName")&&!p&&x.Value($.localStorage("customerName")),b.Click(function(){if(x.Value()&&$.localStorage("customerName",x.Value()),c)$.tipShow("正在提交，请稍候...");else{if("cancel"==$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)")[0].className)return $.tipShow("当前无可预约时间！");if(!b.ClassHave("active"))return $.tipShow("请选择到店时间！");if(!x.Value())return $.tipShow("请输入联系人姓名！");if(H.Class("active"),!s){var t=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span.active");t=t.ClassHave("disabled")?"0":t.Text(),O=/小时/.test(t)?60*parseFloat(t):parseInt(t)}if(p)c=!0,b.Class("disabled"),b.Text("预约中..."),$.ajax({url:($.$.clubID?"../":"")+"/order/update_time",data:{clubId:l,dateDay:$(".day-list>div.active").Attr("data-day")-0,dateTime:d.innerHTML.slice(-5),orderId:p,sessionType:$.$.sessionType,timeId:J},success:function(e){c=!1,b.ClassClear("disabled"),b.Text("立即预约"),"200"==e.statusCode?i(p):($.tipShow(e.msg||"预约失败！"),H.ClassClear("active"))},error:function(){$.tipShow("预约失败！"),H.ClassClear("active"),c=!1,b.ClassClear("disabled"),b.Text("立即预约")}});else{if(!s&&0==O)return H.ClassClear("active"),$.tipShow("无项目时长，请更改到店时间。");if(y&&"on"==y&&L>0){if(!$.$.ua.isWX)return H.ClassClear("active"),void($.checkAccessMenu("confirmOrder")&&$.tipShow("请您打开微信登录'9358'公众号！"));$.$.userToken?(c=!0,b.Class("disabled"),b.Text("预约中..."),r($(".day-list>div.active").Attr("data-day")-0,d.innerHTML.slice(-5),L,O)):($.tipShow("请您先登录！"),$.$.loginUrl="confirmOrder"+location.hash.split("confirmOrder")[1],$.page("login"))}else c=!0,b.Class("disabled"),b.Text("预约中..."),$.ajax({url:($.$.clubID?"../":"")+"/order/appoint",type:"post",data:{username:x.Value(),dateDay:$(".day-list>div.active").Attr("data-day")-0,dateTime:d.innerHTML.slice(-5),clubId:l,techId:o||"",itemId:s||"",orderType:e.appointType,downPayment:0,serviceDuration:O,timeId:J},success:function(e){c=!1,b.ClassClear("disabled"),b.Text("立即预约"),"200"==e.statusCode?i(e.respData):($.tipShow(e.msg||"预约失败！"),H.ClassClear("active"))},error:function(){$.tipShow("预约失败！"),H.ClassClear("active"),c=!1,b.ClassClear("disabled"),b.Text("立即预约")}})}}}),f){$.localStorageClear("con-order-param");var B={45:1,60:2,90:3,120:4}[f.serviceDuration];if(B){var V=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span");V.ClassClear("cancel"),V.ClassClear("active"),$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span:nth-of-type("+B+")")[0].click()}d.innerHTML=f.arriveTime,x[0].value=f.username,r(f.dateDay,f.dateTime,f.downPayment,f.serviceDuration)}}}),o?$.ajax({url:"../api/v1/profile/tech/getServiceItemByTech",isReplaceUrl:!0,data:{techId:o},success:function(e){if(200==e.statusCode){var t=e.respData;t.length>0&&(i(t),$("#content>div:nth-of-type(3)>div:nth-of-type(1)").Click(function(){n(s||"")}).Class("active"))}else $.tipShow(e.msg||"查询技师服务项目失败")}}):$.ajax({url:"../api/v2/club/"+$.$.clubID+"/categoryService",isReplaceUrl:!0,success:function(e){var t=[];e.forEach(function(e){t=t.concat(e.serviceItems)}),t.length>0&&(i(t),$("#content>div:nth-of-type(3)>div:nth-of-type(1)").Click(function(){n(s||"")}).Class("active"))}})}function t(e,t){return t&&e.setDate(e.getDate()+t),{currDate:e,date:e.getTime(),year:e.getFullYear(),month:e.getMonth()+1,day:e.getDate(),week:e.getDay()}}function a(e,t){(!e||e<0)&&(e=0),$(".time-list>div").Class("disabled"),$(".time-list>div").ClassClear("active");var a=[];b[0].innerHTML="",m[e].time.forEach(function(e,i){var n="";"N"===e.status||"Y"===e.status&&!e.tmpFlag?n="disabled":t&&t==e.timeStr&&(n="active"),e.timeStr&&("Y"!==e.status||e.tmpFlag?a.push('<div ix="'+i+'" class="'+n+'" data-time-id="'+(e.timeId||"")+'"><span >'+e.timeStr+"</span><span >&#45;&#45;:&#45;&#45;</span></div>"):a.push('<div ix="'+i+'" class="'+n+'" data-time-id="'+(e.timeId||"")+'"><span '+(e.tmpFlag||"N"===e.status?"":'style="display:block;"')+">"+e.timeStr+"</span><span "+(e.tmpFlag||"N"===e.status?"":'style="display:none;"')+">&#45;&#45;:&#45;&#45;</span></div>"))}),b[0].innerHTML=a.join(""),$(".time-list>div.active").length>0&&$(".time-list>div.active")[0].click()}function i(e){var t=[];e.forEach(function(e){t.push('<div class="item" id="item_'+e.id+'" data-service-id="'+e.id+'" data-service-name="'+e.name+'" data-service-price1="'+e.price1+'" data-service-price="'+(e.price1?e.price1+"元/"+e.duration1+e.durationUnit:"")+'">                          <div></div>                          <div style="background-image: url('+e.imageUrl+')"></div>                          <div>                            <div>'+e.name+"</div>                            <div>                              <div>"+(e.price1?e.price1+"元/"+e.duration1+e.durationUnit:"&nbsp;")+"</div>                              <div>"+(e.price2?e.price2+"元/"+e.duration2+e.durationUnitPlus:"&nbsp;")+"</div>                            </div>                          </div>                        </div>")}),$("#_servicePicker .service-list").Html(t.join("")),r()}function n(e){e&&d($("#item_"+e)[0],!0),S.Class("active")}function r(){$("#_servicePicker>div>div>div:nth-of-type(1)>span").Click(function(){S.ClassClear("active")}),$("#_servicePicker>div>div>.service-list>div.item").Click(function(e,t){d(t)}),P.Click(function(e,t){P.ClassHave("disabled")||(s=B.serviceId,$("#content>div:nth-of-type(3)>div:nth-of-type(1)>span").Text(B.serviceName),$("#content>div:nth-of-type(3)>div:nth-of-type(2)>span").Text(B.servicePrice),"paid_full"===C&&(L=B.servicePrice1||F,$("#content>div:nth-of-type(6)>div:nth-of-type(1)>span").Text("￥"+L+"元"),j.Text("支付金额可在结账时抵扣 "+B.serviceName+" 的消费")),S.ClassClear("active"),s?$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Hide():$("#content>div:nth-of-type(4)>div:nth-of-type(3),#content>div:nth-of-type(4)>div:nth-of-type(4)").Show())})}function d(e,t){var a=e.dataset,i=$(e);"paid_full"===C&&i.ClassHave("active")||(i.ClassHave("active")&&!t?(i.ClassClear("active"),D.Text("未选择项目"),P.ClassClear("disabled"),B={serviceName:"到店选择",servicePrice:"待定"}):($("#_servicePicker>div>div>.service-list>div.active").ClassClear("active"),i.Class("active"),D.Text(a.serviceName),P.ClassClear("disabled"),B=a))}var o=$.param("techId"),s=$.param("itemId"),c=$.param("code")||$.getUrlParam("code")||$.$.payAuthCode,l=$.param("clubId")||$.getUrlParam("clubId")||$.$.clubID,p=$.param("orderId")||$.getUrlParam("orderId"),v=$.param("downPayment")||$.getUrlParam("downPayment"),u=$.param("customerName")||$.getUrlParam("customerName")||"",f=$.localStorage("con-order-param")?JSON.parse($.localStorage("con-order-param")):null,h=!1;if($.$.payAuthCode=c,f&&c&&$.ajax({url:($.$.clubID?"../":"")+"../wx/oauth2/user/openid",type:"post",data:{code:$.$.payAuthCode,scope:"snsapi_base",wxmp:"9358",userType:"user",state:"confirm-order"},success:function(t){if(200==t.statusCode)e();else{if("935801"!=t.statusCode)return $.tipShow(t.msg||"获取openId失败！"),$.pageCancel();$.getOauthCode("","9358","confirm-order","base")}}}),!o&&!s||!l)return $.pageCancel(),$.tipShow("地址栏参数不正确！");$.$.userToken||($.tipShow("请您先登录！"),$.$.loginUrl="paidCoupon"+location.hash.split("paidCoupon")[1],$.page("login"));var m,y,C,g=$(".day-list>div"),b=$(".time-list"),x=($(".time-list>div"),$(".selected-time>span")),T=$("#_timePicker .confirm-button"),I=$("#_timePicker"),S=$("#_servicePicker"),k=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span"),w=$("#content>div:nth-of-type(4)>div:nth-of-type(4)>span"),D=$("#_servicePicker>div>div>.selected-service>span"),P=$("#_servicePicker .confirm-button"),H=$("#payMask"),N=[45,60,90,120],U="",A=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],_=["今天","明天","后天"],M=[],E=[],F=0,L=0,O=0,j=$("#content>div:nth-of-type(6)>div:nth-of-type(2)"),J="";"true"==$.param("backPublic")&&$("#title>div:nth-of-type(2)").Click(function(e){e.stopImmediatePropagation(),history.back()}),e(),$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)").Event("click",function(e,t){var a=$(t);if(!a.ClassHave("cancel")){U=a.Attr("data-time");var i=a.Attr("data-index")-1;i=i<0?0:i,g.Index(i)[0].click(),I.Class("active")}}),k.Event("click",function(e,t){var a=$(t);a.ClassHave("cancel")||a.ClassHave("disabled")||(k.ClassClear("active"),a.Class("active"))}),g.Event("click",function(e,t){var i=$(t);i.ClassHave("active")&&!U||(g.ClassClear("active"),i.Class("active"),$(".time-list>div").ClassClear("active"),x.Text("--:--"),T.Class("disabled"),a(i.Attr("data-index")-1,U),U="")}),$(".time-list").Delegate("click",">div",function(e,t){var a=$(t);if(!a.ClassHave("disabled")){$(".time-list>div").ClassClear("active"),a.Class("active");var i=M[$(".day-list>div.active").Attr("data-index")-1];x.Text(i.month+"月"+i.day+"日 "+A[i.week]+" "+a.Children().Index(0).Text()),T.ClassClear("disabled")}}),T.Event("click",function(e,t){if(!$(t).ClassHave("disabled")){var a=$("#content>div:nth-of-type(4)>div:nth-of-type(2)>span:nth-of-type(2)"),i=$(".day-list>div.active"),n=$(".time-list>div.active");a.Text(x.Text()),a.Attr("data-index",i.Attr("data-index")),a.Attr("data-time",i.Children().Index(0).Text()),a.ClassClear("cancel"),I.ClassClear("active"),k.ClassClear("cancel"),$("#footer>div").Class("active"),J=n[0].dataset.timeId||"";var r=48*(i.Attr("data-index")-1)+(n.Attr("ix")-0);s||(w.ClassClear("cancel"),w.ClassClear("disabled"),N.every(function(e,t){var a=Math.ceil(e/30),i=E.slice(r+1,r+a),n=i.every(function(e){return"N"!==e.status});if(!n){for(var d=t,o=w.length;d<o;d++)w.Index(d).Class("disabled"),1==d?w.Index(0)[0].click():w.Index(1)[0].click();return!1}return!0}))}}),$("#_timePicker>div>div>div:nth-of-type(1)>span").Event("click",function(){I.ClassClear("active")});var B}();