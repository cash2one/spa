!function(){function e(e){var t=e.parentNode.getAttribute("chatId"),a=V[t],s=a.techId;s?$.page("chat&techId="+(a.techId||"")+($.$.clubID?"":"&clubId="+a.clubId)):($.$.easemob.currChatTech={chatId:t,name:a.name,header:a.header,avatar:a.avatar,clubId:a.clubId,clubName:"",techId:"",inviteCode:"",no:"",appointment:"n",phoneAppointment:"n",telephone:"",chatName:"",chatHeader:""},$.page("chat&techId="+(a.techId||"")+($.$.clubID?"":"&clubId="+a.clubId)))}function t(e){return e.replace(h,function(){return j[arguments[0]]||arguments[0]})}function a(e){var t,a=$.$.easemob;Z.forEach(function(s){t=s.id,$.getMsgList(t),a.sessionList[t]&&(e?delete a.sessionList[t]:(a.sessionList[t].msg.data="",a.sessionList[t].msg["new"]=0,a.sessionList[t]["new"]=0),$.localStorage($.$.userID+"_SessionList",JSON.stringify(a.sessionList))),a.msgList[t]&&(e?delete a.msgList[t]:a.msgList[t].list=[],$.localStorageClear($.$.userID+"_MsgList_"+t)),$('[chatid="'+t+'"]>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(1)').Html(""),$('[chatid="'+t+'"]>div:nth-of-type(2)>div:nth-of-type(2)>div:nth-of-type(2)').Hide(),e&&u.removeChild($('[chatid="'+t+'"]')[0])}),e&&(J.style.display="block"),f.Text(0),f.CSS({visibility:"hidden"}),C.Text(0),C.CSS({visibility:"hidden"}),$.showOrderMenu(),b.ClassClear("active"),p.Hide()}function s(e,t){e.parentNode.parentNode.classList.add("show-contacts"),I.ClassClear("active"),e.classList.add("active"),y.Class("show-contacts"),t&&(y.Class("no-duration"),setTimeout(function(){y.ClassClear("no-duration")},500))}function i(e,t){S||(S=!0,L=e||L+1,w.ClassClear("none"),N.Class("none"),H=!1,$.ajax({url:"../api/v1/emchat/friendlist/"+$.$.easemob.userId,isReplaceUrl:!0,data:{channel:"center",page:L,pageSize:E},success:function(e){if("200"!=e.statusCode)return $.tipShow(e.msg||"数据请求失败！");e=e.respData,T="";var a,s,i,n,d="";for(r=0,v=e.length;r<v;r++)if(!$.$.clubID||e[r].clubId&&e[r].clubId==$.$.clubID){$.$.clubID||d==e[r].clubId||(d=e[r].clubId,T+='<div class="item-header" id="club_'+d+'">'+e[r].clubName+"</div>");var c=W[d]||0;c++,W[d]=c,a=new Date,s=e[r].chatDate.split(" "),i=s[1].split(":"),s=s[0].split("-"),a.setFullYear(s[0]-0,s[1]-1,s[2]-0),a.setHours(i[0]-0,i[1]-0,i[2]-0),g=V[e[r].friendChatId],n=e[r].friendDescription||"",z="manager"==e[r].toType,T+="<div class='contact-item' data-chat-Id='"+e[r].friendChatId+"' data-target-Id='"+e[r].friendUserId+"'  data-club-Id='"+(e[r].clubId||"")+"'  data-friend-Name='"+(e[r].friendName||"")+"' data-to-type='"+e[r].toType+"' data-header='"+e[r].friendAvatarUrl+"'>                                <div style='background-image: "+(e[r].friendAvatarUrl?"url("+e[r].friendAvatarUrl+"),":"")+"url("+(z?O:F)+")'></div>                                <div>                                    <div>                                        <div>                                            <div>"+e[r].friendName+"</div>                                            <div class='"+(z?"manager":e[r].techNo&&e[r].techNo.length>0?"tech":"none")+"'>"+(z?"店长":e[r].techNo)+"</div>                                        </div>                                        <div><div>"+n+"</div><div style='display:none;'>"+$.formatMsgTime(a)+"</div></div>                                    </div>                                    <div class='contact-remove'>&times</div>                                </div>                            </div>"}1==L?(D.Html(T),T?(P.style.display="none",v<E&&(H=!0,N.ClassClear("none"))):(P.style.display="block",H=!0),U=D[0].scrollHeight):(D.Html(T,!0),v<E&&(H=!0,N.ClassClear("none"))),S=!1,w.Class("none"),t&&t()}}))}function n(e){$.sessionStorage("msg_contacts_data",D.Html()),$.sessionStorage("msg_contacts_page",L),$.sessionStorage("msg_contacts_page_height",U),$.sessionStorage("msg_contacts_end",H),$.sessionStorage("msg_contacts_top",k[0].scrollTop);var t=e.dataset,a=t.chatId,s=t.targetId,i=t.clubId,n=t.toType;if("tech"==n)$.page("chat&techId="+s+"&clubId="+i);else if("manager"==n){var d=$.getSessionList(!1,!0)[a]||{name:e.parentNode.getAttribute("data-friend-name"),header:t.header||$.$.defaultClubLogo,avatar:"",clubId:i};$.$.easemob.currChatTech={chatId:a,name:d.name,header:d.header,avatar:d.avatar,clubId:d.clubId,clubName:"",techId:"",inviteCode:"",no:"",appointment:"n",phoneAppointment:"n",telephone:"",chatName:"",chatHeader:""},$.page("chat&techId="+(d.techId||"")+($.$.clubID?"":"&clubId="+d.clubId))}}function d(e,t){e.preventDefault();var a=$(t),s=a.Attr("data-chat-id"),i=a[0].dataset.clubId,n=$("#content .contacts-area>div.list")[0];$.ajax({url:"../api/v1/emchat/friend",isReplaceUrl:!0,type:"post",data:{channel:"center",currentChatId:$.$.easemob.userId,showFlag:"n",friendChatId:s},success:function(e){if("200"!=e.statusCode)return $.tipShow(e.msg||"请求失败！");n.removeChild(a[0]);var t=W[i]||0;t--,t<=0?(delete W[i],$("#club_"+i).length>0&&n.removeChild($("#club_"+i)[0])):W[i]=t,0==$(n).Children().length&&(P.style.display="block",N.Class("none"),l(_[0]))}})}function c(){k.Event("scroll",function(e){y.ClassHave("show-contacts")&&!H&&k[0].scrollTop+k[0].clientHeight-(L+R-1)*U>=0&&i()}),$("#content").Delegate("click",".contact-item",function(e,t){$(t.parentNode).ClassHave("del-contacts-state")?d(e,t):n(t)}),_.Event("click",function(e,t){l(t)})}function l(e){var t=$(e);t.ClassHave("del-contacts")?($(".delete-msg").Class("active"),t.ClassClear("del-contacts"),t.Class("complete-title"),t.Text("完成"),D.Class("del-contacts-state")):(t.ClassClear("complete-title"),t.Class("del-contacts"),$(".delete-msg").ClassClear("active"),t.Text("删除"),D.ClassClear("del-contacts-state"))}var o,r,v,h,g,m="",u=$("#content .msg-area>div.list")[0],p=$("#title>div:nth-of-type(1)>div:nth-of-type(2)"),f=$("#_clubMenu>div:nth-of-type(2)>div:nth-of-type(1)>i",!0),C=$("#_publicMenu>div:nth-of-type(2)>div:nth-of-type(1)>i",!0),b=$("#confirmDelMsg"),I=$("#title>div:nth-of-type(1)>div:nth-of-type(1)>div"),y=$("#content>div"),_=$("#title>div:nth-of-type(1)>div:nth-of-type(3)"),T="",S=!1,L=1,w=$("#loadTip"),N=$("#finishTip"),H="true"==($.sessionStorage("msg_contacts_end")||"false"),D=$("#content .contacts-area>div.list"),k=$("#content .contacts-area"),M=$.sessionStorage("msg_contacts_top"),A=$.sessionStorage("msg_contacts_page"),x=$.sessionStorage("msg_contacts_data"),U=$.sessionStorage("msg_contacts_page_height")||0,E=10,R=.4,O="./img/chat/defaultClubLogo.png",F="./img/chat/defaultUserLogo.png",j={"/::O":"/大笑","/::Y":"/坏笑","/::B":"/害羞","/::A":"/色","/::C":"/晕","/::D":"/红心","/::X":"/心碎了","/::Z":"/握手","/::F":"/抱拳","/::E":"/花","/::T":"/花谢了","/::P":"/示爱","/::G":"/亲亲","/::H":"/大哭","/::I":"/可怜","/::J":"/生气","/::K":"/微笑","/::L":"/冷汗","/::M":"/困","/::N":"/调皮","/::Q":"/敲打","/::R":"/疑问","/::S":"/猪头","/::U":"/汽水","/::V":"/西瓜","/::W":"/鼓掌","/::a":"/大拇指","/::b":"/剪刀手"},B={plumFlower:{title:"一元夺",subTitle:"我和你只有一块钱的距离"},oneYuan:{title:"一元夺",subTitle:"我和你只有一块钱的距离"},timeLimit:{title:"限时抢",subTitle:"春宵一刻值千金"},luckyWheel:{title:"大转盘",subTitle:"那一世转山转水，只为相见"},journal:{title:"会所期刊",subTitle:"有美女、有福利，你就是我的VIP！"}};h=new RegExp("/::[A-Zab]+","g");var r,Y,J=$("#content .msg-area>div.nullData")[0],P=$("#content .contacts-area>div.nullData")[0],V=$.getSessionList(!1,!0),W={},Z=[];for(Y in V)V[Y].clubId!=$.$.clubID&&$.$.clubID||Z.push({id:Y,time:V[Y].time});Z.sort(function(e,t){return e.time>t.time?-1:1});var q=0,z=!1;for(r=0;r<Z.length;r++)o=V[Z[r].id],o.name&&(z=!o.techId,m+='<div type="'+(z?"manager":"tech")+'" class="msg-item list_'+Z[r].id+'" chatId="'+Z[r].id+'" data-msg-num="'+o["new"]+'">                        <div style="background-image:'+(o.header?"url("+o.header+"),":"")+"url("+(z?O:F)+')"></div>                        <div>                            <div>                                <div>                                    <div>'+o.name+'</div>                                    <div class="'+(z?"manager":o.no&&o.no.length>0?"tech":"none")+'">'+(z?"店长":o.no)+"</div>                                </div>                                <div>"+$.formatMsgTime(o.time)+"</div>                            </div>                            <div>                                <div>"+(B[o.msg.msgType]?B[o.msg.msgType].subTitle:t(o.msg.data.replace(/<br>|<br\/>/g,"")))+"</div>                                <div "+(0==o["new"]?"style='display:none;'":"")+">"+o["new"]+"</div>                            </div>                        </div>                    </div>",q+=o["new"]);u.innerHTML=m,0==m.length&&(J.style.display="block",p.Hide()),q>0&&(f.Text(q),f.CSS({visibility:"hidden"}),C.Text(q),C.CSS({visibility:"hidden"})),$.refreshMessageList=function(e){var a,s=u.querySelector("div.list_"+e),i=V[e];if(s){s.children[1].children[1].children[0].innerHTML=B[i.msg.msgType]?B[i.msg.msgType].subTitle:t(i.msg.data.replace(/<br>|<br\/>/g,"")),s.children[1].children[0].children[1].innerHTML=$.formatMsgTime(i.time),a=s.children[1].children[1].children[1],a.className="",a.style.display="block",a.innerHTML=i["new"],s.dataset.msgNum=i["new"];var n=u.children[0];n!=s&&u.insertBefore(s,n)}else"block"==J.style.display&&(J.style.display="none"),s=document.createElement("div"),s.className="msg-item list_"+e,s.setAttribute("chatId",e),s.dataset.msgNum=i["new"],z=!i.techId,s.innerHTML='<div style="background-image: '+(i.header?"url("+i.header+"),":"")+"url("+(z?O:F)+')"></div>                                <div>                                    <div>                                        <div>                                            <div>'+i.name+'</div>                                            <div class="'+(z?"manager":i.no&&i.no.length>0?"tech":"none")+'">'+(z?"店长":i.no)+"</div>                                        </div>                                        <div>"+$.formatMsgTime(i.time)+"</div>                                    </div>                                    <div>                                        <div>"+(B[i.msg.msgType]?B[i.msg.msgType].subTitle:t(i.msg.data.replace(/<br>|<br\/>/g,"")))+"</div>                                        <div "+(0==i["new"]?"style='display:none;'":"")+">"+i["new"]+"</div>                                    </div>                                </div>",0==u.children.length?u.appendChild(s):u.insertBefore(s,u.children[0]),Z.push({id:e});p.Show()},$("#_orderTech>div.message",!0).ClassClear("new"),$.pageSwitch(!0,!0),$("#content .msg-area>div.list").Delegate("click",">div>div:nth-of-type(1),>div>div:nth-of-type(2)",function(t,a){e(a)}),p.Event("click",function(e,t){$.hideOrderMenu(),b.Class("active")}),$("#conListAndRecords").Click(function(){a(!0)}),$("#conRecords").Click(function(){a(!1)}),$("#conCancel").Click(function(){$.showOrderMenu(),b.ClassClear("active")}),I.Index(0).Click(function(e,t){t.parentNode.parentNode.classList.remove("show-contacts"),I.ClassClear("active"),t.classList.add("active"),y.ClassClear("show-contacts"),_.ClassHave("complete-title")&&l(_[0])}),I.Index(1).Click(function(e,t){s(t)}),x?(s(I[1],!0),L=parseInt(A),D.Html(x),setTimeout(function(){k[0].scrollTop=M},1),c(),H&&N.ClassClear("none"),$.pageSwitch()):(i(1),c()),$.sessionStorageClear("msg_contacts_data"),$.sessionStorageClear("msg_contacts_end"),$.sessionStorageClear("msg_contacts_top"),$.sessionStorageClear("msg_contacts_page"),$.sessionStorageClear("msg_contacts_page_height")}();